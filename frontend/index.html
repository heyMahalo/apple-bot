<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Bot System - 产品分类管理</title>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus CDN -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus"></script>
    <!-- Element Plus Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <!-- Socket.IO CDN -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Axios CDN -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Day.js CDN -->
    <script src="https://unpkg.com/dayjs"></script>
</head>
<body>
    <div id="app">
        <el-container style="height: 100vh;">
            <!-- 顶部导航栏 -->
            <el-header class="header">
                <div class="header-left">
                    <h2>Apple Bot System</h2>
                </div>
                <div class="header-right">
                    <div class="status-indicators">
                        <el-badge :value="pendingTasks.length" type="info" :hidden="pendingTasks.length === 0">
                            <el-button size="small" disabled>
                                ⏳ 等待
                            </el-button>
                        </el-badge>

                        <el-badge :value="runningTasks.length" type="warning" :hidden="runningTasks.length === 0">
                            <el-button size="small" disabled>
                                🏃 运行
                            </el-button>
                        </el-badge>

                        <el-badge :value="systemStatus.active_tasks" type="primary" class="status-badge">
                            <el-button
                                :type="isConnected ? 'success' : 'danger'"
                                size="small"
                                circle
                            >
                                {{ isConnected ? '✓' : '✗' }}
                            </el-button>
                        </el-badge>
                    </div>

                    <el-button
                        type="success"
                        @click="startAllTasks"
                        :disabled="!hasExecutableTasks"
                        :loading="startingAllTasks"
                    >
                        🚀 一键执行所有任务
                    </el-button>

                    <el-button
                        type="info"
                        @click="refreshTasks"
                        size="small"
                    >
                        🔄 刷新
                    </el-button>

                    <el-dropdown @command="handleCommand">
                        <el-button type="primary">
                            系统管理
                        </el-button>
                        <template #dropdown>
                            <el-dropdown-menu>
                                <el-dropdown-item command="status">系统状态</el-dropdown-item>
                                <el-dropdown-item command="logs">运行日志</el-dropdown-item>
                                <el-dropdown-item command="settings">系统设置</el-dropdown-item>
                                <el-dropdown-item command="stop-all" divided>停止所有任务</el-dropdown-item>
                            </el-dropdown-menu>
                        </template>
                    </el-dropdown>
                </div>
            </el-header>

            <el-container>
                <!-- 侧边栏 - 产品分类导航 -->
                <el-aside width="220px" class="sidebar">
                    <el-menu
                        :default-active="currentProduct"
                        class="menu"
                        @select="switchProduct"
                        :collapse="false"
                    >
                        <el-menu-item index="iphone">
                            <span>📱 iPhone</span>
                        </el-menu-item>
                        <el-menu-item index="mac">
                            <span>💻 Mac</span>
                        </el-menu-item>
                        <el-menu-item index="ipad">
                            <span>📱 iPad</span>
                        </el-menu-item>
                        <el-menu-item index="watch">
                            <span>⌚ Apple Watch</span>
                        </el-menu-item>
                        <el-divider style="margin: 10px 0;"></el-divider>
                        <el-menu-item index="all-tasks">
                            <span>📋 所有任务</span>
                        </el-menu-item>
                        <el-divider style="margin: 10px 0;"></el-divider>
                        <el-menu-item index="accounts">
                            <span>👤 账号管理</span>
                        </el-menu-item>
                        <el-menu-item index="gift-cards">
                            <span>🎁 礼品卡管理</span>
                        </el-menu-item>
                        <el-menu-item index="ip-pool">
                            <span>🌐 IP池管理</span>
                        </el-menu-item>
                    </el-menu>
                </el-aside>

                <!-- 主内容区 -->
                <el-main class="main-content">
                    <!-- iPhone 产品页面 -->
                    <div v-if="currentProduct === 'iphone'" class="product-section">
                        <div class="section-header">
                            <h2>📱 iPhone 自动化任务</h2>
                            <div class="header-actions">
                                <el-button
                                    type="success"
                                    @click="startIphoneTasks"
                                    :disabled="!hasIphonePendingTasks"
                                    size="small"
                                >
                                    🚀 启动所有iPhone任务
                                </el-button>
                                <el-button
                                    type="primary"
                                    @click="openCreateDialog('iphone')"
                                >
                                    创建 iPhone 任务
                                </el-button>
                            </div>
                        </div>

                        <div class="tasks-grid">
                            <el-card
                                v-for="task in getTasksByProduct('iphone')"
                                :key="task.id"
                                class="task-card"
                                shadow="hover"
                            >
                                <template #header>
                                    <div class="card-header">
                                        <span class="task-name">{{ task.config.name }}</span>
                                        <el-tag :type="getStatusType(task.status)" size="small">
                                            {{ getStatusText(task.status) }}
                                        </el-tag>
                                    </div>
                                </template>

                                <div class="task-details">
                                    <p><strong>Apple ID:</strong> {{ task.config.account_config?.email || 'N/A' }}</p>
                                    <p><strong>型号:</strong> {{ task.config.product_config?.model || 'N/A' }}</p>
                                    <p><strong>存储:</strong> {{ task.config.product_config?.storage || 'N/A' }}</p>
                                    <p><strong>颜色:</strong> {{ task.config.product_config?.finish || 'N/A' }}</p>

                                    <!-- 当前步骤显示 -->
                                    <div v-if="task.status === 'running' && task.current_step" class="current-step">
                                        <p><strong>当前步骤:</strong>
                                            <el-tag type="primary" size="small">
                                                {{ formatStepName(task.current_step) }}
                                            </el-tag>
                                        </p>
                                    </div>

                                    <!-- 实时进度条 -->
                                    <el-progress
                                        :percentage="Math.round(task.progress || 0)"
                                        :status="task.status === 'completed' ? 'success' :
                                                task.status === 'failed' ? 'exception' : ''"
                                        :stroke-width="8"
                                        style="margin: 10px 0;"
                                        :show-text="true"
                                        :format="(percentage) => `${percentage}% ${task.status === 'running' ? '执行中...' : ''}`"
                                    ></el-progress>

                                    <!-- 余额不足错误显示 -->
                                    <div v-if="task.balance_error" class="balance-error">
                                        <div class="error-header">
                                            <el-icon color="#f56c6c"><WalletFilled /></el-icon>
                                            <span>余额不足</span>
                                        </div>
                                        <div class="error-content">
                                            <div class="error-amount">还需支付: <strong>{{ task.balance_error.remaining_amount }}</strong></div>
                                            <div class="error-message">{{ task.balance_error.message }}</div>
                                        </div>
                                    </div>

                                    <!-- 礼品卡错误信息显示 -->
                                    <div v-if="task.gift_card_errors && task.gift_card_errors.length > 0" class="gift-card-errors">
                                        <div class="error-header">
                                            <el-icon color="#f56c6c"><WarningFilled /></el-icon>
                                            <span>礼品卡状态异常</span>
                                        </div>
                                        <div class="error-list">
                                            <div 
                                                v-for="error in task.gift_card_errors" 
                                                :key="error.card_number"
                                                class="error-item"
                                            >
                                                <el-tag type="danger" size="small">
                                                    {{ error.card_number }}
                                                </el-tag>
                                                <span class="error-message">{{ error.message }}</span>
                                                <el-tag :type="getGiftCardErrorType(error.status)" size="small">
                                                    {{ error.status }}
                                                </el-tag>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 最新日志显示 -->
                                    <div v-if="task.logs && task.logs.length > 0" class="latest-log">
                                        <p class="log-text">
                                            <el-icon><InfoFilled /></el-icon>
                                            {{ getLatestLog(task) }}
                                        </p>
                                    </div>
                                </div>

                                <div class="task-actions">
                                    <el-button
                                        v-if="task.status === 'pending'"
                                        type="primary"
                                        size="small"
                                        @click="startTask(task.id)"
                                    >
                                        启动
                                    </el-button>
                                    <el-button
                                        v-if="task.status === 'running'"
                                        type="warning"
                                        size="small"
                                        @click="cancelTask(task.id)"
                                    >
                                        暂停
                                    </el-button>
                                    <el-button
                                        v-if="['completed', 'failed', 'cancelled'].includes(task.status)"
                                        type="success"
                                        size="small"
                                        @click="rerunTask(task)"
                                        :loading="task.rerunning"
                                    >
                                        重新运行
                                    </el-button>
                                    <el-button
                                        size="small"
                                        @click="viewTaskDetail(task)"
                                    >
                                        详情
                                    </el-button>
                                    <el-button
                                        type="danger"
                                        size="small"
                                        @click="deleteTask(task.id)"
                                    >
                                        删除
                                    </el-button>
                                </div>
                            </el-card>

                            <!-- 空状态 -->
                            <el-empty
                                v-if="getTasksByProduct('iphone').length === 0"
                                description="暂无 iPhone 任务"
                                :image-size="100"
                            >
                                <el-button type="primary" @click="openCreateDialog('iphone')">
                                    创建第一个 iPhone 任务
                                </el-button>
                            </el-empty>
                        </div>
                    </div>

                    <!-- Mac 产品页面 -->
                    <div v-if="currentProduct === 'mac'" class="product-section">
                        <div class="section-header">
                            <h2>💻 Mac 自动化任务</h2>
                            <el-button
                                type="primary"
                                @click="openCreateDialog('mac')"
                            >
                                创建 Mac 任务
                            </el-button>
                        </div>

                        <el-alert
                            title="Mac 产品支持即将上线"
                            type="info"
                            description="Mac 产品的自动化购买功能正在开发中，敬请期待！"
                            show-icon
                            :closable="false"
                        ></el-alert>
                    </div>

                    <!-- iPad 产品页面 -->
                    <div v-if="currentProduct === 'ipad'" class="product-section">
                        <div class="section-header">
                            <h2>📱 iPad 自动化任务</h2>
                            <el-button
                                type="primary"
                                @click="openCreateDialog('ipad')"
                            >
                                创建 iPad 任务
                            </el-button>
                        </div>

                        <el-alert
                            title="iPad 产品支持即将上线"
                            type="info"
                            description="iPad 产品的自动化购买功能正在开发中，敬请期待！"
                            show-icon
                            :closable="false"
                        ></el-alert>
                    </div>

                    <!-- Apple Watch 产品页面 -->
                    <div v-if="currentProduct === 'watch'" class="product-section">
                        <div class="section-header">
                            <h2>⌚ Apple Watch 自动化任务</h2>
                            <el-button
                                type="primary"
                                @click="openCreateDialog('watch')"
                            >
                                创建 Watch 任务
                            </el-button>
                        </div>

                        <el-alert
                            title="Apple Watch 产品支持即将上线"
                            type="info"
                            description="Apple Watch 产品的自动化购买功能正在开发中，敬请期待！"
                            show-icon
                            :closable="false"
                        ></el-alert>
                    </div>

                    <!-- 所有任务视图 -->
                    <div v-if="currentProduct === 'all-tasks'" class="product-section">
                        <div class="section-header">
                            <h2>📋 所有任务总览</h2>
                            <div class="header-stats">
                                <el-statistic title="总任务数" :value="tasks.length"></el-statistic>
                                <el-statistic title="运行中" :value="getTasksByStatus('running').length"></el-statistic>
                                <el-statistic title="已完成" :value="getTasksByStatus('completed').length"></el-statistic>
                            </div>
                        </div>

                        <el-table :data="tasks" style="width: 100%" stripe>
                            <el-table-column prop="config.name" label="任务名称" min-width="200"></el-table-column>
                            <el-table-column label="Apple ID" width="200">
                                <template #default="scope">
                                    <span style="color: #606266;">{{ scope.row.config.account_config?.email || 'N/A' }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column label="产品类型" width="120">
                                <template #default="scope">
                                    <el-tag>{{ getProductType(scope.row) }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="状态" width="120">
                                <template #default="scope">
                                    <el-tag :type="getStatusType(scope.row.status)">
                                        {{ getStatusText(scope.row.status) }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="进度" width="250">
                                <template #default="scope">
                                    <div class="progress-cell">
                                        <el-progress
                                            :percentage="Math.round(scope.row.progress || 0)"
                                            :status="scope.row.status === 'completed' ? 'success' :
                                                    scope.row.status === 'failed' ? 'exception' : ''"
                                            :stroke-width="8"
                                            :show-text="true"
                                        ></el-progress>
                                        <div v-if="scope.row.status === 'running' && scope.row.current_step" class="current-step-mini">
                                            <el-tag type="primary" size="small" style="margin-top: 4px;">
                                                {{ formatStepName(scope.row.current_step) }}
                                            </el-tag>
                                        </div>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column label="创建时间" width="180">
                                <template #default="scope">
                                    {{ formatTime(scope.row.created_at) }}
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="250" fixed="right">
                                <template #default="scope">
                                    <el-button-group size="small">
                                        <el-button
                                            v-if="scope.row.status === 'pending'"
                                            type="primary"
                                            @click="startTask(scope.row.id)"
                                        >
                                            启动
                                        </el-button>
                                        <el-button
                                            v-if="scope.row.status === 'running'"
                                            type="warning"
                                            @click="cancelTask(scope.row.id)"
                                        >
                                            暂停
                                        </el-button>
                                        <el-button
                                            @click="viewTaskDetail(scope.row)"
                                        >
                                            详情
                                        </el-button>
                                        <el-button
                                            type="danger"
                                            @click="deleteTask(scope.row.id)"
                                        >
                                            删除
                                        </el-button>
                                    </el-button-group>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>

                    <!-- 账号管理页面 -->
                    <div v-if="currentProduct === 'accounts'" class="product-section">
                        <div class="section-header">
                            <h2>👤 账号管理</h2>
                            <div class="header-actions">
                                <el-button
                                    type="primary"
                                    @click="showCreateAccountDialog = true"
                                >
                                    添加账号
                                </el-button>
                            </div>
                        </div>

                        <el-table :data="accounts" style="width: 100%" stripe>
                            <el-table-column prop="email" label="邮箱" min-width="200"></el-table-column>
                            <el-table-column prop="phone_number" label="电话号码" width="180">
                                <template #default="scope">
                                    {{ scope.row.phone_number || '07700900000' }}
                                </template>
                            </el-table-column>
                            <el-table-column label="创建时间" width="180">
                                <template #default="scope">
                                    {{ formatTime(scope.row.created_at) }}
                                </template>
                            </el-table-column>
                            <el-table-column label="状态" width="100">
                                <template #default="scope">
                                    <el-tag :type="scope.row.is_active ? 'success' : 'danger'">
                                        {{ scope.row.is_active ? '活跃' : '禁用' }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="200" fixed="right">
                                <template #default="scope">
                                    <el-button-group size="small">
                                        <el-button
                                            @click="editAccount(scope.row)"
                                        >
                                            编辑
                                        </el-button>
                                        <el-button
                                            type="danger"
                                            @click="deleteAccount(scope.row.id)"
                                        >
                                            删除
                                        </el-button>
                                    </el-button-group>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>

                    <!-- 礼品卡管理页面 -->
                    <div v-if="currentProduct === 'gift-cards'" class="product-section">
                        <div class="section-header">
                            <h2>🎁 礼品卡管理</h2>
                            <div class="header-actions">
                                <el-select
                                    v-model="giftCardStatusFilter"
                                    placeholder="筛选状态"
                                    clearable
                                    @change="loadGiftCards"
                                    style="width: 150px; margin-right: 10px;"
                                >
                                    <el-option
                                        v-for="status in giftCardStatuses"
                                        :key="status"
                                        :label="status"
                                        :value="status"
                                    ></el-option>
                                </el-select>
                                <el-button
                                    type="primary"
                                    @click="showCreateGiftCardDialog = true"
                                >
                                    添加礼品卡
                                </el-button>
                            </div>
                        </div>

                        <el-table :data="giftCards" style="width: 100%" stripe>
                            <el-table-column prop="gift_card_number" label="礼品卡号" min-width="200"></el-table-column>
                            <el-table-column label="状态" width="120">
                                <template #default="scope">
                                    <el-tag :type="getGiftCardStatusType(scope.row.status)">
                                        {{ scope.row.status }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="notes" label="备注" min-width="150"></el-table-column>
                            <el-table-column label="创建时间" width="180">
                                <template #default="scope">
                                    {{ formatTime(scope.row.created_at) }}
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="200" fixed="right">
                                <template #default="scope">
                                    <el-button-group size="small">
                                        <el-button
                                            @click="editGiftCard(scope.row)"
                                        >
                                            编辑
                                        </el-button>
                                        <el-button
                                            type="danger"
                                            @click="deleteGiftCard(scope.row.id)"
                                        >
                                            删除
                                        </el-button>
                                    </el-button-group>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>

                    <!-- IP池管理页面 -->
                    <div v-if="currentProduct === 'ip-pool'" class="product-section">
                        <div class="section-header">
                            <h2>🌐 IP池管理</h2>
                            <div class="header-actions">
                                <el-badge :value="ipStatus.proxy_pool?.available || 0" type="success">
                                    <el-button size="small" disabled>
                                        可用代理
                                    </el-button>
                                </el-badge>
                                <el-badge :value="ipStatus.proxy_pool?.blocked_ips || 0" type="danger">
                                    <el-button size="small" disabled>
                                        被封IP
                                    </el-button>
                                </el-badge>
                                <el-button
                                    type="primary"
                                    @click="showAddProxyDialog = true"
                                    size="small"
                                >
                                    添加代理
                                </el-button>
                                <el-button
                                    type="success"
                                    @click="showProxyApiDialog = true"
                                    size="small"
                                >
                                    配置API
                                </el-button>
                                <el-button
                                    type="warning"
                                    @click="rotateIpManually"
                                    size="small"
                                    :loading="rotatingIp"
                                >
                                    手动轮换
                                </el-button>
                                <el-button
                                    @click="refreshIpStatus"
                                    size="small"
                                    :loading="loadingIpStatus"
                                >
                                    刷新状态
                                </el-button>
                            </div>
                        </div>

                        <!-- IP状态概览 -->
                        <el-row :gutter="20" style="margin-bottom: 20px;">
                            <el-col :span="6">
                                <el-card class="status-card">
                                    <div class="status-item">
                                        <div class="status-icon">🌐</div>
                                        <div class="status-content">
                                            <div class="status-title">当前IP</div>
                                            <div class="status-value">
                                                {{ ipStatus.current_ip?.using_proxy ? 
                                                   `${ipStatus.current_ip.proxy_host}:${ipStatus.current_ip.proxy_port}` : 
                                                   (ipStatus.current_ip?.ip || '未知') }}
                                            </div>
                                            <div class="status-desc">
                                                {{ ipStatus.current_ip?.country || '未知地区' }}
                                            </div>
                                        </div>
                                    </div>
                                </el-card>
                            </el-col>
                            <el-col :span="6">
                                <el-card class="status-card">
                                    <div class="status-item">
                                        <div class="status-icon">📊</div>
                                        <div class="status-content">
                                            <div class="status-title">代理池总数</div>
                                            <div class="status-value">{{ ipStatus.proxy_pool?.total || 0 }}</div>
                                            <div class="status-desc">
                                                可用: {{ ipStatus.proxy_pool?.available || 0 }}
                                            </div>
                                        </div>
                                    </div>
                                </el-card>
                            </el-col>
                            <el-col :span="6">
                                <el-card class="status-card">
                                    <div class="status-item">
                                        <div class="status-icon">🎁</div>
                                        <div class="status-content">
                                            <div class="status-title">礼品卡跟踪</div>
                                            <div class="status-value">{{ ipStatus.proxy_pool?.gift_cards_tracked || 0 }}</div>
                                            <div class="status-desc">张礼品卡</div>
                                        </div>
                                    </div>
                                </el-card>
                            </el-col>
                            <el-col :span="6">
                                <el-card class="status-card">
                                    <div class="status-item">
                                        <div class="status-icon">⚙️</div>
                                        <div class="status-content">
                                            <div class="status-title">轮换状态</div>
                                            <div class="status-value">
                                                {{ ipStatus.rotation_enabled ? '已启用' : '已禁用' }}
                                            </div>
                                            <div class="status-desc">
                                                礼品卡: {{ ipStatus.gift_card_rotation_enabled ? '启用' : '禁用' }}
                                            </div>
                                        </div>
                                    </div>
                                </el-card>
                            </el-col>
                        </el-row>

                        <!-- IP池设置 -->
                        <el-card style="margin-bottom: 20px;">
                            <template #header>
                                <span>IP池设置</span>
                            </template>
                            <el-form :model="ipSettings" label-width="150px" size="small">
                                <el-row :gutter="20">
                                    <el-col :span="12">
                                        <el-form-item label="启用IP轮换">
                                            <el-switch
                                                v-model="ipSettings.rotation_enabled"
                                                @change="updateIpSettings"
                                            ></el-switch>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="礼品卡专用轮换">
                                            <el-switch
                                                v-model="ipSettings.gift_card_rotation_enabled"
                                                @change="updateIpSettings"
                                            ></el-switch>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                                <el-row :gutter="20">
                                    <el-col :span="12">
                                        <el-form-item label="每IP最大礼品卡数">
                                            <el-input-number
                                                v-model="ipSettings.max_gift_card_per_ip"
                                                :min="1"
                                                :max="10"
                                                @change="updateIpSettings"
                                            ></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="轮换间隔(秒)">
                                            <el-input-number
                                                v-model="ipSettings.rotation_interval"
                                                :min="60"
                                                :max="3600"
                                                @change="updateIpSettings"
                                            ></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </el-card>

                        <!-- 代理列表 -->
                        <el-table :data="proxyList" style="width: 100%" stripe>
                            <el-table-column prop="host" label="主机" min-width="150"></el-table-column>
                            <el-table-column prop="port" label="端口" width="80"></el-table-column>
                            <el-table-column prop="country" label="国家" width="100"></el-table-column>
                            <el-table-column label="状态" width="100">
                                <template #default="scope">
                                    <el-tag :type="getProxyStatusType(scope.row.status)">
                                        {{ scope.row.status }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="成功率" width="100">
                                <template #default="scope">
                                    <el-progress
                                        :percentage="Math.round(scope.row.success_rate * 100)"
                                        :color="getSuccessRateColor(scope.row.success_rate)"
                                        :show-text="false"
                                        style="width: 60px;"
                                    ></el-progress>
                                    <span style="margin-left: 8px; font-size: 12px;">
                                        {{ Math.round(scope.row.success_rate * 100) }}%
                                    </span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="response_time" label="响应时间(s)" width="120">
                                <template #default="scope">
                                    {{ scope.row.response_time?.toFixed(2) || '-' }}
                                </template>
                            </el-table-column>
                            <el-table-column label="最后使用" width="160">
                                <template #default="scope">
                                    {{ scope.row.last_used ? formatTime(scope.row.last_used) : '未使用' }}
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="200" fixed="right">
                                <template #default="scope">
                                    <el-button-group size="small">
                                        <el-button
                                            type="primary"
                                            @click="testProxy(scope.row)"
                                            :loading="testingProxy === scope.row.host"
                                        >
                                            测试
                                        </el-button>
                                        <el-button
                                            type="warning"
                                            @click="blockProxy(scope.row)"
                                            v-if="scope.row.status !== 'blocked'"
                                        >
                                            封禁
                                        </el-button>
                                        <el-button
                                            type="success"
                                            @click="unblockProxy(scope.row)"
                                            v-else
                                        >
                                            解封
                                        </el-button>
                                        <el-button
                                            type="danger"
                                            @click="removeProxy(scope.row)"
                                        >
                                            删除
                                        </el-button>
                                    </el-button-group>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>
                </el-main>
            </el-container>
        </el-container>

        <!-- 创建任务对话框 -->
        <el-dialog
            v-model="showCreateDialog"
            :title="`创建 ${currentProductType} 任务`"
            width="700px"
            :close-on-click-modal="false"
        >
            <el-form :model="taskForm" label-width="120px" :rules="taskRules" ref="taskFormRef">
                <el-form-item label="任务名称" prop="name">
                    <el-input
                        v-model="taskForm.name"
                        placeholder="请输入任务名称"
                        clearable
                    />
                </el-form-item>

                <el-form-item label="产品URL" prop="url">
                    <el-input
                        v-model="taskForm.url"
                        placeholder="粘贴iPhone URL自动解析配置，或通过下方选择生成"
                        type="textarea"
                        :rows="2"
                        clearable
                        @blur="parseUrlIfNeeded"
                    >
                        <template #append>
                            <el-button @click="parseUrl" type="primary" :loading="parsingUrl">
                                解析
                            </el-button>
                        </template>
                    </el-input>
                    <div class="url-hint" v-if="taskForm.url && !isValidUrl">
                        <el-text type="warning" size="small">
                            ⚠️ URL格式不正确，请检查或使用下方配置选择
                        </el-text>
                    </div>
                </el-form-item>

                <!-- Apple 账号信息 -->
                <el-divider content-position="left">
                    <span style="color: #909399; font-size: 14px;">🍎 Apple 账号信息</span>
                </el-divider>

                <el-form-item label="选择账号" prop="selectedAccount">
                    <el-select
                        v-model="taskForm.selectedAccount"
                        placeholder="请选择Apple ID账号"
                        style="width: 100%"
                        @change="onAccountChange"
                        clearable
                    >
                        <el-option
                            v-for="account in accounts"
                            :key="account.id"
                            :label="account.email"
                            :value="account.id"
                        >
                            <span>{{ account.email }}</span>
                            <span style="float: right; color: #8492a6; font-size: 13px;">
                                {{ formatTime(account.created_at) }}
                            </span>
                        </el-option>
                    </el-select>
                    <div style="margin-top: 8px;">
                        <el-link type="primary" @click="switchProduct('accounts')" style="font-size: 12px;">
                            📝 管理账号
                        </el-link>
                    </div>
                </el-form-item>

                <!-- 产品配置 -->
                <el-divider content-position="left">
                    <span style="color: #909399; font-size: 14px;">📱 产品配置</span>
                </el-divider>

                <!-- iPhone 特定配置 -->
                <template v-if="currentProductType === 'iPhone'">
                    <!-- 调试信息 -->
                    <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        调试: 模型数量 {{ Object.keys(iphoneConfigs.models || {}).length }},
                        数据状态: {{ iphoneConfigs.models ? '已加载' : '未加载' }}
                    </div>

                    <el-form-item label="产品型号" prop="selectedModel">
                        <el-select
                            v-model="taskForm.selectedModel"
                            placeholder="选择iPhone型号"
                            style="width: 100%"
                            @change="onModelChange"
                        >
                            <el-option
                                v-for="(modelData, modelKey) in iphoneConfigs.models"
                                :key="modelKey"
                                :label="modelData.name"
                                :value="modelKey"
                            ></el-option>
                        </el-select>
                    </el-form-item>

                    <el-form-item label="尺寸" prop="selectedSize" v-if="taskForm.selectedModel">
                        <el-select
                            v-model="taskForm.selectedSize"
                            placeholder="选择尺寸"
                            style="width: 100%"
                            @change="onSizeChange"
                        >
                            <el-option
                                v-for="(sizeData, sizeKey) in availableSizes"
                                :key="sizeKey"
                                :label="sizeData.name"
                                :value="sizeKey"
                            ></el-option>
                        </el-select>
                    </el-form-item>

                    <el-form-item label="存储容量" prop="selectedStorage" v-if="taskForm.selectedSize">
                        <el-select
                            v-model="taskForm.selectedStorage"
                            placeholder="选择容量"
                            style="width: 100%"
                            @change="onStorageChange"
                        >
                            <el-option
                                v-for="storage in availableStorages"
                                :key="storage"
                                :label="iphoneConfigs.storage_display_names[storage]"
                                :value="storage"
                            ></el-option>
                        </el-select>
                    </el-form-item>

                    <el-form-item label="颜色" prop="selectedColor" v-if="taskForm.selectedStorage">
                        <el-select
                            v-model="taskForm.selectedColor"
                            placeholder="选择颜色"
                            style="width: 100%"
                            @change="onColorChange"
                        >
                            <el-option
                                v-for="color in availableColors"
                                :key="color"
                                :label="iphoneConfigs.color_display_names[color]"
                                :value="color"
                            ></el-option>
                        </el-select>
                    </el-form-item>

                    <!-- 生成的URL显示 -->
                    <el-form-item label="产品URL" v-if="generatedUrl">
                        <el-input
                            v-model="generatedUrl"
                            readonly
                            type="textarea"
                            :rows="2"
                        >
                            <template #append>
                                <el-button @click="copyUrl" type="primary">复制</el-button>
                            </template>
                        </el-input>
                    </el-form-item>
                </template>

                <!-- 通用配置 -->
                <el-form-item label="优先级">
                    <el-select v-model="taskForm.priority" style="width: 100%">
                        <el-option label="低" :value="1"></el-option>
                        <el-option label="中" :value="2"></el-option>
                        <el-option label="高" :value="3"></el-option>
                    </el-select>
                </el-form-item>

                <el-form-item label="选择礼品卡" prop="selectedGiftCards">
                    <div class="gift-card-selection">
                        <!-- 已选择的礼品卡列表 -->
                        <div v-if="taskForm.selectedGiftCards.length > 0" class="selected-gift-cards" style="margin-bottom: 10px;">
                            <el-tag
                                v-for="(cardId, index) in taskForm.selectedGiftCards" 
                                :key="cardId"
                                type="success"
                                closable
                                @close="removeSelectedGiftCard(index)"
                                size="default"
                                style="margin-right: 8px; margin-bottom: 5px;"
                            >
                                {{ getGiftCardDisplayName(cardId) }}
                            </el-tag>
                        </div>
                        
                        <!-- 添加礼品卡选择器 -->
                        <el-select
                            v-model="tempGiftCardSelection"
                            placeholder="选择要添加的礼品卡（必选）"
                            style="width: 100%;"
                            clearable
                            filterable
                            @change="addGiftCard"
                        >
                            <el-option
                                v-for="card in availableGiftCardsToAdd"
                                :key="card.id"
                                :label="`${card.gift_card_number} (${card.status})`"
                                :value="card.id"
                                :disabled="taskForm.selectedGiftCards.includes(card.id)"
                            >
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>{{ card.gift_card_number }}</span>
                                    <el-tag :type="getGiftCardStatusType(card.status)" size="small">
                                        {{ card.status }}
                                    </el-tag>
                                </div>
                            </el-option>
                        </el-select>
                        
                        <div style="margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <el-text type="danger" size="small">
                                <strong>* 必选项：</strong>至少需要选择一张礼品卡，支持组合使用多张
                            </el-text>
                            <el-link type="primary" @click="switchProduct('gift-cards')" style="font-size: 12px;">
                                🎁 管理礼品卡
                            </el-link>
                        </div>
                    </div>
                </el-form-item>
            </el-form>

            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="closeCreateDialog">取消</el-button>
                    <el-button type="primary" @click="createTask" :loading="creating">
                        创建任务
                    </el-button>
                </div>
            </template>
        </el-dialog>

        <!-- 任务详情对话框 -->
        <el-dialog
            v-model="showDetailDialog"
            title="任务详情"
            width="800px"
        >
            <div v-if="selectedTask">
                <el-descriptions :column="2" border>
                    <el-descriptions-item label="任务名称">{{ selectedTask.config.name }}</el-descriptions-item>
                    <el-descriptions-item label="状态">
                        <el-tag :type="getStatusType(selectedTask.status)">
                            {{ getStatusText(selectedTask.status) }}
                        </el-tag>
                    </el-descriptions-item>
                    <el-descriptions-item label="Apple ID">{{ selectedTask.config.account_config?.email || 'N/A' }}</el-descriptions-item>
                    <el-descriptions-item label="进度">{{ selectedTask.progress }}%</el-descriptions-item>
                    <el-descriptions-item label="创建时间" span="2">{{ formatTime(selectedTask.created_at) }}</el-descriptions-item>
                    <el-descriptions-item label="产品URL" span="2">
                        <el-link :href="selectedTask.config.url" target="_blank">
                            {{ selectedTask.config.url }}
                        </el-link>
                    </el-descriptions-item>
                </el-descriptions>

                <div style="margin-top: 20px;">
                    <h4>运行日志</h4>
                    <div class="log-container">
                        <div
                            v-if="selectedTask.logs && selectedTask.logs.length > 0"
                            class="log-entries"
                        >
                            <div
                                v-for="(log, index) in selectedTask.logs"
                                :key="index"
                                class="log-entry"
                                :class="log.level || 'info'"
                            >
                                <span class="log-time">{{ formatTime(log.timestamp) }}</span>
                                <span class="log-message">{{ log.message }}</span>
                            </div>
                        </div>
                        <div v-else class="no-logs">
                            暂无日志信息
                        </div>
                    </div>
                </div>
            </div>
        </el-dialog>

        <!-- 系统日志对话框 -->
        <el-dialog
            v-model="showSystemLogsDialog"
            title="系统运行日志"
            width="900px"
            :close-on-click-modal="false"
        >
            <div class="system-logs-container">
                <div class="logs-header">
                    <el-button @click="systemLogs = []" type="danger" size="small">
                        清空日志
                    </el-button>
                    <el-text type="info" size="small">
                        显示最近 {{ systemLogs.length }} 条日志
                    </el-text>
                </div>

                <div class="log-container" style="height: 400px;">
                    <div
                        v-if="systemLogs.length > 0"
                        class="log-entries"
                    >
                        <div
                            v-for="(log, index) in systemLogs"
                            :key="index"
                            class="log-entry"
                            :class="log.level"
                        >
                            <span class="log-time">{{ formatTime(log.timestamp) }}</span>
                            <span class="log-message">{{ log.message }}</span>
                        </div>
                    </div>
                    <div v-else class="no-logs">
                        暂无系统日志
                    </div>
                </div>
            </div>
        </el-dialog>

        <!-- 创建账号对话框 -->
        <el-dialog
            v-model="showCreateAccountDialog"
            title="添加账号"
            width="500px"
            :close-on-click-modal="false"
        >
            <el-form :model="accountForm" label-width="100px" :rules="accountRules" ref="accountFormRef">
                <el-form-item label="邮箱" prop="email">
                    <el-input
                        v-model="accountForm.email"
                        placeholder="请输入Apple ID邮箱"
                        clearable
                    />
                </el-form-item>

                <el-form-item label="密码" prop="password">
                    <el-input
                        v-model="accountForm.password"
                        placeholder="请输入密码"
                        type="password"
                        show-password
                        clearable
                    />
                </el-form-item>

                <el-form-item label="电话号码" prop="phone_number">
                    <el-input
                        v-model="accountForm.phone_number"
                        placeholder="请输入英国手机号码 (如: 07700900000)"
                        clearable
                    />
                    <div style="margin-top: 5px; text-align: right;">
                        <el-text size="small" type="info">
                            请输入英国手机号码格式，以07开头的11位数字
                        </el-text>
                    </div>
                </el-form-item>
            </el-form>

            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="closeAccountDialog">取消</el-button>
                    <el-button type="primary" @click="saveAccount" :loading="savingAccount">
                        {{ editingAccount ? '更新' : '创建' }}
                    </el-button>
                </div>
            </template>
        </el-dialog>

        <!-- 创建礼品卡对话框 -->
        <el-dialog
            v-model="showCreateGiftCardDialog"
            title="添加礼品卡"
            width="500px"
            :close-on-click-modal="false"
        >
            <el-form :model="giftCardForm" label-width="100px" :rules="giftCardRules" ref="giftCardFormRef">
                <el-form-item label="礼品卡号" prop="gift_card_number">
                    <el-input
                        v-model="giftCardForm.gift_card_number"
                        placeholder="请输入礼品卡号"
                        clearable
                    />
                </el-form-item>

                <el-form-item label="状态" prop="status">
                    <el-select v-model="giftCardForm.status" style="width: 100%">
                        <el-option
                            v-for="status in giftCardStatuses"
                            :key="status"
                            :label="status"
                            :value="status"
                        ></el-option>
                    </el-select>
                </el-form-item>

                <el-form-item label="备注">
                    <el-input
                        v-model="giftCardForm.notes"
                        placeholder="可选备注信息"
                        type="textarea"
                        :rows="3"
                        clearable
                    />
                </el-form-item>
            </el-form>

            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="closeGiftCardDialog">取消</el-button>
                    <el-button type="primary" @click="saveGiftCard" :loading="savingGiftCard">
                        {{ editingGiftCard ? '更新' : '创建' }}
                    </el-button>
                </div>
            </template>
        </el-dialog>

        <!-- 添加代理对话框 -->
        <el-dialog
            v-model="showAddProxyDialog"
            title="添加代理服务器"
            width="500px"
            :close-on-click-modal="false"
        >
            <el-form :model="proxyForm" label-width="100px" :rules="proxyRules" ref="proxyFormRef">
                <el-form-item label="主机地址" prop="host">
                    <el-input
                        v-model="proxyForm.host"
                        placeholder="请输入代理主机地址"
                        clearable
                    />
                </el-form-item>
                <el-form-item label="端口" prop="port">
                    <el-input-number
                        v-model="proxyForm.port"
                        :min="1"
                        :max="65535"
                        placeholder="端口号"
                        style="width: 100%"
                    />
                </el-form-item>
                <el-form-item label="协议类型" prop="protocol">
                    <el-select v-model="proxyForm.protocol" style="width: 100%">
                        <el-option label="HTTP" value="http"></el-option>
                        <el-option label="HTTPS" value="https"></el-option>
                        <el-option label="SOCKS5" value="socks5"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="国家/地区" prop="country">
                    <el-input
                        v-model="proxyForm.country"
                        placeholder="如：US, UK, CA"
                        clearable
                    />
                </el-form-item>
                <el-form-item label="用户名">
                    <el-input
                        v-model="proxyForm.username"
                        placeholder="代理认证用户名（可选）"
                        clearable
                    />
                </el-form-item>
                <el-form-item label="密码">
                    <el-input
                        v-model="proxyForm.password"
                        type="password"
                        placeholder="代理认证密码（可选）"
                        show-password
                        clearable
                    />
                </el-form-item>
            </el-form>
            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="showAddProxyDialog = false">取消</el-button>
                    <el-button
                        type="primary"
                        @click="addProxy"
                        :loading="addingProxy"
                    >
                        添加代理
                    </el-button>
                </div>
            </template>
        </el-dialog>

        <!-- 代理API配置对话框 -->
        <el-dialog
            v-model="showProxyApiDialog"
            title="配置代理API"
            width="600px"
            :close-on-click-modal="false"
        >
            <el-form :model="apiForm" label-width="120px" :rules="apiRules" ref="apiFormRef">
                <el-form-item label="API类型" prop="apiType">
                    <el-select v-model="apiForm.apiType" style="width: 100%" @change="onApiTypeChange">
                        <el-option label="自定义API" value="custom"></el-option>
                        <el-option label="ProxyMesh" value="proxymesh"></el-option>
                        <el-option label="Bright Data" value="brightdata"></el-option>
                        <el-option label="Oxylabs" value="oxylabs"></el-option>
                        <el-option label="SmartProxy" value="smartproxy"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="API地址" prop="apiUrl">
                    <el-input
                        v-model="apiForm.apiUrl"
                        placeholder="代理API的完整URL地址"
                        clearable
                    />
                    <div class="form-hint">
                        <span>示例: https://your-proxy-api.com/api/proxies</span>
                    </div>
                </el-form-item>
                <el-form-item label="API密钥" prop="apiKey">
                    <el-input
                        v-model="apiForm.apiKey"
                        type="password"
                        placeholder="API访问密钥"
                        show-password
                        clearable
                    />
                </el-form-item>
                <el-form-item label="请求头">
                    <el-input
                        v-model="apiForm.headers"
                        type="textarea"
                        :rows="3"
                        placeholder='自定义请求头（JSON格式）例如：{"Authorization": "Bearer token"}'
                        clearable
                    />
                </el-form-item>
                <el-form-item label="同步间隔(分钟)">
                    <el-input-number
                        v-model="apiForm.syncInterval"
                        :min="5"
                        :max="1440"
                        style="width: 100%"
                    />
                    <div class="form-hint">
                        <span>从API同步代理列表的间隔时间</span>
                    </div>
                </el-form-item>
                <el-form-item>
                    <el-button
                        type="success"
                        @click="testProxyApi"
                        :loading="testingApi"
                        size="small"
                    >
                        测试API连接
                    </el-button>
                    <el-button
                        type="primary"
                        @click="syncProxiesFromApi"
                        :loading="syncingProxies"
                        size="small"
                    >
                        立即同步代理
                    </el-button>
                </el-form-item>
            </el-form>
            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="showProxyApiDialog = false">取消</el-button>
                    <el-button
                        type="primary"
                        @click="saveProxyApiConfig"
                        :loading="savingApiConfig"
                    >
                        保存配置
                    </el-button>
                </div>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue
        const { ElMessage, ElMessageBox } = ElementPlus

        createApp({
            data() {
                return {
                    socket: null,
                    isConnected: false,
                    currentProduct: 'iphone',
                    currentProductType: 'iPhone',
                    showCreateDialog: false,
                    showDetailDialog: false,
                    creating: false,
                    tasks: [],
                    selectedTask: null,
                    presetAccounts: [], // 移除预设账号配置
                    systemStatus: {
                        total_tasks: 0,
                        active_tasks: 0,
                        max_concurrent: 3
                    },

                    // 轮询相关
                    pollingInterval: null,
                    pollingEnabled: true,
                    pollingFrequency: 1000, // 1秒轮询一次
                    
                    // WebSocket连接状态管理
                    connectionStatus: 'disconnected', // disconnected, connecting, connected
                    reconnectAttempts: 0,
                    maxReconnectAttempts: 5,
                    reconnectInterval: null,
                    taskForm: {
                        name: '',
                        url: '',
                        selectedAccount: null,
                        selectedGiftCards: [], // 改为数组支持多张礼品卡
                        selectedModel: '',
                        selectedSize: '',
                        selectedStorage: '',
                        selectedColor: '',
                        priority: 2
                    },
                    tempGiftCardSelection: null, // 临时礼品卡选择
                    iphoneConfigs: {
                        models: {},
                        color_display_names: {},
                        storage_display_names: {}
                    },
                    generatedUrl: '',
                    parsingUrl: false,
                    isValidUrl: true,
                    startingAllTasks: false,
                    systemLogs: [],
                    showSystemLogsDialog: false,

                    // 账号管理
                    accounts: [],
                    showCreateAccountDialog: false,
                    editingAccount: null,
                    savingAccount: false,
                    accountForm: {
                        email: '',
                        password: '',
                        phone_number: '07700900000'
                    },
                    accountRules: {
                        email: [
                            { required: true, message: '请输入邮箱', trigger: 'blur' },
                            { type: 'email', message: '请输入正确的邮箱格式', trigger: 'blur' }
                        ],
                        password: [
                            { required: true, message: '请输入密码', trigger: 'blur' },
                            { min: 6, message: '密码长度至少6位', trigger: 'blur' }
                        ],
                        phone_number: [
                            { required: true, message: '请输入电话号码', trigger: 'blur' },
                            { pattern: /^07\d{9}$/, message: '请输入正确的英国手机号码格式 (07xxxxxxxxx)', trigger: 'blur' }
                        ]
                    },

                    // 礼品卡管理
                    giftCards: [],
                    giftCardStatuses: [],
                    giftCardStatusFilter: '',
                    showCreateGiftCardDialog: false,
                    editingGiftCard: null,
                    savingGiftCard: false,
                    giftCardForm: {
                        gift_card_number: '',
                        status: '',
                        notes: ''
                    },
                    giftCardRules: {
                        gift_card_number: [
                            { required: true, message: '请输入礼品卡号', trigger: 'blur' }
                        ],
                        status: [
                            { required: true, message: '请选择状态', trigger: 'change' }
                        ]
                    },

                    // IP池管理相关数据
                    ipStatus: {
                        current_ip: {},
                        proxy_pool: {},
                        rotation_enabled: false,
                        gift_card_rotation_enabled: false
                    },
                    ipSettings: {
                        rotation_enabled: false,
                        gift_card_rotation_enabled: false,
                        max_gift_card_per_ip: 2,
                        rotation_interval: 300
                    },
                    proxyList: [],
                    loadingIpStatus: false,
                    rotatingIp: false,
                    testingProxy: null,
                    
                    // 添加代理对话框
                    showAddProxyDialog: false,
                    addingProxy: false,
                    proxyForm: {
                        host: '',
                        port: null,
                        protocol: 'http',
                        country: '',
                        username: '',
                        password: ''
                    },
                    proxyRules: {
                        host: [
                            { required: true, message: '请输入主机地址', trigger: 'blur' },
                            { pattern: /^[a-zA-Z0-9.-]+$/, message: '主机地址格式不正确', trigger: 'blur' }
                        ],
                        port: [
                            { required: true, message: '请输入端口号', trigger: 'blur' },
                            { type: 'number', min: 1, max: 65535, message: '端口号范围：1-65535', trigger: 'blur' }
                        ],
                        protocol: [
                            { required: true, message: '请选择协议类型', trigger: 'change' }
                        ],
                        country: [
                            { required: true, message: '请输入国家/地区代码', trigger: 'blur' }
                        ]
                    },
                    
                    // 代理API配置对话框
                    showProxyApiDialog: false,
                    savingApiConfig: false,
                    testingApi: false,
                    syncingProxies: false,
                    apiForm: {
                        apiType: 'custom',
                        apiUrl: '',
                        apiKey: '',
                        headers: '',
                        syncInterval: 60
                    },
                    apiRules: {
                        apiUrl: [
                            { required: true, message: '请输入API地址', trigger: 'blur' },
                            { type: 'url', message: 'API地址格式不正确', trigger: 'blur' }
                        ],
                        apiKey: [
                            { required: true, message: '请输入API密钥', trigger: 'blur' }
                        ]
                    },
                    taskRules: {
                        name: [
                            { required: true, message: '请输入任务名称', trigger: 'blur' }
                        ],
                        url: [
                            { required: true, message: '请输入产品URL', trigger: 'blur' }
                        ],
                        selectedAccount: [
                            { required: true, message: '请选择Apple ID账号', trigger: 'change' }
                        ],
                        selectedGiftCards: [
                            { 
                                validator: (rule, value, callback) => {
                                    if (!value || value.length === 0) {
                                        callback(new Error('必选项：至少需要选择一张礼品卡'))
                                    } else {
                                        callback()
                                    }
                                }, 
                                trigger: 'change' 
                            }
                        ]
                    }
                }
            },
            computed: {
                availableSizes() {
                    if (!this.taskForm.selectedModel || !this.iphoneConfigs.models[this.taskForm.selectedModel]) {
                        return {}
                    }
                    return this.iphoneConfigs.models[this.taskForm.selectedModel].sizes
                },

                availableStorages() {
                    if (!this.taskForm.selectedModel || !this.taskForm.selectedSize) {
                        return []
                    }
                    const sizeData = this.iphoneConfigs.models[this.taskForm.selectedModel]?.sizes[this.taskForm.selectedSize]
                    return sizeData?.storages || []
                },

                availableColors() {
                    if (!this.taskForm.selectedModel || !this.taskForm.selectedSize) {
                        return []
                    }
                    const sizeData = this.iphoneConfigs.models[this.taskForm.selectedModel]?.sizes[this.taskForm.selectedSize]
                    return sizeData?.colors || []
                },

                hasExecutableTasks() {
                    return this.tasks.some(task => task.status === 'pending')
                },

                pendingTasks() {
                    return this.tasks.filter(task => task.status === 'pending')
                },

                runningTasks() {
                    return this.tasks.filter(task => task.status === 'running')
                },

                availableGiftCards() {
                    // 显示所有礼品卡，不管状态如何（因为很多时候我们不知道礼品卡的真实状态）
                    return this.giftCards.filter(card => card.is_active)
                },
                
                availableGiftCardsToAdd() {
                    // 可添加的礼品卡（排除已选择的）
                    return this.availableGiftCards.filter(card => 
                        !this.taskForm.selectedGiftCards.includes(card.id)
                    )
                },

                hasIphonePendingTasks() {
                    return this.getTasksByProduct('iphone').some(task => task.status === 'pending')
                }
            },

            beforeUnmount() {
                this.stopPolling()
            },
            methods: {
                initWebSocket() {
                    this.connectionStatus = 'connecting'
                    console.log('正在初始化WebSocket连接...')
                    
                    this.socket = io('http://localhost:5001')

                    this.socket.on('connect', () => {
                        this.isConnected = true
                        this.connectionStatus = 'connected'
                        this.reconnectAttempts = 0 // 重置重连计数
                        this.addSystemLog('WebSocket连接成功', 'success')
                        ElMessage.success('WebSocket连接成功')
                        console.log('✅ WebSocket连接已建立')
                    })

                    this.socket.on('disconnect', (reason) => {
                        this.isConnected = false
                        this.connectionStatus = 'disconnected'
                        console.log('❌ WebSocket连接断开:', reason)
                        this.addSystemLog(`WebSocket连接断开: ${reason}`, 'warning')
                        ElMessage.warning('WebSocket连接断开')
                        
                        // 如果不是主动断开，尝试重连
                        if (reason !== 'io client disconnect') {
                            this.reconnectWebSocket()
                        }
                    })

                    this.socket.on('connect_error', (error) => {
                        this.handleWebSocketError(error)
                    })

                    this.socket.on('error', (error) => {
                        this.handleWebSocketError(error)
                    })

                    this.socket.on('initial_tasks', (data) => {
                        this.tasks = data.tasks || []
                    })

                    this.socket.on('task_created', (task) => {
                        console.log('收到 task_created 事件:', task)
                        this.addSystemLog(`任务创建成功: ${task.config.name}`, 'success')

                        // 检查任务是否已存在，避免重复添加
                        const existingIndex = this.tasks.findIndex(t => t.id === task.id)
                        if (existingIndex === -1) {
                            this.tasks.push(task)
                            ElMessage.success('任务创建成功')
                        }

                        // 如果正在创建任务，关闭对话框
                        if (this.creating) {
                            this.creating = false
                            this.closeCreateDialog()
                        }
                    })

                    this.socket.on('task_create_success', (data) => {
                        console.log('收到 task_create_success 事件:', data)
                        this.creating = false
                        this.closeCreateDialog()
                    })

                    this.socket.on('task_create_error', (data) => {
                        console.log('收到 task_create_error 事件:', data)
                        ElMessage.error(data.error || '任务创建失败')
                        this.creating = false
                    })

                    this.socket.on('task_update', (task) => {
                        console.log('收到 task_update 事件:', task)

                        // 更详细的系统日志
                        const stepText = task.current_step ? task.current_step.replace('_', ' ') : '未知步骤'
                        this.addSystemLog(`📊 任务进度更新: ${task.config.name} - ${stepText} (${task.progress}%)`, 'info')

                        const index = this.tasks.findIndex(t => t.id === task.id)
                        if (index >= 0) {
                            // Vue 3 响应式更新 - 确保触发重新渲染
                            const updatedTask = { ...task }
                            this.$set ? this.$set(this.tasks, index, updatedTask) : (this.tasks[index] = updatedTask)

                            // 如果是当前查看的任务，也更新详情
                            if (this.selectedTask && this.selectedTask.id === task.id) {
                                this.selectedTask = updatedTask
                            }
                        } else {
                            // 如果任务不存在，添加它
                            this.tasks.push(task)
                        }

                        // 强制更新UI（确保进度条实时更新）
                        this.$forceUpdate && this.$forceUpdate()
                    })

                    // 新增：监听细粒度的步骤更新事件
                    this.socket.on('step_update', (data) => {
                        console.log('收到 step_update 事件:', data)
                        const { task_id, step, status, progress, message } = data
                        
                        // 查找对应的任务
                        const taskIndex = this.tasks.findIndex(t => t.id === task_id)
                        if (taskIndex >= 0) {
                            const task = this.tasks[taskIndex]
                            
                            // 更新任务的当前步骤和进度
                            task.current_step = step
                            if (progress !== undefined) {
                                task.progress = progress
                            }
                            
                            // 添加步骤日志
                            if (message) {
                                const stepLog = {
                                    timestamp: new Date().toISOString(),
                                    message: `[${this.formatStepName(step)}] ${message}`,
                                    level: status === 'failed' ? 'error' : status === 'completed' ? 'success' : 'info'
                                }
                                
                                if (!task.logs) {
                                    task.logs = []
                                }
                                task.logs.push(stepLog)
                            }
                            
                            // 更新任务
                            this.tasks[taskIndex] = { ...task }
                            
                            // 系统日志
                            this.addSystemLog(`🔄 步骤更新: ${task.config.name} - ${this.formatStepName(step)} (${status})`, 
                                             status === 'failed' ? 'error' : 'info')
                        }
                    })

                    // 新增：监听任务日志事件
                    this.socket.on('task_log', (data) => {
                        console.log('收到 task_log 事件:', data)
                        const { task_id, level, message } = data
                        
                        // 查找对应的任务并添加日志
                        const taskIndex = this.tasks.findIndex(t => t.id === task_id)
                        if (taskIndex >= 0) {
                            const task = this.tasks[taskIndex]
                            
                            const logEntry = {
                                timestamp: new Date().toISOString(),
                                message: message,
                                level: level || 'info'
                            }
                            
                            if (!task.logs) {
                                task.logs = []
                            }
                            task.logs.push(logEntry)
                            
                            // 更新任务
                            this.tasks[taskIndex] = { ...task }
                            
                            // 如果是当前查看的任务详情，也更新
                            if (this.selectedTask && this.selectedTask.id === task_id) {
                                this.selectedTask = { ...task }
                            }
                        }
                    })

                    this.socket.on('system_status', (status) => {
                        this.systemStatus = status
                    })

                    this.socket.on('task_start_success', (data) => {
                        ElMessage.success(`任务 ${data.task_id} 启动成功`)
                    })

                    this.socket.on('task_start_error', (data) => {
                        ElMessage.error(`任务启动失败: ${data.message}`)
                    })

                    this.socket.on('task_cancel_success', (data) => {
                        ElMessage.warning(`任务 ${data.task_id} 已取消`)
                    })

                    this.socket.on('task_cancel_error', (data) => {
                        ElMessage.error(`任务取消失败: ${data.message}`)
                    })

                    this.socket.on('task_delete_success', (data) => {
                        console.log('收到 task_delete_success 事件:', data)
                        // 从本地任务列表中移除
                        const index = this.tasks.findIndex(t => t.id === data.task_id)
                        if (index >= 0) {
                            this.tasks.splice(index, 1)
                        }
                        ElMessage.success('任务删除成功')
                    })

                    this.socket.on('task_deleted', (data) => {
                        console.log('收到 task_deleted 事件:', data)
                        // 从本地任务列表中移除
                        const index = this.tasks.findIndex(t => t.id === data.task_id)
                        if (index >= 0) {
                            this.tasks.splice(index, 1)
                            console.log('任务已从列表中移除:', data.task_id)
                        }
                    })

                    this.socket.on('error', (data) => {
                        console.error('WebSocket错误:', data)
                        ElMessage.error(data.message || '发生未知错误')
                    })

                    // 调试消息监听
                    this.socket.on('debug_message', (data) => {
                        console.log('🔥 收到后端调试消息:', data)
                    })

                    // 监听任务执行错误
                    this.socket.on('task_error', (data) => {
                        console.error('任务执行错误:', data)
                        ElMessage.error(`任务 ${data.task_id} 执行错误: ${data.message}`)
                    })

                    // 监听自动化步骤错误
                    this.socket.on('automation_error', (data) => {
                        console.error('自动化错误:', data)
                        ElMessage.error(`自动化错误: ${data.message}`)
                    })

                    // 新增：监听礼品卡错误事件
                    this.socket.on('gift_card_error', (data) => {
                        console.log('🚨 收到礼品卡错误事件:', data)
                        const { task_id, gift_card_number, error_status, error_message } = data
                        
                        // 查找对应的任务并更新错误信息
                        const taskIndex = this.tasks.findIndex(t => t.id === task_id)
                        if (taskIndex >= 0) {
                            const task = this.tasks[taskIndex]
                            
                            // 添加礼品卡错误信息到任务
                            if (!task.gift_card_errors) {
                                task.gift_card_errors = []
                            }
                            
                            // 检查是否已存在该卡的错误
                            const existingErrorIndex = task.gift_card_errors.findIndex(err => err.card_number === gift_card_number)
                            
                            const errorInfo = {
                                card_number: gift_card_number,
                                status: error_status,
                                message: error_message,
                                timestamp: new Date().toISOString()
                            }
                            
                            if (existingErrorIndex >= 0) {
                                // 更新现有错误
                                task.gift_card_errors[existingErrorIndex] = errorInfo
                            } else {
                                // 添加新错误
                                task.gift_card_errors.push(errorInfo)
                            }
                            
                            // 更新任务
                            this.tasks[taskIndex] = { ...task }
                            
                            // 显示错误提示
                            ElMessage.error(`礼品卡错误: ${gift_card_number} - ${error_message}`)
                            
                            // 系统日志
                            this.addSystemLog(`🎁❌ 礼品卡错误: ${gift_card_number} -> ${error_status}`, 'error')
                        }
                    })

                    // 新增：监听余额不足错误事件
                    this.socket.on('payment_balance_error', (data) => {
                        console.log('💳 收到余额不足错误事件:', data)
                        const { task_id, error_message, remaining_amount, full_error } = data
                        
                        // 查找对应的任务并添加余额错误信息
                        const taskIndex = this.tasks.findIndex(t => t.id === task_id)
                        if (taskIndex >= 0) {
                            const task = this.tasks[taskIndex]
                            
                            // 添加余额错误信息
                            task.balance_error = {
                                message: error_message,
                                remaining_amount: remaining_amount,
                                full_error: full_error,
                                timestamp: new Date().toISOString()
                            }
                            
                            // 更新任务
                            this.tasks[taskIndex] = { ...task }
                            
                            // 显示错误提示
                            ElMessage.error(`余额不足: ${remaining_amount}`)
                            
                            // 系统日志
                            this.addSystemLog(`💳❌ 余额不足: ${remaining_amount}`, 'error')
                        }
                    })

                    // 新增：监听重新运行任务成功事件
                    this.socket.on('rerun_task_success', (data) => {
                        console.log('🔄 收到重新运行任务成功事件:', data)
                        const { task_id } = data
                        
                        // 查找对应的任务并更新状态
                        const taskIndex = this.tasks.findIndex(t => t.id === task_id)
                        if (taskIndex >= 0) {
                            const task = this.tasks[taskIndex]
                            task.rerunning = false
                            this.tasks[taskIndex] = { ...task }
                        }
                        
                        ElMessage.success('任务重新运行成功')
                        this.addSystemLog(`🔄✅ 任务重新运行成功: ${task_id}`, 'success')
                    })

                    // 新增：监听重新运行任务失败事件
                    this.socket.on('rerun_task_error', (data) => {
                        console.log('🔄❌ 收到重新运行任务失败事件:', data)
                        const { task_id, message } = data
                        
                        // 查找对应的任务并更新状态
                        const taskIndex = this.tasks.findIndex(t => t.id === task_id)
                        if (taskIndex >= 0) {
                            const task = this.tasks[taskIndex]
                            task.rerunning = false
                            this.tasks[taskIndex] = { ...task }
                        }
                        
                        ElMessage.error(`重新运行任务失败: ${message}`)
                        this.addSystemLog(`🔄❌ 任务重新运行失败: ${task_id} - ${message}`, 'error')
                    })

                    // 请求初始数据
                    setTimeout(() => {
                        console.log('请求初始数据...')
                        this.socket.emit('get_tasks')
                        this.socket.emit('get_system_status')
                    }, 1000)
                },

                switchProduct(productKey) {
                    this.currentProduct = productKey
                    const productMap = {
                        'iphone': 'iPhone',
                        'mac': 'Mac',
                        'ipad': 'iPad',
                        'watch': 'Apple Watch',
                        'accounts': '账号管理',
                        'gift-cards': '礼品卡管理',
                        'ip-pool': 'IP池管理'
                    }
                    this.currentProductType = productMap[productKey] || 'Unknown'

                    // 加载对应页面的数据
                    if (productKey === 'accounts') {
                        this.loadAccounts()
                    } else if (productKey === 'gift-cards') {
                        this.loadGiftCards()
                        this.loadGiftCardStatuses()
                    } else if (productKey === 'ip-pool') {
                        this.refreshIpStatus()
                    }
                },

                openCreateDialog(productType) {
                    this.currentProductType = productType === 'iphone' ? 'iPhone' :
                                           productType === 'mac' ? 'Mac' :
                                           productType === 'ipad' ? 'iPad' : 'Apple Watch'
                    this.showCreateDialog = true
                    this.resetTaskForm()
                },

                closeCreateDialog() {
                    this.showCreateDialog = false
                    this.resetTaskForm()
                },
                
                // 礼品卡多选相关方法
                addGiftCard() {
                    if (this.tempGiftCardSelection && !this.taskForm.selectedGiftCards.includes(this.tempGiftCardSelection)) {
                        this.taskForm.selectedGiftCards.push(this.tempGiftCardSelection)
                        this.tempGiftCardSelection = null
                        // 触发表单验证
                        this.$nextTick(() => {
                            this.$refs.taskFormRef?.validateField('selectedGiftCards')
                        })
                    }
                },
                
                removeSelectedGiftCard(index) {
                    this.taskForm.selectedGiftCards.splice(index, 1)
                    // 触发表单验证
                    this.$nextTick(() => {
                        this.$refs.taskFormRef?.validateField('selectedGiftCards')
                    })
                },
                
                getGiftCardDisplayName(cardId) {
                    const card = this.giftCards.find(c => c.id === cardId)
                    return card ? `${card.gift_card_number} (${card.status})` : cardId
                },

                resetTaskForm() {
                    this.taskForm = {
                        name: '',
                        url: '',
                        selectedAccount: null,
                        selectedGiftCards: [], // 重置为空数组支持多张礼品卡
                        selectedModel: '',
                        selectedSize: '',
                        selectedStorage: '',
                        selectedColor: '',
                        priority: 2
                    }
                    this.tempGiftCardSelection = null
                    this.generatedUrl = ''
                    this.isValidUrl = true
                },

                // 移除预设账号选择方法 - 已废弃
                // onAccountSelect 方法已删除

                async loadIphoneConfigs() {
                    try {
                        console.log('🔄 开始加载iPhone配置...')
                        const response = await axios.get('http://localhost:5001/api/config/iphone-configs')
                        console.log('✅ iPhone配置加载成功:', response.data)
                        console.log('📊 模型数量:', Object.keys(response.data.models || {}).length)
                        this.iphoneConfigs = response.data
                        console.log('📱 Vue数据已更新:', this.iphoneConfigs)
                    } catch (error) {
                        console.error('❌ 加载iPhone配置失败:', error)
                        console.error('错误详情:', error.response?.data || error.message)
                        ElMessage.error('加载iPhone配置失败: ' + (error.response?.data?.error || error.message))
                    }
                },

                onModelChange() {
                    // 重置后续选择
                    this.taskForm.selectedSize = ''
                    this.taskForm.selectedStorage = ''
                    this.taskForm.selectedColor = ''
                    this.generatedUrl = ''
                },

                onSizeChange() {
                    // 重置后续选择
                    this.taskForm.selectedStorage = ''
                    this.taskForm.selectedColor = ''
                    this.generatedUrl = ''
                },

                onStorageChange() {
                    // 重置颜色选择
                    this.taskForm.selectedColor = ''
                    this.generatedUrl = ''
                },

                async onColorChange() {
                    if (this.taskForm.selectedModel && this.taskForm.selectedSize &&
                        this.taskForm.selectedStorage && this.taskForm.selectedColor) {
                        await this.generateUrl()
                    }
                },

                async generateUrl() {
                    try {
                        const response = await axios.post('http://localhost:5001/api/config/generate-url', {
                            model: this.taskForm.selectedModel,
                            size: this.taskForm.selectedSize,
                            storage: this.taskForm.selectedStorage,
                            color: this.taskForm.selectedColor
                        })

                        if (response.data.success) {
                            this.generatedUrl = response.data.url
                            this.taskForm.url = response.data.url
                            this.isValidUrl = true
                        }
                    } catch (error) {
                        console.error('Failed to generate URL:', error)
                        ElMessage.error('生成URL失败')
                    }
                },

                async parseUrl() {
                    if (!this.taskForm.url) {
                        ElMessage.warning('请先输入URL')
                        return
                    }

                    this.parsingUrl = true
                    try {
                        const response = await axios.post('http://localhost:5001/api/config/parse-url', {
                            url: this.taskForm.url
                        })

                        if (response.data.success) {
                            const config = response.data.config
                            this.taskForm.selectedModel = config.model
                            this.taskForm.selectedSize = config.size
                            this.taskForm.selectedStorage = config.storage
                            this.taskForm.selectedColor = config.color
                            this.generatedUrl = this.taskForm.url
                            this.isValidUrl = true
                            ElMessage.success('URL解析成功')
                        } else {
                            this.isValidUrl = false
                            ElMessage.error(response.data.error || 'URL解析失败')
                        }
                    } catch (error) {
                        console.error('Failed to parse URL:', error)
                        this.isValidUrl = false
                        ElMessage.error('URL解析失败')
                    } finally {
                        this.parsingUrl = false
                    }
                },

                parseUrlIfNeeded() {
                    if (this.taskForm.url && this.taskForm.url.includes('apple.com/uk/shop/buy-iphone/')) {
                        this.parseUrl()
                    }
                },

                copyUrl() {
                    if (this.generatedUrl) {
                        navigator.clipboard.writeText(this.generatedUrl).then(() => {
                            ElMessage.success('URL已复制到剪贴板')
                        }).catch(() => {
                            ElMessage.error('复制失败')
                        })
                    }
                },

                createTask() {
                    this.$refs.taskFormRef.validate((valid) => {
                        if (valid) {
                            this.creating = true

                            // 获取显示名称
                            const modelDisplayName = this.iphoneConfigs.models[this.taskForm.selectedModel]?.name || this.taskForm.selectedModel
                            const sizeDisplayName = this.iphoneConfigs.models[this.taskForm.selectedModel]?.sizes[this.taskForm.selectedSize]?.name || this.taskForm.selectedSize
                            const storageDisplayName = this.iphoneConfigs.storage_display_names[this.taskForm.selectedStorage] || this.taskForm.selectedStorage
                            const colorDisplayName = this.iphoneConfigs.color_display_names[this.taskForm.selectedColor] || this.taskForm.selectedColor

                            // 获取选中的账号信息和礼品卡信息
                            const selectedAccount = this.accounts.find(acc => acc.id === this.taskForm.selectedAccount)
                            
                            // 必须选择账号
                            if (!selectedAccount) {
                                ElMessage.error('请选择Apple ID账号')
                                this.creating = false
                                return
                            }
                            
                            const selectedGiftCards = this.taskForm.selectedGiftCards.map(cardId => 
                                this.giftCards.find(card => card.id === cardId)
                            ).filter(card => card) // 过滤掉找不到的卡

                            const taskData = {
                                name: this.taskForm.name,
                                url: this.taskForm.url || this.generatedUrl,
                                account_config: {
                                    email: selectedAccount.email,
                                    password: selectedAccount.password,
                                    phone_number: selectedAccount.phone_number || '07700900000'
                                },
                                // 支持多张礼品卡
                                gift_cards: selectedGiftCards.map(card => ({
                                    gift_card_number: card.gift_card_number,
                                    status: card.status
                                })),
                                product_config: {
                                    model: sizeDisplayName, // 使用完整的尺寸名称
                                    storage: storageDisplayName,
                                    finish: colorDisplayName,
                                    trade_in: 'No trade-in',
                                    payment: 'Buy',
                                    apple_care: 'No AppleCare+ Coverage'
                                },
                                enabled: true,
                                priority: this.taskForm.priority,
                                use_proxy: false
                            }

                            // 调试：打印发送的数据
                            console.log('🔍 前端发送任务数据:', taskData);
                            console.log('🎁 选中的礼品卡数量:', selectedGiftCards.length);
                            console.log('🎁 选中的礼品卡:', selectedGiftCards);
                            console.log('🎁 所有礼品卡:', this.giftCards);

                            // 发送创建任务请求
                            this.socket.emit('create_task', taskData)

                            // 不要立即关闭对话框，等待服务器响应
                        }
                    })
                },

                startTask(taskId) {
                    this.socket.emit('start_task', { task_id: taskId })
                    ElMessage.success('任务启动请求已发送')
                },

                async startAllTasks() {
                    const pendingTasks = this.pendingTasks

                    if (pendingTasks.length === 0) {
                        ElMessage.warning('没有待执行的任务')
                        return
                    }

                    ElMessageBox.confirm(
                        `确定要启动 ${pendingTasks.length} 个待执行任务吗？`,
                        '批量启动任务',
                        {
                            confirmButtonText: '启动',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }
                    ).then(() => {
                        this.startingAllTasks = true

                        // 逐个启动任务，间隔500ms避免服务器压力
                        let index = 0
                        const startNext = () => {
                            if (index < pendingTasks.length) {
                                const task = pendingTasks[index]
                                this.socket.emit('start_task', { task_id: task.id })
                                index++
                                setTimeout(startNext, 500)
                            } else {
                                this.startingAllTasks = false
                                ElMessage.success(`已启动 ${pendingTasks.length} 个任务`)
                            }
                        }

                        startNext()
                    }).catch(() => {
                        // 用户取消
                    })
                },

                startIphoneTasks() {
                    const iphoneTasks = this.getTasksByProduct('iphone').filter(task => task.status === 'pending')

                    if (iphoneTasks.length === 0) {
                        ElMessage.warning('没有待执行的iPhone任务')
                        return
                    }

                    ElMessageBox.confirm(
                        `确定要启动 ${iphoneTasks.length} 个iPhone任务吗？`,
                        '批量启动iPhone任务',
                        {
                            confirmButtonText: '启动',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }
                    ).then(() => {
                        iphoneTasks.forEach((task, index) => {
                            setTimeout(() => {
                                this.socket.emit('start_task', { task_id: task.id })
                            }, index * 500) // 间隔500ms启动
                        })
                        ElMessage.success(`已启动 ${iphoneTasks.length} 个iPhone任务`)
                    }).catch(() => {
                        // 用户取消
                    })
                },

                cancelTask(taskId) {
                    ElMessageBox.confirm('确定要取消这个任务吗？', '确认取消', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        this.socket.emit('cancel_task', { task_id: taskId })
                        ElMessage.warning('任务取消请求已发送')
                    })
                },

                deleteTask(taskId) {
                    ElMessageBox.confirm('确定要删除这个任务吗？删除后无法恢复。', '确认删除', {
                        confirmButtonText: '删除',
                        cancelButtonText: '取消',
                        type: 'error'
                    }).then(() => {
                        this.socket.emit('delete_task', { task_id: taskId })
                        ElMessage.error('任务删除请求已发送')
                    })
                },

                viewTaskDetail(task) {
                    this.selectedTask = task
                    this.showDetailDialog = true
                },

                handleCommand(command) {
                    switch(command) {
                        case 'status':
                            this.showSystemStatus()
                            break
                        case 'logs':
                            this.showSystemLogs()
                            break
                        case 'settings':
                            ElMessage.info('系统设置功能开发中...')
                            break
                        case 'stop-all':
                            this.stopAllTasks()
                            break
                    }
                },

                showSystemStatus() {
                    const statusInfo = `
                        📊 系统状态信息

                        总任务数: ${this.tasks.length}
                        等待中: ${this.pendingTasks.length}
                        运行中: ${this.runningTasks.length}
                        已完成: ${this.getTasksByStatus('completed').length}
                        失败: ${this.getTasksByStatus('failed').length}
                        已取消: ${this.getTasksByStatus('cancelled').length}

                        连接状态: ${this.isConnected ? '✅ 已连接' : '❌ 未连接'}
                        最大并发: ${this.systemStatus.max_concurrent}
                    `

                    ElMessageBox.alert(statusInfo, '系统状态', {
                        confirmButtonText: '确定',
                        type: 'info'
                    })
                },

                stopAllTasks() {
                    const runningTasks = this.runningTasks

                    if (runningTasks.length === 0) {
                        ElMessage.warning('没有正在运行的任务')
                        return
                    }

                    ElMessageBox.confirm(
                        `确定要停止 ${runningTasks.length} 个正在运行的任务吗？`,
                        '批量停止任务',
                        {
                            confirmButtonText: '停止',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }
                    ).then(() => {
                        runningTasks.forEach(task => {
                            this.socket.emit('cancel_task', { task_id: task.id })
                        })
                        ElMessage.success(`已发送停止请求给 ${runningTasks.length} 个任务`)
                    }).catch(() => {
                        // 用户取消
                    })
                },

                getTasksByProduct(productType) {
                    return this.tasks.filter(task => {
                        const url = task.config.url || ''
                        switch(productType) {
                            case 'iphone':
                                return url.includes('iphone')
                            case 'mac':
                                return url.includes('mac')
                            case 'ipad':
                                return url.includes('ipad')
                            case 'watch':
                                return url.includes('watch')
                            default:
                                return false
                        }
                    })
                },

                getTasksByStatus(status) {
                    return this.tasks.filter(task => task.status === status)
                },

                getProductType(task) {
                    const url = task.config.url || ''
                    if (url.includes('iphone')) return 'iPhone'
                    if (url.includes('mac')) return 'Mac'
                    if (url.includes('ipad')) return 'iPad'
                    if (url.includes('watch')) return 'Apple Watch'
                    return '未知'
                },

                getStatusType(status) {
                    const statusMap = {
                        'pending': '',
                        'running': 'warning',
                        'completed': 'success',
                        'failed': 'danger',
                        'cancelled': 'info'
                    }
                    return statusMap[status] || ''
                },

                getStatusText(status) {
                    const statusMap = {
                        'pending': '等待中',
                        'running': '运行中',
                        'completed': '已完成',
                        'failed': '失败',
                        'cancelled': '已取消'
                    }
                    return statusMap[status] || status
                },

                formatTime(timestamp) {
                    if (!timestamp) return 'N/A'
                    return dayjs(timestamp).format('YYYY-MM-DD HH:mm:ss')
                },

                refreshTasks() {
                    console.log('手动刷新任务列表...')
                    this.socket.emit('get_tasks')
                    this.socket.emit('get_system_status')
                    ElMessage.info('正在刷新任务列表...')
                },

                showSystemLogs() {
                    this.showSystemLogsDialog = true
                },

                addSystemLog(message, level = 'info') {
                    const log = {
                        timestamp: new Date(),
                        message: message,
                        level: level
                    }
                    this.systemLogs.unshift(log)

                    // 只保留最近100条日志
                    if (this.systemLogs.length > 100) {
                        this.systemLogs = this.systemLogs.slice(0, 100)
                    }
                },

                // ==================== 账号管理方法 ====================

                async loadAccounts() {
                    try {
                        const response = await axios.get('http://localhost:5001/api/accounts')
                        console.log('获取到的账号数据:', response.data)
                        this.accounts = response.data.map(account => ({
                            ...account,
                            phone_number: account.phone_number || '07700900000'
                        }))
                    } catch (error) {
                        console.error('加载账号失败:', error)
                        ElMessage.error('加载账号失败: ' + (error.response?.data?.error || error.message))
                    }
                },

                editAccount(account) {
                    this.editingAccount = account
                    this.accountForm = {
                        email: account.email,
                        password: '', // 不显示原密码
                        phone_number: account.phone_number || '07700900000'
                    }
                    this.showCreateAccountDialog = true
                },

                async saveAccount() {
                    this.$refs.accountFormRef.validate(async (valid) => {
                        if (valid) {
                            this.savingAccount = true
                            try {
                                if (this.editingAccount) {
                                    // 更新账号
                                    await axios.put(`http://localhost:5001/api/accounts/${this.editingAccount.id}`, this.accountForm)
                                    ElMessage.success('账号更新成功')
                                } else {
                                    // 创建账号
                                    await axios.post('http://localhost:5001/api/accounts', this.accountForm)
                                    ElMessage.success('账号创建成功')
                                }

                                this.closeAccountDialog()
                                this.loadAccounts()

                            } catch (error) {
                                console.error('保存账号失败:', error)
                                ElMessage.error(error.response?.data?.error || '保存账号失败')
                            } finally {
                                this.savingAccount = false
                            }
                        }
                    })
                },

                closeAccountDialog() {
                    this.showCreateAccountDialog = false
                    this.editingAccount = null
                    this.accountForm = {
                        email: '',
                        password: '',
                        phone_number: '07700900000'
                    }
                    if (this.$refs.accountFormRef) {
                        this.$refs.accountFormRef.resetFields()
                    }
                },

                async deleteAccount(accountId) {
                    ElMessageBox.confirm('确定要删除这个账号吗？', '确认删除', {
                        confirmButtonText: '删除',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(async () => {
                        try {
                            await axios.delete(`http://localhost:5001/api/accounts/${accountId}`)
                            ElMessage.success('账号删除成功')
                            this.loadAccounts()
                        } catch (error) {
                            console.error('删除账号失败:', error)
                            ElMessage.error('删除账号失败')
                        }
                    }).catch(() => {
                        // 用户取消
                    })
                },

                // ==================== 礼品卡管理方法 ====================

                async loadGiftCards() {
                    try {
                        const params = this.giftCardStatusFilter ? { status: this.giftCardStatusFilter } : {}
                        const response = await axios.get('http://localhost:5001/api/gift-cards', { params })
                        this.giftCards = response.data
                    } catch (error) {
                        console.error('加载礼品卡失败:', error)
                        ElMessage.error('加载礼品卡失败')
                    }
                },

                async loadGiftCardStatuses() {
                    try {
                        const response = await axios.get('http://localhost:5001/api/gift-card-statuses')
                        this.giftCardStatuses = response.data
                        if (!this.giftCardForm.status && this.giftCardStatuses.length > 0) {
                            this.giftCardForm.status = this.giftCardStatuses[0]
                        }
                    } catch (error) {
                        console.error('加载礼品卡状态失败:', error)
                    }
                },

                editGiftCard(giftCard) {
                    this.editingGiftCard = giftCard
                    this.giftCardForm = {
                        gift_card_number: giftCard.gift_card_number,
                        status: giftCard.status,
                        notes: giftCard.notes
                    }
                    this.showCreateGiftCardDialog = true
                },

                async saveGiftCard() {
                    this.$refs.giftCardFormRef.validate(async (valid) => {
                        if (valid) {
                            this.savingGiftCard = true
                            try {
                                if (this.editingGiftCard) {
                                    // 更新礼品卡
                                    await axios.put(`http://localhost:5001/api/gift-cards/${this.editingGiftCard.id}`, this.giftCardForm)
                                    ElMessage.success('礼品卡更新成功')
                                } else {
                                    // 创建礼品卡
                                    await axios.post('http://localhost:5001/api/gift-cards', this.giftCardForm)
                                    ElMessage.success('礼品卡创建成功')
                                }

                                this.closeGiftCardDialog()
                                this.loadGiftCards()

                            } catch (error) {
                                console.error('保存礼品卡失败:', error)
                                ElMessage.error(error.response?.data?.error || '保存礼品卡失败')
                            } finally {
                                this.savingGiftCard = false
                            }
                        }
                    })
                },

                closeGiftCardDialog() {
                    this.showCreateGiftCardDialog = false
                    this.editingGiftCard = null
                    this.giftCardForm = { gift_card_number: '', status: '', notes: '' }
                    if (this.$refs.giftCardFormRef) {
                        this.$refs.giftCardFormRef.resetFields()
                    }
                },

                async deleteGiftCard(cardId) {
                    ElMessageBox.confirm('确定要删除这个礼品卡吗？', '确认删除', {
                        confirmButtonText: '删除',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(async () => {
                        try {
                            await axios.delete(`http://localhost:5001/api/gift-cards/${cardId}`)
                            ElMessage.success('礼品卡删除成功')
                            this.loadGiftCards()
                        } catch (error) {
                            console.error('删除礼品卡失败:', error)
                            ElMessage.error('删除礼品卡失败')
                        }
                    }).catch(() => {
                        // 用户取消
                    })
                },

                getGiftCardStatusType(status) {
                    const statusMap = {
                        '有额度': 'success',
                        '0余额': 'warning',
                        '非本国卡': 'danger',
                        '被充值': 'info'
                    }
                    return statusMap[status] || ''
                },

                // ==================== IP池管理方法 ====================

                async refreshIpStatus() {
                    this.loadingIpStatus = true
                    try {
                        const response = await axios.get('/api/ip/status')
                        this.ipStatus = response.data
                        
                        // 更新设置
                        const settingsResponse = await axios.get('/api/ip/settings')
                        this.ipSettings = settingsResponse.data
                        
                        // 更新代理列表（模拟，实际需要后端提供列表接口）
                        this.updateProxyList()
                        
                        ElMessage.success('IP状态已刷新')
                    } catch (error) {
                        ElMessage.error('刷新IP状态失败: ' + (error.response?.data?.error || error.message))
                    } finally {
                        this.loadingIpStatus = false
                    }
                },

                async rotateIpManually() {
                    this.rotatingIp = true
                    try {
                        const response = await axios.post('/api/system/rotate-ip')
                        ElMessage.success('IP轮换成功: ' + response.data.message)
                        await this.refreshIpStatus()
                    } catch (error) {
                        ElMessage.error('IP轮换失败: ' + (error.response?.data?.error || error.message))
                    } finally {
                        this.rotatingIp = false
                    }
                },

                async updateIpSettings() {
                    try {
                        await axios.put('/api/ip/settings', this.ipSettings)
                        ElMessage.success('IP设置已更新')
                    } catch (error) {
                        ElMessage.error('更新IP设置失败: ' + (error.response?.data?.error || error.message))
                    }
                },

                async addProxy() {
                    if (!await this.$refs.proxyFormRef.validate()) return
                    
                    this.addingProxy = true
                    try {
                        // 这里应该调用添加代理的API
                        const proxyData = {
                            ...this.proxyForm,
                            status: 'active',
                            success_rate: 0,
                            response_time: 0
                        }
                        
                        // 模拟API调用
                        await new Promise(resolve => setTimeout(resolve, 1000))
                        
                        this.proxyList.push(proxyData)
                        this.showAddProxyDialog = false
                        this.resetProxyForm()
                        ElMessage.success('代理添加成功')
                    } catch (error) {
                        ElMessage.error('添加代理失败: ' + (error.response?.data?.error || error.message))
                    } finally {
                        this.addingProxy = false
                    }
                },

                resetProxyForm() {
                    this.proxyForm = {
                        host: '',
                        port: null,
                        protocol: 'http',
                        country: '',
                        username: '',
                        password: ''
                    }
                    this.$refs.proxyFormRef?.resetFields()
                },

                async testProxy(proxy) {
                    this.testingProxy = proxy.host
                    try {
                        // 模拟代理测试
                        await new Promise(resolve => setTimeout(resolve, 2000))
                        
                        proxy.status = 'active'
                        proxy.response_time = Math.random() * 2
                        proxy.success_count = (proxy.success_count || 0) + 1
                        
                        ElMessage.success(`代理 ${proxy.host}:${proxy.port} 测试通过`)
                    } catch (error) {
                        proxy.status = 'failed'
                        proxy.failure_count = (proxy.failure_count || 0) + 1
                        ElMessage.error(`代理 ${proxy.host}:${proxy.port} 测试失败`)
                    } finally {
                        this.testingProxy = null
                    }
                },

                async blockProxy(proxy) {
                    try {
                        await axios.post('/api/ip/block', {
                            ip_address: `${proxy.host}:${proxy.port}`,
                            reason: 'Manual block'
                        })
                        
                        proxy.status = 'blocked'
                        ElMessage.success(`代理 ${proxy.host}:${proxy.port} 已封禁`)
                    } catch (error) {
                        ElMessage.error('封禁代理失败: ' + (error.response?.data?.error || error.message))
                    }
                },

                async unblockProxy(proxy) {
                    try {
                        // 这里应该调用解封API
                        proxy.status = 'active'
                        ElMessage.success(`代理 ${proxy.host}:${proxy.port} 已解封`)
                    } catch (error) {
                        ElMessage.error('解封代理失败: ' + (error.response?.data?.error || error.message))
                    }
                },

                async removeProxy(proxy) {
                    try {
                        await ElMessageBox.confirm(
                            `确定要删除代理 ${proxy.host}:${proxy.port} 吗？`,
                            '确认删除',
                            { type: 'warning' }
                        )
                        
                        const index = this.proxyList.findIndex(p => p.host === proxy.host && p.port === proxy.port)
                        if (index > -1) {
                            this.proxyList.splice(index, 1)
                            ElMessage.success('代理已删除')
                        }
                    } catch (error) {
                        // 用户取消删除
                    }
                },

                getProxyStatusType(status) {
                    const statusMap = {
                        'active': 'success',
                        'failed': 'danger',
                        'blocked': 'warning',
                        'testing': 'info',
                        'cooldown': 'info'
                    }
                    return statusMap[status] || ''
                },

                getSuccessRateColor(rate) {
                    if (rate >= 0.8) return '#67C23A'
                    if (rate >= 0.6) return '#E6A23C'
                    return '#F56C6C'
                },

                // 代理API配置相关方法
                onApiTypeChange() {
                    // 根据API类型预填充一些默认值
                    const presets = {
                        'proxymesh': {
                            apiUrl: 'https://proxymesh.com/api/proxies',
                            headers: '{"User-Agent": "ProxyMesh Client"}'
                        },
                        'brightdata': {
                            apiUrl: 'https://brightdata.com/api/zone/proxies',
                            headers: '{"Authorization": "Bearer YOUR_TOKEN"}'
                        }
                    }
                    
                    const preset = presets[this.apiForm.apiType]
                    if (preset) {
                        this.apiForm.apiUrl = preset.apiUrl
                        this.apiForm.headers = preset.headers
                    }
                },

                async testProxyApi() {
                    if (!await this.$refs.apiFormRef.validate()) return
                    
                    this.testingApi = true
                    try {
                        // 模拟API测试
                        await new Promise(resolve => setTimeout(resolve, 2000))
                        ElMessage.success('API连接测试成功')
                    } catch (error) {
                        ElMessage.error('API连接测试失败: ' + (error.response?.data?.error || error.message))
                    } finally {
                        this.testingApi = false
                    }
                },

                async syncProxiesFromApi() {
                    this.syncingProxies = true
                    try {
                        // 模拟从API同步代理
                        await new Promise(resolve => setTimeout(resolve, 3000))
                        
                        // 添加一些模拟代理到列表
                        const mockProxies = [
                            { host: '45.76.96.205', port: 8080, country: 'US', protocol: 'http', status: 'active', success_rate: 0.85, response_time: 1.2 },
                            { host: '104.238.174.211', port: 3128, country: 'UK', protocol: 'http', status: 'active', success_rate: 0.92, response_time: 0.8 },
                            { host: '149.28.105.139', port: 8080, country: 'CA', protocol: 'http', status: 'active', success_rate: 0.76, response_time: 1.5 }
                        ]
                        
                        this.proxyList = [...this.proxyList, ...mockProxies]
                        ElMessage.success(`成功同步 ${mockProxies.length} 个代理`)
                    } catch (error) {
                        ElMessage.error('同步代理失败: ' + (error.response?.data?.error || error.message))
                    } finally {
                        this.syncingProxies = false
                    }
                },

                async saveProxyApiConfig() {
                    if (!await this.$refs.apiFormRef.validate()) return
                    
                    this.savingApiConfig = true
                    try {
                        // 这里应该保存API配置到后端
                        await new Promise(resolve => setTimeout(resolve, 1000))
                        
                        this.showProxyApiDialog = false
                        ElMessage.success('API配置保存成功')
                    } catch (error) {
                        ElMessage.error('保存API配置失败: ' + (error.response?.data?.error || error.message))
                    } finally {
                        this.savingApiConfig = false
                    }
                },

                updateProxyList() {
                    // 模拟代理列表更新
                    if (this.proxyList.length === 0) {
                        this.proxyList = [
                            { host: '127.0.0.1', port: 8080, country: 'US', protocol: 'http', status: 'active', success_rate: 0.9, response_time: 0.5, last_used: new Date().toISOString() },
                            { host: '127.0.0.1', port: 8081, country: 'UK', protocol: 'http', status: 'active', success_rate: 0.85, response_time: 0.7, last_used: null },
                            { host: '127.0.0.1', port: 8082, country: 'CA', protocol: 'http', status: 'blocked', success_rate: 0.2, response_time: 2.1, last_used: new Date(Date.now() - 3600000).toISOString() }
                        ]
                    }
                },

                onAccountChange() {
                    // 账号选择变化时的处理
                    console.log('选择的账号ID:', this.taskForm.selectedAccount)
                },

                // ==================== 轮询方法 ====================

                startPolling() {
                    if (this.pollingEnabled && !this.pollingInterval) {
                        console.log('🔄 启动状态轮询，频率:', this.pollingFrequency + 'ms')
                        this.pollingInterval = setInterval(() => {
                            this.pollTaskStatus()
                        }, this.pollingFrequency)
                    }
                },

                stopPolling() {
                    if (this.pollingInterval) {
                        console.log('⏹️ 停止状态轮询')
                        clearInterval(this.pollingInterval)
                        this.pollingInterval = null
                    }
                },

                async pollTaskStatus() {
                    try {
                        // 只有在有活跃任务时才轮询
                        const activeTasks = this.tasks.filter(task =>
                            task.status === 'running' || task.status === 'pending'
                        )

                        if (activeTasks.length === 0) {
                            return
                        }

                        // 通过WebSocket请求最新任务状态
                        if (this.socket && this.isConnected) {
                            this.socket.emit('get_tasks')
                        }

                    } catch (error) {
                        console.error('轮询任务状态失败:', error)
                    }
                },

                formatStepName(step) {
                    const stepMap = {
                        'initializing': '🚀 初始化浏览器',
                        'navigating': '🧭 导航到页面', 
                        'configuring_product': '⚙️ 配置产品',
                        'adding_to_bag': '🛍️ 添加到购物袋',
                        'checkout': '💳 进入结账',
                        'applying_gift_card': '🎁 应用礼品卡',
                        'finalizing': '✅ 完成购买',
                        // 新增更多细粒度步骤
                        'started': '▶️ 开始',
                        'progress': '⏳ 进行中', 
                        'completed': '✅ 完成',
                        'failed': '❌ 失败',
                        'gift_card_link_click': '🔗 点击礼品卡链接',
                        'gift_card_input': '📝 填写礼品卡号码',
                        'gift_card_apply': '✨ 应用礼品卡',
                        'multiple_gift_cards': '🎁 多张礼品卡处理'
                    }
                    return stepMap[step] || step
                },

                getLatestLog(task) {
                    if (!task.logs || task.logs.length === 0) {
                        return '暂无日志'
                    }
                    const latestLog = task.logs[task.logs.length - 1]
                    return latestLog.message || '暂无消息'
                },

                // ==================== 礼品卡错误处理方法 ====================
                
                getGiftCardErrorType(status) {
                    const statusMap = {
                        '非本国卡': 'danger',
                        '0余额': 'warning',
                        '有额度': 'success'
                    }
                    return statusMap[status] || 'info'
                },

                // ==================== 任务重新运行方法 ====================
                
                async rerunTask(task) {
                    try {
                        // 确认重新运行
                        await ElMessageBox.confirm(
                            `确定要重新运行任务 "${task.config.name}" 吗？这将重置任务状态并使用相同的配置重新执行。`,
                            '重新运行任务',
                            {
                                confirmButtonText: '重新运行',
                                cancelButtonText: '取消',
                                type: 'warning'
                            }
                        )

                        // 设置重新运行加载状态
                        task.rerunning = true

                        // 重置任务状态和错误信息
                        const resetData = {
                            task_id: task.id,
                            action: 'reset_and_restart'
                        }

                        // 发送重新运行请求
                        this.socket.emit('rerun_task', resetData)

                        ElMessage.success('任务已重置，正在重新启动...')

                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('重新运行任务失败:', error)
                            ElMessage.error('重新运行任务失败')
                        }
                    } finally {
                        task.rerunning = false
                    }
                },

                // ==================== 新增：步骤管理方法 ====================
                
                getTaskSteps() {
                    return [
                        { step: 'initializing', icon: '🚀', label: '初始化' },
                        { step: 'navigating', icon: '🧭', label: '导航' },
                        { step: 'configuring_product', icon: '⚙️', label: '配置' },
                        { step: 'adding_to_bag', icon: '🛍️', label: '添加' },
                        { step: 'checkout', icon: '💳', label: '结账' },
                        { step: 'applying_gift_card', icon: '🎁', label: '礼品卡' },
                        { step: 'finalizing', icon: '✅', label: '完成' }
                    ]
                },

                isStepCompleted(task, step) {
                    const steps = ['initializing', 'navigating', 'configuring_product', 'adding_to_bag', 'checkout', 'applying_gift_card', 'finalizing']
                    const currentStepIndex = steps.indexOf(task.current_step)
                    const checkStepIndex = steps.indexOf(step)
                    return checkStepIndex < currentStepIndex
                },

                // ==================== 增强的WebSocket连接管理 ====================
                
                reconnectWebSocket() {
                    if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                        console.error('WebSocket重连次数已达上限')
                        ElMessage.error('WebSocket连接失败，请刷新页面重试')
                        return
                    }

                    this.reconnectAttempts++
                    console.log(`WebSocket重连尝试 ${this.reconnectAttempts}/${this.maxReconnectAttempts}`)
                    
                    setTimeout(() => {
                        this.initWebSocket()
                    }, 2000 * this.reconnectAttempts) // 递增延迟
                },

                handleWebSocketError(error) {
                    console.error('WebSocket错误:', error)
                    this.isConnected = false
                    this.connectionStatus = 'disconnected'
                    
                    // 自动重连
                    if (this.reconnectAttempts < this.maxReconnectAttempts) {
                        this.reconnectWebSocket()
                    }
                }
            },

            async mounted() {
                // 初始化数据
                await this.loadTasks()
                await this.loadAccounts()
                await this.loadGiftCards()
                await this.loadIphoneConfigs()  // 添加缺失的iPhone配置加载
                await this.loadGiftCardStatuses()  // 添加缺失的礼品卡状态加载

                // 初始化IP管理数据
                if (this.currentProduct === 'ip-pool') {
                    await this.refreshIpStatus()
                }

                // 初始化WebSocket
                this.initWebSocket()

                // 启动轮询
                this.startPolling()
            }
        }).use(ElementPlus).mount('#app')
    </script>

    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f7fa;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom: none;
            padding: 0 30px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .header-left h2 {
            margin: 0;
            color: white;
            font-weight: 600;
            font-size: 24px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .sidebar {
            background: white;
            border-right: 1px solid #e4e7ed;
            box-shadow: 2px 0 6px rgba(0, 0, 0, 0.05);
        }

        .menu {
            border: none;
            background-color: transparent;
            padding: 20px 0;
        }

        .menu .el-menu-item {
            margin: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .menu .el-menu-item:hover {
            background-color: #f0f2f5;
        }

        .menu .el-menu-item.is-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .main-content {
            padding: 30px;
            background-color: #f5f7fa;
            min-height: calc(100vh - 60px);
        }

        .product-section {
            max-width: 1400px;
            margin: 0 auto;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid #e4e7ed;
        }

        .section-header h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 28px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .status-indicators {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .status-indicators .el-badge {
            margin-right: 8px;
        }

        .header-stats {
            display: flex;
            gap: 40px;
        }

        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }

        .task-card {
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid #e4e7ed;
        }

        .task-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .task-details {
            margin: 16px 0;
        }

        .task-details p {
            margin: 8px 0;
            color: #606266;
            font-size: 14px;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .task-actions .el-button {
            flex: 1;
            min-width: 60px;
        }

        .status-badge {
            margin-right: 15px;
        }

        .dialog-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* 账号信息样式 */
        .el-divider__text {
            background-color: #f5f7fa;
            padding: 0 20px;
        }

        .account-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            border-left: 4px solid #409eff;
        }

        .account-info .el-form-item {
            margin-bottom: 16px;
        }

        .preset-account-hint {
            font-size: 12px;
            color: #909399;
            margin-top: 4px;
        }

        /* URL相关样式 */
        .url-hint {
            margin-top: 8px;
        }

        .config-section {
            background-color: #fafbfc;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            border: 1px solid #e4e7ed;
        }

        .config-section .el-form-item {
            margin-bottom: 20px;
        }

        .generated-url {
            background-color: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }

        .url-display {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            color: #1e40af;
            word-break: break-all;
        }

        /* 日志显示样式 */
        .log-container {
            background-color: #1e1e1e;
            border-radius: 6px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
        }

        .log-entries {
            color: #d4d4d4;
        }

        .log-entry {
            margin-bottom: 4px;
            display: flex;
            gap: 8px;
        }

        .log-entry.error {
            color: #f87171;
        }

        .log-entry.warning {
            color: #fbbf24;
        }

        .log-entry.success {
            color: #34d399;
        }

        .log-entry.info {
            color: #60a5fa;
        }

        .log-time {
            color: #9ca3af;
            min-width: 80px;
            font-size: 10px;
        }

        .log-message {
            flex: 1;
        }

        .no-logs {
            color: #9ca3af;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }

        /* 系统日志样式 */
        .system-logs-container {
            height: 100%;
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e4e7ed;
        }

        /* 实时任务状态样式 */
        .current-step {
            margin: 8px 0;
            padding: 8px;
            background-color: #f0f9ff;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
        }

        .latest-log {
            margin-top: 8px;
            padding: 6px 8px;
            background-color: #f8fafc;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .log-text {
            margin: 0;
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* 进度条动画 */
        .el-progress__text {
            font-weight: 600;
        }

        .el-progress-bar__outer {
            transition: all 0.3s ease;
        }

        /* 任务卡片动画 */
        .task-card {
            transition: all 0.3s ease;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* 表格进度单元格样式 */
        .progress-cell {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .current-step-mini {
            display: flex;
            justify-content: center;
        }

        .current-step-mini .el-tag {
            font-size: 10px;
            padding: 2px 6px;
        }

        /* 步骤指示器样式 */
        .step-progress {
            margin: 12px 0;
            padding: 10px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .step-indicators {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .step-indicator {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-indicator:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background-color: #e2e8f0;
            z-index: 1;
        }

        .step-indicator.completed:not(:last-child)::after {
            background-color: #10b981;
        }

        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-bottom: 4px;
            background-color: #f1f5f9;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .step-indicator.completed .step-icon {
            background-color: #10b981;
            border-color: #10b981;
            color: white;
        }

        .step-indicator.active .step-icon {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
            animation: pulse 2s infinite;
        }

        .step-label {
            font-size: 10px;
            color: #64748b;
            text-align: center;
            font-weight: 500;
        }

        .step-indicator.completed .step-label {
            color: #10b981;
            font-weight: 600;
        }

        .step-indicator.active .step-label {
            color: #3b82f6;
            font-weight: 600;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            50% {
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0);
            }
        }

        /* 连接状态指示器样式 */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .connection-status.connected {
            background-color: #dcfce7;
            color: #16a34a;
        }

        .connection-status.connecting {
            background-color: #fef3c7;
            color: #d97706;
        }

        .connection-status.disconnected {
            background-color: #fee2e2;
            color: #dc2626;
        }

        /* 余额不足错误显示样式 */
        .balance-error {
            margin: 12px 0;
            padding: 10px;
            background-color: #fef1f1;
            border: 1px solid #fca5a5;
            border-radius: 6px;
        }

        .balance-error .error-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 8px;
        }

        .balance-error .error-content {
            padding: 4px 8px;
            background-color: #fff;
            border-radius: 4px;
            border: 1px solid #f3f4f6;
        }

        .balance-error .error-amount {
            font-size: 14px;
            color: #dc2626;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .balance-error .error-message {
            font-size: 12px;
            color: #6b7280;
        }

        /* 礼品卡错误显示样式 */
        .gift-card-errors {
            margin: 12px 0;
            padding: 10px;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
        }

        .gift-card-errors .error-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 8px;
        }

        .gift-card-errors .error-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .gift-card-errors .error-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            background-color: #fff;
            border-radius: 4px;
            border: 1px solid #f3f4f6;
        }

        .gift-card-errors .error-message {
            flex: 1;
            font-size: 12px;
            color: #6b7280;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .header {
                padding: 0 15px;
            }

            .header-left h2 {
                font-size: 20px;
            }

            .main-content {
                padding: 20px 15px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .tasks-grid {
                grid-template-columns: 1fr;
            }

            .header-stats {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* IP池管理页面样式 */
        .status-card {
            height: 100%;
        }

        .status-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
        }

        .status-icon {
            font-size: 28px;
            margin-right: 15px;
            width: 40px;
            text-align: center;
        }

        .status-content {
            flex: 1;
        }

        .status-title {
            font-size: 12px;
            color: #909399;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 18px;
            font-weight: 600;
            color: #303133;
            margin-bottom: 2px;
        }

        .status-desc {
            font-size: 11px;
            color: #909399;
        }

        .form-hint {
            margin-top: 5px;
        }

        .form-hint span {
            font-size: 12px;
            color: #909399;
        }

        /* 代理状态标签样式 */
        .el-tag.el-tag--success {
            background-color: #f0f9ff;
            border-color: #67c23a;
            color: #67c23a;
        }

        .el-tag.el-tag--warning {
            background-color: #fdf6ec;
            border-color: #e6a23c;
            color: #e6a23c;
        }

        .el-tag.el-tag--danger {
            background-color: #fef0f0;
            border-color: #f56c6c;
            color: #f56c6c;
        }

        .el-tag.el-tag--info {
            background-color: #f4f4f5;
            border-color: #909399;
            color: #909399;
        }

        /* 响应式布局 */
        @media (max-width: 768px) {
            .status-card .el-col {
                margin-bottom: 10px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-actions {
                margin-top: 10px;
                width: 100%;
            }
            
            .header-actions .el-button {
                margin-bottom: 5px;
            }
        }
    </style>
</body>
</html>