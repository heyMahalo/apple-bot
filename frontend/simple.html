<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Bot System</title>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus CDN -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus"></script>
    <!-- Element Plus Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <!-- Socket.IO CDN -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Axios CDN -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Day.js CDN -->
    <script src="https://unpkg.com/dayjs"></script>
</head>
<body>
    <div id="app">
        <el-container style="height: 100vh;">
            <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
            <el-header class="header">
                <div class="header-left">
                    <h2>üçé Apple Bot System</h2>
                </div>
                <div class="header-right">
                    <el-badge :value="systemStatus.active_tasks" type="primary" class="status-badge">
                        <el-button 
                            :type="isConnected ? 'success' : 'danger'" 
                            size="small"
                        >
                            {{ isConnected ? 'Â∑≤ËøûÊé•' : 'Êú™ËøûÊé•' }}
                        </el-button>
                    </el-badge>
                    
                    <el-button 
                        type="primary" 
                        @click="showCreateDialog = true"
                    >
                        ÂàõÂª∫‰ªªÂä°
                    </el-button>
                </div>
            </el-header>

            <el-container>
                <!-- ‰æßËæπÊ†è -->
                <el-aside width="200px" class="sidebar">
                    <el-menu default-active="tasks" class="menu" @select="currentView = $event">
                        <el-menu-item index="tasks">
                            <span>‰ªªÂä°ÂàóË°®</span>
                        </el-menu-item>
                        <el-menu-item index="accounts">
                            <span>Ë¥¶Âè∑ÁÆ°ÁêÜ</span>
                        </el-menu-item>
                        <el-menu-item index="system">
                            <span>Á≥ªÁªüÁä∂ÊÄÅ</span>
                        </el-menu-item>
                    </el-menu>
                </el-aside>

                <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
                <el-main class="main-content">
                    <!-- ‰ªªÂä°ÂàóË°®ËßÜÂõæ -->
                    <div v-if="currentView === 'tasks'">
                        <h3>‰ªªÂä°ÂàóË°® ({{ tasks.length }})</h3>
                        <el-table :data="tasks" style="width: 100%">
                            <el-table-column prop="config.name" label="‰ªªÂä°ÂêçÁß∞" min-width="200" />
                            <el-table-column label="Áä∂ÊÄÅ" width="120">
                                <template #default="scope">
                                    <el-tag :type="getStatusType(scope.row.status)">
                                        {{ getStatusText(scope.row.status) }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="ËøõÂ∫¶" width="150">
                                <template #default="scope">
                                    <el-progress :percentage="scope.row.progress" />
                                </template>
                            </el-table-column>
                            <el-table-column label="Êìç‰Ωú" width="200">
                                <template #default="scope">
                                    <el-button 
                                        v-if="scope.row.status === 'pending'"
                                        type="primary" 
                                        size="small"
                                        @click="startTask(scope.row.id)"
                                    >
                                        ÂêØÂä®
                                    </el-button>
                                    <el-button 
                                        v-if="scope.row.status === 'running'"
                                        type="warning" 
                                        size="small"
                                        @click="cancelTask(scope.row.id)"
                                    >
                                        ÂèñÊ∂à
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>

                    <!-- Ë¥¶Âè∑ÁÆ°ÁêÜËßÜÂõæ -->
                    <div v-if="currentView === 'accounts'">
                        <div class="page-header">
                            <h3>Ë¥¶Âè∑ÁÆ°ÁêÜ</h3>
                            <el-button type="primary" @click="showAccountDialog = true">
                                Ê∑ªÂä†Ë¥¶Âè∑
                            </el-button>
                        </div>

                        <el-table :data="accounts" style="width: 100%" v-loading="accountsLoading">
                            <el-table-column prop="id" label="ID" width="80" />
                            <el-table-column prop="email" label="ÈÇÆÁÆ±" min-width="200" />
                            <el-table-column prop="phone_number" label="ÁîµËØùÂè∑Á†Å" width="180">
                                <template #default="scope">
                                    {{ scope.row.phone_number || '07700900000' }}
                                </template>
                            </el-table-column>
                            <el-table-column prop="created_at" label="ÂàõÂª∫Êó∂Èó¥" width="180">
                                <template #default="scope">
                                    {{ formatDate(scope.row.created_at) }}
                                </template>
                            </el-table-column>
                            <el-table-column prop="is_active" label="Áä∂ÊÄÅ" width="100">
                                <template #default="scope">
                                    <el-tag :type="scope.row.is_active ? 'success' : 'danger'">
                                        {{ scope.row.is_active ? 'Ê¥ªË∑É' : 'Á¶ÅÁî®' }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="Êìç‰Ωú" width="200">
                                <template #default="scope">
                                    <el-button size="small" @click="editAccount(scope.row)">
                                        ÁºñËæë
                                    </el-button>
                                    <el-button size="small" type="danger" @click="deleteAccount(scope.row)">
                                        Âà†Èô§
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>

                    <!-- Á≥ªÁªüÁä∂ÊÄÅËßÜÂõæ -->
                    <div v-if="currentView === 'system'">
                        <h3>Á≥ªÁªüÁä∂ÊÄÅ</h3>
                        <el-descriptions :column="2" border>
                            <el-descriptions-item label="ÊÄª‰ªªÂä°Êï∞">{{ systemStatus.total_tasks || 0 }}</el-descriptions-item>
                            <el-descriptions-item label="Ê¥ªË∑É‰ªªÂä°">{{ systemStatus.active_tasks || 0 }}</el-descriptions-item>
                            <el-descriptions-item label="ÊúÄÂ§ßÂπ∂Âèë">{{ systemStatus.max_concurrent || 3 }}</el-descriptions-item>
                            <el-descriptions-item label="ËøûÊé•Áä∂ÊÄÅ">
                                <el-tag :type="isConnected ? 'success' : 'danger'">
                                    {{ isConnected ? 'Â∑≤ËøûÊé•' : 'Êú™ËøûÊé•' }}
                                </el-tag>
                            </el-descriptions-item>
                        </el-descriptions>
                    </div>
                </el-main>
            </el-container>
        </el-container>

        <!-- ÂàõÂª∫‰ªªÂä°ÂØπËØùÊ°Ü -->
        <el-dialog v-model="showCreateDialog" title="ÂàõÂª∫Êñ∞‰ªªÂä°" width="600px">
            <el-form :model="taskForm" label-width="120px">
                <el-form-item label="‰ªªÂä°ÂêçÁß∞">
                    <el-input v-model="taskForm.name" placeholder="ËØ∑ËæìÂÖ•‰ªªÂä°ÂêçÁß∞" />
                </el-form-item>
                <el-form-item label="‰∫ßÂìÅURL">
                    <el-input v-model="taskForm.url" placeholder="Apple‰∫ßÂìÅÈ°µÈù¢URL" type="textarea" />
                </el-form-item>
                <el-form-item label="‰∫ßÂìÅÂûãÂè∑">
                    <el-select v-model="taskForm.model" placeholder="ÈÄâÊã©ÂûãÂè∑" style="width: 100%">
                        <el-option label="iPhone 16 Pro" value="iPhone 16 Pro" />
                        <el-option label="iPhone 16 Pro Max" value="iPhone 16 Pro Max" />
                    </el-select>
                </el-form-item>
                <el-form-item label="Â≠òÂÇ®ÂÆπÈáè">
                    <el-select v-model="taskForm.storage" placeholder="ÈÄâÊã©ÂÆπÈáè" style="width: 100%">
                        <el-option label="256GB" value="256GB" />
                        <el-option label="512GB" value="512GB" />
                        <el-option label="1TB" value="1TB" />
                    </el-select>
                </el-form-item>
                <el-form-item label="È¢úËâ≤">
                    <el-select v-model="taskForm.finish" placeholder="ÈÄâÊã©È¢úËâ≤" style="width: 100%">
                        <el-option label="Natural Titanium" value="Natural Titanium" />
                        <el-option label="Blue Titanium" value="Blue Titanium" />
                        <el-option label="White Titanium" value="White Titanium" />
                        <el-option label="Black Titanium" value="Black Titanium" />
                    </el-select>
                </el-form-item>
            </el-form>
            
            <template #footer>
                <el-button @click="showCreateDialog = false">ÂèñÊ∂à</el-button>
                <el-button type="primary" @click="createTask">ÂàõÂª∫‰ªªÂä°</el-button>
            </template>
        </el-dialog>

        <!-- Ë¥¶Âè∑ÁÆ°ÁêÜÂØπËØùÊ°Ü -->
        <el-dialog v-model="showAccountDialog" :title="editingAccount ? 'ÁºñËæëË¥¶Âè∑' : 'Ê∑ªÂä†Ë¥¶Âè∑'" width="500px">
            <el-form :model="accountForm" label-width="100px">
                <el-form-item label="ÈÇÆÁÆ±">
                    <el-input v-model="accountForm.email" placeholder="ËØ∑ËæìÂÖ•Apple IDÈÇÆÁÆ±" type="email" />
                </el-form-item>
                <el-form-item label="ÂØÜÁ†Å">
                    <el-input v-model="accountForm.password" placeholder="ËØ∑ËæìÂÖ•Apple IDÂØÜÁ†Å" type="password" show-password />
                </el-form-item>
                <el-form-item label="ÁîµËØùÂè∑Á†Å">
                    <el-input v-model="accountForm.phone_number" placeholder="ËØ∑ËæìÂÖ•Ëã±ÂõΩÊâãÊú∫Âè∑Á†Å (Â¶Ç: 07700900000)" />
                    <div style="margin-top: 5px; text-align: right;">
                        <el-text size="small" type="info">ËØ∑ËæìÂÖ•Ëã±ÂõΩÊâãÊú∫Âè∑Á†ÅÊ†ºÂºèÔºå‰ª•07ÂºÄÂ§¥ÁöÑ11‰ΩçÊï∞Â≠ó</el-text>
                    </div>
                </el-form-item>
            </el-form>

            <template #footer>
                <el-button @click="cancelAccountEdit">ÂèñÊ∂à</el-button>
                <el-button type="primary" @click="saveAccount" :loading="accountSaving">
                    {{ editingAccount ? 'Êõ¥Êñ∞' : 'ÂàõÂª∫' }}
                </el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue
        const { ElMessage } = ElementPlus

        createApp({
            data() {
                return {
                    socket: null,
                    isConnected: false,
                    currentView: 'tasks',
                    showCreateDialog: false,
                    tasks: [],
                    systemStatus: {
                        total_tasks: 0,
                        active_tasks: 0,
                        max_concurrent: 3
                    },
                    taskForm: {
                        name: '',
                        url: '',
                        model: '',
                        storage: '',
                        finish: ''
                    },
                    // Ë¥¶Âè∑ÁÆ°ÁêÜÁõ∏ÂÖ≥
                    accounts: [],
                    accountsLoading: false,
                    showAccountDialog: false,
                    editingAccount: null,
                    accountSaving: false,
                    accountForm: {
                        email: '',
                        password: '',
                        phone_number: '07700900000'
                    }
                }
            },
            mounted() {
                this.initWebSocket()
                this.fetchAccounts()
            },
            methods: {
                initWebSocket() {
                    this.socket = io('http://localhost:5001')
                    
                    this.socket.on('connect', () => {
                        this.isConnected = true
                        ElMessage.success('WebSocketËøûÊé•ÊàêÂäü')
                    })
                    
                    this.socket.on('disconnect', () => {
                        this.isConnected = false
                        ElMessage.warning('WebSocketËøûÊé•Êñ≠ÂºÄ')
                    })
                    
                    this.socket.on('initial_tasks', (data) => {
                        this.tasks = data.tasks || []
                    })
                    
                    this.socket.on('task_created', (task) => {
                        this.tasks.push(task)
                        ElMessage.success('‰ªªÂä°ÂàõÂª∫ÊàêÂäü')
                    })
                    
                    this.socket.on('task_update', (task) => {
                        const index = this.tasks.findIndex(t => t.id === task.id)
                        if (index >= 0) {
                            this.tasks[index] = task
                        }
                    })
                    
                    this.socket.on('system_status', (status) => {
                        this.systemStatus = status
                    })
                    
                    // ËØ∑Ê±ÇÂàùÂßãÊï∞ÊçÆ
                    setTimeout(() => {
                        this.socket.emit('get_tasks')
                        this.socket.emit('get_system_status')
                    }, 1000)
                },
                
                createTask() {
                    const taskData = {
                        name: this.taskForm.name,
                        url: this.taskForm.url,
                        product_config: {
                            model: this.taskForm.model,
                            storage: this.taskForm.storage,
                            finish: this.taskForm.finish,
                            trade_in: 'No trade-in',
                            payment: 'Buy',
                            apple_care: 'No AppleCare+ Coverage'
                        },
                        enabled: true,
                        priority: 2,
                        use_proxy: false,
                        gift_cards: []
                    }
                    
                    this.socket.emit('create_task', taskData)
                    this.showCreateDialog = false
                    
                    // ÈáçÁΩÆË°®Âçï
                    this.taskForm = {
                        name: '',
                        url: '',
                        model: '',
                        storage: '',
                        finish: ''
                    }
                },
                
                startTask(taskId) {
                    this.socket.emit('start_task', { task_id: taskId })
                    ElMessage.success('‰ªªÂä°ÂêØÂä®ËØ∑Ê±ÇÂ∑≤ÂèëÈÄÅ')
                },
                
                cancelTask(taskId) {
                    this.socket.emit('cancel_task', { task_id: taskId })
                    ElMessage.warning('‰ªªÂä°ÂèñÊ∂àËØ∑Ê±ÇÂ∑≤ÂèëÈÄÅ')
                },
                
                getStatusType(status) {
                    const statusMap = {
                        'pending': '',
                        'running': 'warning',
                        'completed': 'success',
                        'failed': 'danger',
                        'cancelled': 'info'
                    }
                    return statusMap[status] || ''
                },
                
                getStatusText(status) {
                    const statusMap = {
                        'pending': 'Á≠âÂæÖ‰∏≠',
                        'running': 'ËøêË°å‰∏≠',
                        'completed': 'Â∑≤ÂÆåÊàê',
                        'failed': 'Â§±Ë¥•',
                        'cancelled': 'Â∑≤ÂèñÊ∂à'
                    }
                    return statusMap[status] || status
                },

                // Ë¥¶Âè∑ÁÆ°ÁêÜÊñπÊ≥ï
                async fetchAccounts() {
                    this.accountsLoading = true
                    try {
                        const response = await axios.get('http://localhost:5001/api/accounts')
                        console.log('Ëé∑ÂèñÂà∞ÁöÑË¥¶Âè∑Êï∞ÊçÆ:', response.data)
                        this.accounts = response.data.map(account => ({
                            ...account,
                            phone_number: account.phone_number || '07700900000'
                        }))
                    } catch (error) {
                        console.error('Ëé∑ÂèñË¥¶Âè∑ÂàóË°®Â§±Ë¥•:', error)
                        ElMessage.error('Ëé∑ÂèñË¥¶Âè∑ÂàóË°®Â§±Ë¥•: ' + (error.response?.data?.error || error.message))
                    } finally {
                        this.accountsLoading = false
                    }
                },

                formatDate(dateString) {
                    if (!dateString) return '-'
                    return new Date(dateString).toLocaleString('zh-CN')
                },

                editAccount(account) {
                    this.editingAccount = account
                    this.accountForm.email = account.email
                    this.accountForm.password = ''
                    this.accountForm.phone_number = account.phone_number || '07700900000'
                    this.showAccountDialog = true
                },

                async saveAccount() {
                    if (!this.accountForm.email || !this.accountForm.password) {
                        ElMessage.error('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑË¥¶Âè∑‰ø°ÊÅØ')
                        return
                    }

                    // È™åËØÅÁîµËØùÂè∑Á†ÅÊ†ºÂºè
                    const phoneRegex = /^07\d{9}$/
                    if (!phoneRegex.test(this.accountForm.phone_number)) {
                        ElMessage.error('ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑËã±ÂõΩÊâãÊú∫Âè∑Á†ÅÊ†ºÂºè (07xxxxxxxxx)')
                        return
                    }

                    this.accountSaving = true
                    try {
                        if (this.editingAccount) {
                            await axios.put(`http://localhost:5001/api/accounts/${this.editingAccount.id}`, this.accountForm)
                            ElMessage.success('Ë¥¶Âè∑Êõ¥Êñ∞ÊàêÂäü')
                        } else {
                            await axios.post('http://localhost:5001/api/accounts', this.accountForm)
                            ElMessage.success('Ë¥¶Âè∑ÂàõÂª∫ÊàêÂäü')
                        }

                        this.showAccountDialog = false
                        await this.fetchAccounts()
                        this.resetAccountForm()

                    } catch (error) {
                        ElMessage.error('‰øùÂ≠òÂ§±Ë¥•: ' + (error.response?.data?.error || error.message))
                    } finally {
                        this.accountSaving = false
                    }
                },

                async deleteAccount(account) {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            `Á°ÆÂÆöË¶ÅÂà†Èô§Ë¥¶Âè∑ "${account.email}" ÂêóÔºü`,
                            'Á°ÆËÆ§Âà†Èô§',
                            {
                                confirmButtonText: 'Á°ÆÂÆö',
                                cancelButtonText: 'ÂèñÊ∂à',
                                type: 'warning',
                            }
                        )

                        await axios.delete(`http://localhost:5001/api/accounts/${account.id}`)
                        ElMessage.success('Ë¥¶Âè∑Âà†Èô§ÊàêÂäü')
                        await this.fetchAccounts()

                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('Âà†Èô§Â§±Ë¥•: ' + (error.response?.data?.error || error.message))
                        }
                    }
                },

                cancelAccountEdit() {
                    this.showAccountDialog = false
                    this.resetAccountForm()
                },

                resetAccountForm() {
                    this.editingAccount = null
                    this.accountForm.email = ''
                    this.accountForm.password = ''
                    this.accountForm.phone_number = '07700900000'
                }
            }
        }).use(ElementPlus).mount('#app')
    </script>

    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 0 20px;
        }
        
        .header-left h2 {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .sidebar {
            background-color: #f8f9fa;
            border-right: 1px solid #e9ecef;
        }
        
        .menu {
            border: none;
            background-color: transparent;
        }
        
        .main-content {
            padding: 20px;
            background-color: #ffffff;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .page-header h3 {
            margin: 0;
            color: #303133;
        }
    </style>
</body>
</html>