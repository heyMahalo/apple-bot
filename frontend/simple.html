<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Bot System</title>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus CDN -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus"></script>
    <!-- Element Plus Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <!-- Socket.IO CDN -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Axios CDN -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Day.js CDN -->
    <script src="https://unpkg.com/dayjs"></script>
</head>
<body>
    <div id="app">
        <el-container style="height: 100vh;">
            <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
            <el-header class="header">
                <div class="header-left">
                    <h2>ğŸ Apple Bot System</h2>
                </div>
                <div class="header-right">
                    <el-badge :value="systemStatus.active_tasks" type="primary" class="status-badge">
                        <el-button 
                            :type="isConnected ? 'success' : 'danger'" 
                            size="small"
                        >
                            {{ isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥' }}
                        </el-button>
                    </el-badge>
                    
                    <el-button 
                        type="primary" 
                        @click="showCreateDialog = true"
                    >
                        åˆ›å»ºä»»åŠ¡
                    </el-button>
                </div>
            </el-header>

            <el-container>
                <!-- ä¾§è¾¹æ  -->
                <el-aside width="200px" class="sidebar">
                    <el-menu default-active="tasks" class="menu" @select="currentView = $event">
                        <el-menu-item index="tasks">
                            <span>ä»»åŠ¡åˆ—è¡¨</span>
                        </el-menu-item>
                        <el-menu-item index="accounts">
                            <span>è´¦å·ç®¡ç†</span>
                        </el-menu-item>
                        <el-menu-item index="system">
                            <span>ç³»ç»ŸçŠ¶æ€</span>
                        </el-menu-item>
                    </el-menu>
                </el-aside>

                <!-- ä¸»å†…å®¹åŒº -->
                <el-main class="main-content">
                    <!-- ä»»åŠ¡åˆ—è¡¨è§†å›¾ -->
                    <div v-if="currentView === 'tasks'">
                        <h3>ä»»åŠ¡åˆ—è¡¨ ({{ tasks.length }})</h3>
                        <el-table :data="tasks" style="width: 100%">
                            <el-table-column prop="config.name" label="ä»»åŠ¡åç§°" min-width="200" />
                            <el-table-column label="çŠ¶æ€" width="120">
                                <template #default="scope">
                                    <el-tag :type="getStatusType(scope.row.status)">
                                        {{ getStatusText(scope.row.status) }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="è¿›åº¦" width="150">
                                <template #default="scope">
                                    <el-progress :percentage="scope.row.progress" />
                                </template>
                            </el-table-column>
                            <el-table-column label="æ“ä½œ" width="200">
                                <template #default="scope">
                                    <el-button 
                                        v-if="scope.row.status === 'pending'"
                                        type="primary" 
                                        size="small"
                                        @click="startTask(scope.row.id)"
                                    >
                                        å¯åŠ¨
                                    </el-button>
                                    <el-button 
                                        v-if="scope.row.status === 'running'"
                                        type="warning" 
                                        size="small"
                                        @click="cancelTask(scope.row.id)"
                                    >
                                        å–æ¶ˆ
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>

                    <!-- è´¦å·ç®¡ç†è§†å›¾ -->
                    <div v-if="currentView === 'accounts'">
                        <div class="page-header">
                            <h3>è´¦å·ç®¡ç†</h3>
                            <el-button type="primary" @click="showAccountDialog = true">
                                æ·»åŠ è´¦å·
                            </el-button>
                        </div>

                        <el-table :data="accounts" style="width: 100%" v-loading="accountsLoading">
                            <el-table-column prop="id" label="ID" width="80" />
                            <el-table-column prop="email" label="é‚®ç®±" min-width="200" />
                            <el-table-column prop="phone_number" label="ç”µè¯å·ç " width="180">
                                <template #default="scope">
                                    {{ scope.row.phone_number || '07700900000' }}
                                </template>
                            </el-table-column>
                            <el-table-column prop="created_at" label="åˆ›å»ºæ—¶é—´" width="180">
                                <template #default="scope">
                                    {{ formatDate(scope.row.created_at) }}
                                </template>
                            </el-table-column>
                            <el-table-column prop="is_active" label="çŠ¶æ€" width="100">
                                <template #default="scope">
                                    <el-tag :type="scope.row.is_active ? 'success' : 'danger'">
                                        {{ scope.row.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨' }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="æ“ä½œ" width="200">
                                <template #default="scope">
                                    <el-button size="small" @click="editAccount(scope.row)">
                                        ç¼–è¾‘
                                    </el-button>
                                    <el-button size="small" type="danger" @click="deleteAccount(scope.row)">
                                        åˆ é™¤
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>

                    <!-- ç³»ç»ŸçŠ¶æ€è§†å›¾ -->
                    <div v-if="currentView === 'system'">
                        <h3>ç³»ç»ŸçŠ¶æ€</h3>
                        <el-descriptions :column="2" border>
                            <el-descriptions-item label="æ€»ä»»åŠ¡æ•°">{{ systemStatus.total_tasks || 0 }}</el-descriptions-item>
                            <el-descriptions-item label="æ´»è·ƒä»»åŠ¡">{{ systemStatus.active_tasks || 0 }}</el-descriptions-item>
                            <el-descriptions-item label="æœ€å¤§å¹¶å‘">{{ systemStatus.max_concurrent || 3 }}</el-descriptions-item>
                            <el-descriptions-item label="è¿æ¥çŠ¶æ€">
                                <el-tag :type="isConnected ? 'success' : 'danger'">
                                    {{ isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥' }}
                                </el-tag>
                            </el-descriptions-item>
                        </el-descriptions>
                    </div>
                </el-main>
            </el-container>
        </el-container>

        <!-- åˆ›å»ºä»»åŠ¡å¯¹è¯æ¡† -->
        <el-dialog v-model="showCreateDialog" title="åˆ›å»ºæ–°ä»»åŠ¡" width="600px">
            <el-form :model="taskForm" label-width="120px">
                <el-form-item label="ä»»åŠ¡åç§°">
                    <el-input v-model="taskForm.name" placeholder="è¯·è¾“å…¥ä»»åŠ¡åç§°" />
                </el-form-item>
                <el-form-item label="äº§å“URL">
                    <el-input v-model="taskForm.url" placeholder="Appleäº§å“é¡µé¢URL" type="textarea" />
                </el-form-item>
                <el-form-item label="äº§å“å‹å·">
                    <el-select v-model="taskForm.model" placeholder="é€‰æ‹©å‹å·" style="width: 100%">
                        <el-option label="iPhone 16 Pro" value="iPhone 16 Pro" />
                        <el-option label="iPhone 16 Pro Max" value="iPhone 16 Pro Max" />
                    </el-select>
                </el-form-item>
                <el-form-item label="å­˜å‚¨å®¹é‡">
                    <el-select v-model="taskForm.storage" placeholder="é€‰æ‹©å®¹é‡" style="width: 100%">
                        <el-option label="256GB" value="256GB" />
                        <el-option label="512GB" value="512GB" />
                        <el-option label="1TB" value="1TB" />
                    </el-select>
                </el-form-item>
                <el-form-item label="é¢œè‰²">
                    <el-select v-model="taskForm.finish" placeholder="é€‰æ‹©é¢œè‰²" style="width: 100%">
                        <el-option label="Natural Titanium" value="Natural Titanium" />
                        <el-option label="Blue Titanium" value="Blue Titanium" />
                        <el-option label="White Titanium" value="White Titanium" />
                        <el-option label="Black Titanium" value="Black Titanium" />
                    </el-select>
                </el-form-item>
            </el-form>
            
            <template #footer>
                <el-button @click="showCreateDialog = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="createTask">åˆ›å»ºä»»åŠ¡</el-button>
            </template>
        </el-dialog>

        <!-- è´¦å·ç®¡ç†å¯¹è¯æ¡† -->
        <el-dialog v-model="showAccountDialog" :title="editingAccount ? 'ç¼–è¾‘è´¦å·' : 'æ·»åŠ è´¦å·'" width="500px">
            <el-form :model="accountForm" label-width="100px">
                <el-form-item label="é‚®ç®±">
                    <el-input v-model="accountForm.email" placeholder="è¯·è¾“å…¥Apple IDé‚®ç®±" type="email" />
                </el-form-item>
                <el-form-item label="å¯†ç ">
                    <el-input v-model="accountForm.password" placeholder="è¯·è¾“å…¥Apple IDå¯†ç " type="password" show-password />
                </el-form-item>
                <el-form-item label="ç”µè¯å·ç ">
                    <el-input v-model="accountForm.phone_number" placeholder="è¯·è¾“å…¥è‹±å›½æ‰‹æœºå·ç  (å¦‚: 07700900000)" />
                    <div style="margin-top: 5px; text-align: right;">
                        <el-text size="small" type="info">è¯·è¾“å…¥è‹±å›½æ‰‹æœºå·ç æ ¼å¼ï¼Œä»¥07å¼€å¤´çš„11ä½æ•°å­—</el-text>
                    </div>
                </el-form-item>
            </el-form>

            <template #footer>
                <el-button @click="cancelAccountEdit">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="saveAccount" :loading="accountSaving">
                    {{ editingAccount ? 'æ›´æ–°' : 'åˆ›å»º' }}
                </el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue
        const { ElMessage } = ElementPlus

        createApp({
            data() {
                return {
                    socket: null,
                    isConnected: false,
                    currentView: 'tasks',
                    showCreateDialog: false,
                    tasks: [],
                    systemStatus: {
                        total_tasks: 0,
                        active_tasks: 0,
                        max_concurrent: 3
                    },
                    taskForm: {
                        name: '',
                        url: '',
                        model: '',
                        storage: '',
                        finish: ''
                    },
                    // è´¦å·ç®¡ç†ç›¸å…³
                    accounts: [],
                    accountsLoading: false,
                    showAccountDialog: false,
                    editingAccount: null,
                    accountSaving: false,
                    accountForm: {
                        email: '',
                        password: '',
                        phone_number: '07700900000'
                    }
                }
            },
            mounted() {
                this.initWebSocket()
                this.fetchAccounts()
            },
            methods: {
                initWebSocket() {
                    this.socket = io('http://localhost:5001')
                    
                    this.socket.on('connect', () => {
                        this.isConnected = true
                        ElMessage.success('WebSocketè¿æ¥æˆåŠŸ')
                    })
                    
                    this.socket.on('disconnect', () => {
                        this.isConnected = false
                        ElMessage.warning('WebSocketè¿æ¥æ–­å¼€')
                    })
                    
                    this.socket.on('initial_tasks', (data) => {
                        this.tasks = data.tasks || []
                    })
                    
                    this.socket.on('task_created', (task) => {
                        this.tasks.push(task)
                        ElMessage.success('ä»»åŠ¡åˆ›å»ºæˆåŠŸ')
                    })
                    
                    this.socket.on('task_update', (task) => {
                        const index = this.tasks.findIndex(t => t.id === task.id)
                        if (index >= 0) {
                            this.tasks[index] = task
                        }
                    })
                    
                    this.socket.on('system_status', (status) => {
                        this.systemStatus = status
                    })
                    
                    // è¯·æ±‚åˆå§‹æ•°æ®
                    setTimeout(() => {
                        this.socket.emit('get_tasks')
                        this.socket.emit('get_system_status')
                    }, 1000)
                },
                
                createTask() {
                    const taskData = {
                        name: this.taskForm.name,
                        url: this.taskForm.url,
                        product_config: {
                            model: this.taskForm.model,
                            storage: this.taskForm.storage,
                            finish: this.taskForm.finish,
                            trade_in: 'No trade-in',
                            payment: 'Buy',
                            apple_care: 'No AppleCare+ Coverage'
                        },
                        enabled: true,
                        priority: 2,
                        use_proxy: false,
                        gift_cards: []
                    }
                    
                    this.socket.emit('create_task', taskData)
                    this.showCreateDialog = false
                    
                    // é‡ç½®è¡¨å•
                    this.taskForm = {
                        name: '',
                        url: '',
                        model: '',
                        storage: '',
                        finish: ''
                    }
                },
                
                startTask(taskId) {
                    this.socket.emit('start_task', { task_id: taskId })
                    ElMessage.success('ä»»åŠ¡å¯åŠ¨è¯·æ±‚å·²å‘é€')
                },
                
                cancelTask(taskId) {
                    this.socket.emit('cancel_task', { task_id: taskId })
                    ElMessage.warning('ä»»åŠ¡å–æ¶ˆè¯·æ±‚å·²å‘é€')
                },
                
                getStatusType(status) {
                    const statusMap = {
                        'pending': '',
                        'running': 'warning',
                        'completed': 'success',
                        'failed': 'danger',
                        'cancelled': 'info'
                    }
                    return statusMap[status] || ''
                },
                
                getStatusText(status) {
                    const statusMap = {
                        'pending': 'ç­‰å¾…ä¸­',
                        'running': 'è¿è¡Œä¸­',
                        'completed': 'å·²å®Œæˆ',
                        'failed': 'å¤±è´¥',
                        'cancelled': 'å·²å–æ¶ˆ'
                    }
                    return statusMap[status] || status
                },

                // è´¦å·ç®¡ç†æ–¹æ³•
                async fetchAccounts() {
                    this.accountsLoading = true
                    try {
                        const response = await axios.get('http://localhost:5001/api/accounts')
                        console.log('è·å–åˆ°çš„è´¦å·æ•°æ®:', response.data)
                        this.accounts = response.data.map(account => ({
                            ...account,
                            phone_number: account.phone_number || '07700900000'
                        }))
                    } catch (error) {
                        console.error('è·å–è´¦å·åˆ—è¡¨å¤±è´¥:', error)
                        ElMessage.error('è·å–è´¦å·åˆ—è¡¨å¤±è´¥: ' + (error.response?.data?.error || error.message))
                    } finally {
                        this.accountsLoading = false
                    }
                },

                formatDate(dateString) {
                    if (!dateString) return '-'
                    return new Date(dateString).toLocaleString('zh-CN')
                },

                editAccount(account) {
                    this.editingAccount = account
                    this.accountForm.email = account.email
                    this.accountForm.password = ''
                    this.accountForm.phone_number = account.phone_number || '07700900000'
                    this.showAccountDialog = true
                },

                async saveAccount() {
                    if (!this.accountForm.email || !this.accountForm.password) {
                        ElMessage.error('è¯·å¡«å†™å®Œæ•´çš„è´¦å·ä¿¡æ¯')
                        return
                    }

                    // éªŒè¯ç”µè¯å·ç æ ¼å¼
                    const phoneRegex = /^07\d{9}$/
                    if (!phoneRegex.test(this.accountForm.phone_number)) {
                        ElMessage.error('è¯·è¾“å…¥æ­£ç¡®çš„è‹±å›½æ‰‹æœºå·ç æ ¼å¼ (07xxxxxxxxx)')
                        return
                    }

                    this.accountSaving = true
                    try {
                        if (this.editingAccount) {
                            await axios.put(`http://localhost:5001/api/accounts/${this.editingAccount.id}`, this.accountForm)
                            ElMessage.success('è´¦å·æ›´æ–°æˆåŠŸ')
                        } else {
                            await axios.post('http://localhost:5001/api/accounts', this.accountForm)
                            ElMessage.success('è´¦å·åˆ›å»ºæˆåŠŸ')
                        }

                        this.showAccountDialog = false
                        await this.fetchAccounts()
                        this.resetAccountForm()

                    } catch (error) {
                        ElMessage.error('ä¿å­˜å¤±è´¥: ' + (error.response?.data?.error || error.message))
                    } finally {
                        this.accountSaving = false
                    }
                },

                async deleteAccount(account) {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            `ç¡®å®šè¦åˆ é™¤è´¦å· "${account.email}" å—ï¼Ÿ`,
                            'ç¡®è®¤åˆ é™¤',
                            {
                                confirmButtonText: 'ç¡®å®š',
                                cancelButtonText: 'å–æ¶ˆ',
                                type: 'warning',
                            }
                        )

                        await axios.delete(`http://localhost:5001/api/accounts/${account.id}`)
                        ElMessage.success('è´¦å·åˆ é™¤æˆåŠŸ')
                        await this.fetchAccounts()

                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('åˆ é™¤å¤±è´¥: ' + (error.response?.data?.error || error.message))
                        }
                    }
                },

                cancelAccountEdit() {
                    this.showAccountDialog = false
                    this.resetAccountForm()
                },

                resetAccountForm() {
                    this.editingAccount = null
                    this.accountForm.email = ''
                    this.accountForm.password = ''
                    this.accountForm.phone_number = '07700900000'
                }
            }
        }).use(ElementPlus).mount('#app')
    </script>

    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 0 20px;
        }
        
        .header-left h2 {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .sidebar {
            background-color: #f8f9fa;
            border-right: 1px solid #e9ecef;
        }
        
        .menu {
            border: none;
            background-color: transparent;
        }
        
        .main-content {
            padding: 20px;
            background-color: #ffffff;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .page-header h3 {
            margin: 0;
            color: #303133;
        }
    </style>
</body>
</html>