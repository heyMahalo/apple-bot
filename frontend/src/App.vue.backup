<template>
  <div id="app">
    <el-container style="height: 100vh;">
      <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
      <el-header class="header">
        <div class="header-left">
          <h2>ğŸ Apple Bot System</h2>
        </div>
        <div class="header-right">
          <div class="status-indicators">
            <el-badge :value="pendingTasks.length" type="info" :hidden="pendingTasks.length === 0">
              <el-button size="small" disabled>
                â³ ç­‰å¾…
              </el-button>
            </el-badge>

            <el-badge :value="runningTasks.length" type="warning" :hidden="runningTasks.length === 0">
              <el-button size="small" disabled>
                ğŸƒ è¿è¡Œ
              </el-button>
            </el-badge>

            <el-badge :value="systemStatus.active_tasks" type="primary" class="status-badge">
              <el-button
                :type="isConnected ? 'success' : 'danger'"
                size="small"
                circle
              >
                {{ isConnected ? 'âœ“' : 'âœ—' }}
              </el-button>
            </el-badge>

            <!-- ğŸš€ å®æ—¶ç›‘æ§çŠ¶æ€ -->
            <div class="sync-status" v-if="isConnected">
              <span class="sync-indicator">ğŸ”„</span>
              <span class="sync-text">WebSocket</span>
            </div>

            <!-- æ™ºèƒ½è½®è¯¢çŠ¶æ€ -->
            <div class="polling-status" v-if="isRealTimeActive">
              <span class="polling-indicator">ğŸ“¡</span>
              <span class="polling-text">å®æ—¶ç›‘æ§</span>
            </div>

            <!-- æ´»è·ƒä»»åŠ¡æ•°é‡ -->
            <div class="active-tasks" v-if="getActiveTasks().length > 0">
              <span class="active-indicator">âš¡</span>
              <span class="active-text">{{ getActiveTasks().length }}æ´»è·ƒ</span>
            </div>
          </div>

          <el-button
            type="success"
            @click="startAllTasks"
            :disabled="!hasExecutableTasks"
            size="small"
          >
            ğŸš€ ä¸€é”®æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡
          </el-button>

          <el-button
            type="info"
            @click="manualRefresh"
            size="small"
            :loading="isRefreshing"
          >
            ğŸ”„ {{ isRefreshing ? 'åˆ·æ–°ä¸­...' : 'åˆ·æ–°' }}
          </el-button>

          <el-button type="primary" @click="openCreateDialog">
            åˆ›å»ºä»»åŠ¡
          </el-button>
        </div>
      </el-header>

      <el-container>
        <!-- ä¾§è¾¹æ  -->
        <el-aside width="220px" class="sidebar">
          <el-menu
            v-model:default-active="currentProduct"
            class="menu"
            @select="switchProduct"
            mode="vertical"
            :unique-opened="false"
          >
            <el-menu-item index="iphone">
              <span>ğŸ“± iPhone</span>
            </el-menu-item>
            <el-menu-item index="mac">
              <span>ğŸ’» Mac</span>
            </el-menu-item>
            <el-menu-item index="ipad">
              <span>ğŸ“± iPad</span>
            </el-menu-item>
            <el-menu-item index="watch">
              <span>âŒš Apple Watch</span>
            </el-menu-item>
            <el-divider style="margin: 10px 0;"></el-divider>
            <el-menu-item index="all-tasks">
              <span>ğŸ“‹ æ‰€æœ‰ä»»åŠ¡</span>
            </el-menu-item>
            <el-divider style="margin: 10px 0;"></el-divider>
            <el-menu-item index="accounts">
              <span>ğŸ‘¤ è´¦å·ç®¡ç†</span>
            </el-menu-item>
            <el-menu-item index="gift-cards">
              <span>ğŸ ç¤¼å“å¡ç®¡ç†</span>
            </el-menu-item>
            <el-menu-item index="ip-pool">
              <span>ğŸŒ IPæ± ç®¡ç†</span>
            </el-menu-item>
          </el-menu>
        </el-aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <el-main class="main-content">
          <!-- iPhone äº§å“é¡µé¢ -->
          <div v-if="currentProduct === 'iphone'" class="product-section">
            <div class="section-header">
              <h2>ğŸ“± iPhone è‡ªåŠ¨åŒ–ä»»åŠ¡</h2>
              <el-button type="primary" @click="openCreateDialog">
                åˆ›å»º iPhone ä»»åŠ¡
              </el-button>
            </div>

            <!-- ä»»åŠ¡ç»Ÿè®¡ -->
            <div class="stats-row">
              <el-card class="stat-card">
                <div class="stat-content">
                  <div class="stat-number">{{ getTasksByProduct('iphone').length }}</div>
                  <div class="stat-label">iPhoneä»»åŠ¡</div>
                </div>
              </el-card>
              <el-card class="stat-card">
                <div class="stat-content">
                  <div class="stat-number">{{ tasks.length }}</div>
                  <div class="stat-label">æ‰€æœ‰ä»»åŠ¡</div>
                </div>
              </el-card>
              <el-card class="stat-card">
                <div class="stat-content">
                  <div class="stat-number">{{ getTasksByProduct('iphone').filter(t => t.status === 'running').length }}</div>
                  <div class="stat-label">è¿è¡Œä¸­</div>
                </div>
              </el-card>
              <el-card class="stat-card">
                <div class="stat-content">
                  <div class="stat-number">{{ getTasksByProduct('iphone').filter(t => t.status === 'completed').length }}</div>
                  <div class="stat-label">å·²å®Œæˆ</div>
                </div>
              </el-card>
              <el-card class="stat-card">
                <div class="stat-content">
                  <div class="stat-number">{{ getTasksByProduct('iphone').filter(t => t.status === 'pending').length }}</div>
                  <div class="stat-label">ç­‰å¾…ä¸­</div>
                </div>
              </el-card>
            </div>

            <!-- ğŸš€ é¡µç­¾åˆ‡æ¢ -->
            <el-tabs v-model="activeTab" class="task-tabs" @tab-click="handleTabClick">
              <el-tab-pane label="ğŸ“± ä»»åŠ¡åˆ›å»º" name="create">
                <!-- åŸæœ‰çš„ä»»åŠ¡ç½‘æ ¼å†…å®¹ -->
                <div class="tab-content">
                  <!-- ä»»åŠ¡ç½‘æ ¼ -->
            <div v-if="getTasksByProduct('iphone').length > 0" class="tasks-grid">
              <el-card
                v-for="task in getTasksByProduct('iphone')"
                :key="task.id"
                class="task-card"
                shadow="hover"
              >
                <template #header>
                  <div class="card-header">
                    <span class="task-name">{{ task.config.name }}</span>
                    <el-tag :type="getStatusType(task.status)" size="small">
                      {{ getStatusText(task.status) }}
                    </el-tag>
                  </div>
                </template>

                <div class="task-details">
                  <p><strong>Apple ID:</strong> {{ task.config.account_config?.email || 'N/A' }}</p>
                  <p><strong>å‹å·:</strong> {{ task.config.product_config?.model || 'N/A' }}</p>
                  <p><strong>å­˜å‚¨:</strong> {{ task.config.product_config?.storage || 'N/A' }}</p>
                  <p><strong>é¢œè‰²:</strong> {{ task.config.product_config?.finish || 'N/A' }}</p>

                  <!-- å½“å‰æ­¥éª¤æ˜¾ç¤º -->
                  <div v-if="isTaskActive(task) && task.current_step" class="current-step">
                    <p><strong>å½“å‰æ­¥éª¤:</strong>
                      <el-tag :type="getStepTagType(task.current_step)" size="small">
                        {{ formatStepName(task.current_step) }}
                      </el-tag>
                    </p>
                  </div>

                  <!-- å®æ—¶è¿›åº¦æ¡ -->
                  <el-progress
                    :percentage="Math.round(task.progress || 0)"
                    :status="task.status === 'completed' ? 'success' :
                            task.status === 'failed' ? 'exception' : ''"
                    :stroke-width="8"
                    style="margin: 10px 0;"
                    :show-text="true"
                    :format="(percentage) => getProgressText(task, percentage)"
                  />

                  <!-- ç­‰å¾…ç¤¼å“å¡è¾“å…¥æç¤º -->
                  <div v-if="task.status === 'waiting_gift_card_input'" class="gift-card-waiting">
                    <el-alert
                      title="ç­‰å¾…ç¤¼å“å¡è¾“å…¥"
                      type="warning"
                      :closable="false"
                      show-icon
                    >
                      <template #default>
                        <p>ä»»åŠ¡å·²åˆ°è¾¾ç¤¼å“å¡è¾“å…¥é¡µé¢ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­æ‰‹åŠ¨è¾“å…¥ç¤¼å“å¡ä¿¡æ¯</p>
                      </template>
                    </el-alert>
                  </div>

                  <!-- å®æ—¶æœ€æ–°æ—¥å¿—æ˜¾ç¤º -->
                  <div v-if="task.logs && task.logs.length > 0" class="latest-log">
                    <p class="log-text" :class="getLogLevelClass(getLatestLogLevel(task))">
                      <span style="margin-right: 8px;">{{ getLogIcon(getLatestLogLevel(task)) }}</span>
                      {{ getLatestLog(task) }}
                    </p>
                    <p class="log-time">{{ formatTime(getLatestLogTime(task)) }}</p>
                  </div>

                  <!-- æ“ä½œæŒ‰é’® -->
                  <div class="task-actions">
                    <el-button
                      size="small"
                      @click="viewTaskDetail(task)"
                      type="primary"
                    >
                      æŸ¥çœ‹è¯¦æƒ…
                    </el-button>
                    <el-button
                      size="small"
                      @click="startTask(task.id)"
                      :disabled="task.status === 'running'"
                      type="success"
                      v-if="task.status === 'pending'"
                    >
                      å¯åŠ¨ä»»åŠ¡
                    </el-button>
                    <el-button
                      size="small"
                      @click="deleteTask(task.id)"
                      type="danger"
                    >
                      åˆ é™¤
                    </el-button>
                  </div>
                </div>
              </el-card>
            </div>

            <div v-else>
              <el-empty description="æš‚æ—  iPhone ä»»åŠ¡" :image-size="100">
                <el-button type="primary" @click="openCreateDialog">
                  åˆ›å»ºç¬¬ä¸€ä¸ª iPhone ä»»åŠ¡
                </el-button>
              </el-empty>
            </div>
                </div>
              </el-tab-pane>

              <!-- ğŸš€ ä»»åŠ¡åˆ—è¡¨é¡µç­¾ -->
              <el-tab-pane label="ğŸ“‹ æ‰€æœ‰ä»»åŠ¡" name="list">
                <div class="task-list-content">
                  <!-- æœç´¢å’Œç­›é€‰ -->
                  <div class="search-filter-bar">
                    <el-row :gutter="20">
                      <el-col :span="8">
                        <el-input
                          v-model="searchQuery"
                          placeholder="æœç´¢ä»»åŠ¡åç§°ã€Apple ID..."
                          prefix-icon="Search"
                          clearable
                        />
                      </el-col>
                      <el-col :span="6">
                        <el-select v-model="statusFilter" placeholder="ç­›é€‰çŠ¶æ€" clearable>
                          <el-option label="å…¨éƒ¨çŠ¶æ€" value="all" />
                          <el-option label="ç­‰å¾…ä¸­" value="pending" />
                          <el-option label="è¿è¡Œä¸­" value="running" />
                          <el-option label="å·²å®Œæˆ" value="completed" />
                          <el-option label="å¤±è´¥" value="failed" />
                          <el-option label="å·²å–æ¶ˆ" value="cancelled" />
                        </el-select>
                      </el-col>
                      <el-col :span="10">
                        <div class="filter-info">
                          <span>å…± {{ filteredTasks.length }} ä¸ªä»»åŠ¡</span>
                          <el-button @click="refreshTasks" size="small" :loading="loading">
                            åˆ·æ–°
                          </el-button>
                        </div>
                      </el-col>
                    </el-row>
                  </div>

                  <!-- ä»»åŠ¡è¡¨æ ¼ -->
                  <el-table
                    :data="paginatedTasks"
                    style="width: 100%"
                    v-loading="loading"
                    @row-click="viewTaskDetail"
                    row-class-name="task-row"
                  >
                    <el-table-column prop="config.name" label="ä»»åŠ¡åç§°" width="200">
                      <template #default="scope">
                        <div class="task-name-cell">
                          <span class="task-name">{{ scope.row.config?.name || 'æœªå‘½åä»»åŠ¡' }}</span>
                          <el-tag size="small" class="task-id">{{ scope.row.id.substring(0, 8) }}</el-tag>
                        </div>
                      </template>
                    </el-table-column>

                    <el-table-column prop="status" label="çŠ¶æ€" width="120">
                      <template #default="scope">
                        <el-tag :type="getStatusType(scope.row.status)" size="small">
                          {{ getStatusText(scope.row.status) }}
                        </el-tag>
                      </template>
                    </el-table-column>

                    <el-table-column prop="progress" label="è¿›åº¦" width="150">
                      <template #default="scope">
                        <el-progress
                          :percentage="Math.round(scope.row.progress || 0)"
                          :status="getProgressStatus(scope.row.status)"
                          :stroke-width="8"
                        />
                      </template>
                    </el-table-column>

                    <el-table-column prop="current_step" label="å½“å‰æ­¥éª¤" width="150">
                      <template #default="scope">
                        <el-tag
                          v-if="scope.row.current_step"
                          :type="getStepTagType(scope.row.current_step)"
                          size="small"
                        >
                          {{ formatStepName(scope.row.current_step) }}
                        </el-tag>
                        <span v-else class="text-muted">-</span>
                      </template>
                    </el-table-column>

                    <el-table-column prop="config.account_config.email" label="Apple ID" width="180">
                      <template #default="scope">
                        {{ scope.row.config?.account_config?.email || '-' }}
                      </template>
                    </el-table-column>

                    <el-table-column prop="created_at" label="åˆ›å»ºæ—¶é—´" width="160">
                      <template #default="scope">
                        {{ formatTime(scope.row.created_at) }}
                      </template>
                    </el-table-column>

                    <el-table-column prop="started_at" label="å¼€å§‹æ—¶é—´" width="160">
                      <template #default="scope">
                        {{ scope.row.started_at ? formatTime(scope.row.started_at) : '-' }}
                      </template>
                    </el-table-column>

                    <el-table-column prop="completed_at" label="å®Œæˆæ—¶é—´" width="160">
                      <template #default="scope">
                        {{ scope.row.completed_at ? formatTime(scope.row.completed_at) : '-' }}
                      </template>
                    </el-table-column>

                    <el-table-column label="æ“ä½œ" width="250" fixed="right">
                      <template #default="scope">
                        <!-- ğŸ ç­‰å¾…ç¤¼å“å¡è¾“å…¥çŠ¶æ€çš„ç‰¹æ®Šæ“ä½œ -->
                        <el-button
                          v-if="scope.row.status === 'waiting_gift_card_input'"
                          type="warning"
                          size="small"
                          @click.stop="openGiftCardInput(scope.row)"
                        >
                          å¡«å†™å¡å·
                        </el-button>

                        <el-button
                          type="text"
                          size="small"
                          @click.stop="viewTaskDetail(scope.row)"
                        >
                          è¯¦æƒ…
                        </el-button>
                        <el-button
                          v-if="scope.row.status === 'pending'"
                          type="text"
                          size="small"
                          @click.stop="startTask(scope.row.id)"
                        >
                          å¯åŠ¨
                        </el-button>
                        <el-button
                          v-if="['running', 'stage_1_product_config', 'stage_2_account_login', 'stage_3_address_phone', 'stage_4_gift_card'].includes(scope.row.status)"
                          type="text"
                          size="small"
                          @click.stop="cancelTask(scope.row.id)"
                        >
                          å–æ¶ˆ
                        </el-button>
                        <el-button
                          v-if="['completed', 'failed', 'cancelled'].includes(scope.row.status)"
                          type="text"
                          size="small"
                          @click.stop="deleteTask(scope.row.id)"
                          style="color: #f56c6c"
                        >
                          åˆ é™¤
                        </el-button>
                      </template>
                    </el-table-column>
                  </el-table>

                  <!-- åˆ†é¡µ -->
                  <div class="pagination-wrapper">
                    <el-pagination
                      v-model:current-page="currentPage"
                      v-model:page-size="pageSize"
                      :page-sizes="[10, 20, 50, 100]"
                      :total="filteredTasks.length"
                      layout="total, sizes, prev, pager, next, jumper"
                      @size-change="handleSizeChange"
                      @current-change="handleCurrentChange"
                    />
                  </div>
                </div>
              </el-tab-pane>
            </el-tabs>
          </div>

          <!-- Mac äº§å“é¡µé¢ -->
          <div v-else-if="currentProduct === 'mac'" class="product-section">
            <div class="section-header">
              <h2>ğŸ’» Mac è‡ªåŠ¨åŒ–ä»»åŠ¡</h2>
              <el-button type="primary" @click="openCreateDialog">
                åˆ›å»º Mac ä»»åŠ¡
              </el-button>
            </div>
            <el-alert
              title="Mac äº§å“æ”¯æŒå³å°†ä¸Šçº¿"
              type="info"
              description="Mac äº§å“çš„è‡ªåŠ¨åŒ–è´­ä¹°åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼"
              show-icon
              :closable="false"
            />
          </div>

          <!-- iPad äº§å“é¡µé¢ -->
          <div v-else-if="currentProduct === 'ipad'" class="product-section">
            <div class="section-header">
              <h2>ğŸ“± iPad è‡ªåŠ¨åŒ–ä»»åŠ¡</h2>
              <el-button type="primary" @click="openCreateDialog">
                åˆ›å»º iPad ä»»åŠ¡
              </el-button>
            </div>
            <el-alert
              title="iPad äº§å“æ”¯æŒå³å°†ä¸Šçº¿"
              type="info"
              description="iPad äº§å“çš„è‡ªåŠ¨åŒ–è´­ä¹°åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼"
              show-icon
              :closable="false"
            />
          </div>

          <!-- Apple Watch äº§å“é¡µé¢ -->
          <div v-else-if="currentProduct === 'watch'" class="product-section">
            <div class="section-header">
              <h2>âŒš Apple Watch è‡ªåŠ¨åŒ–ä»»åŠ¡</h2>
              <el-button type="primary" @click="openCreateDialog">
                åˆ›å»º Watch ä»»åŠ¡
              </el-button>
            </div>
            <el-alert
              title="Apple Watch äº§å“æ”¯æŒå³å°†ä¸Šçº¿"
              type="info"
              description="Apple Watch äº§å“çš„è‡ªåŠ¨åŒ–è´­ä¹°åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼"
              show-icon
              :closable="false"
            />
          </div>

          <!-- æ‰€æœ‰ä»»åŠ¡è§†å›¾ -->
          <div v-else-if="currentProduct === 'all-tasks'" class="product-section">
            <div class="section-header">
              <h2>ğŸ“‹ æ‰€æœ‰ä»»åŠ¡æ€»è§ˆ</h2>
            </div>

            <!-- ä»»åŠ¡ç»Ÿè®¡ -->
            <div class="stats-row">
              <el-card class="stat-card">
                <div class="stat-content">
                  <div class="stat-number">{{ tasks.length }}</div>
                  <div class="stat-label">æ€»ä»»åŠ¡</div>
                </div>
              </el-card>
              <el-card class="stat-card">
                <div class="stat-content">
                  <div class="stat-number">{{ tasks.filter(t => ['running', 'stage_1_product_config', 'stage_2_account_login', 'stage_3_address_phone', 'stage_4_gift_card'].includes(t.status)).length }}</div>
                  <div class="stat-label">è¿è¡Œä¸­</div>
                </div>
              </el-card>
              <el-card class="stat-card">
                <div class="stat-content">
                  <div class="stat-number">{{ tasks.filter(t => t.status === 'waiting_gift_card_input').length }}</div>
                  <div class="stat-label">ç­‰å¾…è¾“å…¥</div>
                </div>
              </el-card>
              <el-card class="stat-card">
                <div class="stat-content">
                  <div class="stat-number">{{ tasks.filter(t => t.status === 'completed').length }}</div>
                  <div class="stat-label">å·²å®Œæˆ</div>
                </div>
              </el-card>
              <el-card class="stat-card">
                <div class="stat-content">
                  <div class="stat-number">{{ tasks.filter(t => t.status === 'failed').length }}</div>
                  <div class="stat-label">å¤±è´¥</div>
                </div>
              </el-card>
            </div>

            <!-- ä»»åŠ¡è¡¨æ ¼ -->
            <div v-if="tasks.length > 0" class="tasks-table">
              <el-table :data="tasks" style="width: 100%" stripe>
                <el-table-column prop="config.name" label="ä»»åŠ¡åç§°" width="150" />
                <el-table-column label="äº§å“" width="120">
                  <template #default="scope">
                    <el-tag v-if="scope.row.config?.url?.includes('iphone')" type="primary">iPhone</el-tag>
                    <el-tag v-else-if="scope.row.config?.url?.includes('mac')" type="success">Mac</el-tag>
                    <el-tag v-else-if="scope.row.config?.url?.includes('ipad')" type="warning">iPad</el-tag>
                    <el-tag v-else-if="scope.row.config?.url?.includes('watch')" type="info">Watch</el-tag>
                    <el-tag v-else>æœªçŸ¥</el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="çŠ¶æ€" width="120">
                  <template #default="scope">
                    <el-tag
                      :type="getStatusTagType(scope.row.status)"
                      effect="dark"
                    >
                      {{ getStatusDisplayName(scope.row.status) }}
                    </el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="è¿›åº¦" width="120">
                  <template #default="scope">
                    <el-progress
                      :percentage="scope.row.progress || 0"
                      :status="scope.row.status === 'completed' ? 'success' : scope.row.status === 'failed' ? 'exception' : ''"
                      :show-text="false"
                    />
                    <span class="progress-text">{{ scope.row.progress || 0 }}%</span>
                  </template>
                </el-table-column>
                <el-table-column prop="created_at" label="åˆ›å»ºæ—¶é—´" width="180">
                  <template #default="scope">
                    {{ formatTime(scope.row.created_at) }}
                  </template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" width="200">
                  <template #default="scope">
                    <!-- ç­‰å¾…ç¤¼å“å¡è¾“å…¥çŠ¶æ€çš„ç‰¹æ®Šæ“ä½œ -->
                    <el-button
                      v-if="scope.row.status === 'waiting_gift_card_input'"
                      type="warning"
                      size="small"
                      @click="openGiftCardInput(scope.row)"
                    >
                      å¡«å†™å¡å·
                    </el-button>

                    <!-- å…¶ä»–çŠ¶æ€çš„é€šç”¨æ“ä½œ -->
                    <el-button
                      v-if="scope.row.status === 'pending'"
                      type="primary"
                      size="small"
                      @click="startTask(scope.row.id)"
                    >
                      å¯åŠ¨
                    </el-button>

                    <el-button
                      v-if="['running', 'stage_1_product_config', 'stage_2_account_login', 'stage_3_address_phone', 'stage_4_gift_card'].includes(scope.row.status)"
                      type="danger"
                      size="small"
                      @click="cancelTask(scope.row.id)"
                    >
                      å–æ¶ˆ
                    </el-button>

                    <el-button
                      size="small"
                      @click="viewTaskDetail(scope.row)"
                    >
                      è¯¦æƒ…
                    </el-button>

                    <el-button
                      v-if="['completed', 'failed', 'cancelled'].includes(scope.row.status)"
                      type="danger"
                      size="small"
                      @click="deleteTask(scope.row.id)"
                    >
                      åˆ é™¤
                    </el-button>
                  </template>
                </el-table-column>
              </el-table>
            </div>

            <div v-else>
              <el-empty description="æš‚æ— ä»»åŠ¡" :image-size="100" />
            </div>
          </div>

          <!-- è´¦å·ç®¡ç†é¡µé¢ -->
          <div v-else-if="currentProduct === 'accounts'" class="product-section">
            <div class="section-header">
              <h2>ğŸ‘¤ è´¦å·ç®¡ç†</h2>
              <el-button type="primary" @click="showAddAccountDialog = true">æ·»åŠ è´¦å·</el-button>
            </div>

            <div v-if="accounts.length > 0">
              <el-table :data="accounts" style="width: 100%">
                <el-table-column prop="email" label="Apple ID" width="250" />
                <el-table-column prop="status" label="çŠ¶æ€" width="120">
                  <template #default="scope">
                    <el-tag :type="scope.row.status === 'active' ? 'success' : 'danger'">
                      {{ scope.row.status === 'active' ? 'æ­£å¸¸' : 'å¼‚å¸¸' }}
                    </el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="last_used" label="æœ€åä½¿ç”¨" width="180" />
                <el-table-column prop="created_at" label="æ·»åŠ æ—¶é—´" width="180" />
                <el-table-column label="æ“ä½œ">
                  <template #default="scope">
                    <el-button size="small" @click="testAccount(scope.row.id)">æµ‹è¯•</el-button>
                    <el-button size="small" type="danger" @click="deleteAccount(scope.row.id)">åˆ é™¤</el-button>
                  </template>
                </el-table-column>
              </el-table>
            </div>

            <div v-else>
              <el-empty description="æš‚æ— è´¦å·" :image-size="100">
                <el-button type="primary" @click="showAddAccountDialog = true">æ·»åŠ ç¬¬ä¸€ä¸ªè´¦å·</el-button>
              </el-empty>
            </div>
          </div>

          <!-- ç¤¼å“å¡ç®¡ç†é¡µé¢ -->
          <div v-else-if="currentProduct === 'gift-cards'" class="product-section">
            <div class="section-header">
              <h2>ğŸ ç¤¼å“å¡ç®¡ç†</h2>
              <div class="header-actions">
                <el-select
                  v-model="giftCardStatusFilter"
                  placeholder="ç­›é€‰çŠ¶æ€"
                  clearable
                  @change="() => {/* çŠ¶æ€ç­›é€‰ä¸éœ€è¦åˆ·æ–°æ•°æ® */}"
                  style="width: 150px; margin-right: 10px;"
                >
                  <el-option
                    v-for="status in giftCardStatuses"
                    :key="status"
                    :label="status"
                    :value="status"
                  />
                </el-select>
                <el-button type="primary" @click="showAddGiftCardDialog = true">
                  æ·»åŠ ç¤¼å“å¡
                </el-button>
              </div>
            </div>

            <div v-if="giftCards.length > 0">
              <el-table :data="giftCards" style="width: 100%" stripe>
                <el-table-column prop="gift_card_number" label="ç¤¼å“å¡å·" min-width="200" />
                <el-table-column label="çŠ¶æ€" width="120">
                  <template #default="scope">
                    <el-tag :type="getGiftCardStatusType(scope.row.status)">
                      {{ scope.row.status }}
                    </el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="balance" label="ä½™é¢" width="100">
                  <template #default="scope">
                    ${{ scope.row.balance || '0' }}
                  </template>
                </el-table-column>
                <el-table-column prop="notes" label="å¤‡æ³¨" min-width="150" />
                <el-table-column label="åˆ›å»ºæ—¶é—´" width="180">
                  <template #default="scope">
                    {{ formatTime(scope.row.created_at) }}
                  </template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" width="200" fixed="right">
                  <template #default="scope">
                    <el-button size="small" @click="editGiftCard(scope.row)">
                      ç¼–è¾‘
                    </el-button>
                    <el-button size="small" type="danger" @click="deleteGiftCard(scope.row.id)">
                      åˆ é™¤
                    </el-button>
                  </template>
                </el-table-column>
              </el-table>
            </div>

            <div v-else>
              <el-empty description="æš‚æ— ç¤¼å“å¡" :image-size="100">
                <el-button type="primary" @click="showAddGiftCardDialog = true">
                  æ·»åŠ ç¬¬ä¸€å¼ ç¤¼å“å¡
                </el-button>
              </el-empty>
            </div>
          </div>

          <!-- IPæ± ç®¡ç†é¡µé¢ -->
          <div v-else-if="currentProduct === 'ip-pool'" class="product-section">
            <div class="section-header">
              <h2>ğŸŒ IPæ± ç®¡ç†</h2>
              <el-button type="primary">æ·»åŠ ä»£ç†</el-button>
            </div>
            <el-empty description="æš‚æ— ä»£ç†" :image-size="100" />
          </div>
        </el-main>
      </el-container>
    </el-container>

    <!-- åˆ›å»ºä»»åŠ¡å¯¹è¯æ¡† -->
    <el-dialog
      v-model="showCreateDialog"
      title="åˆ›å»ºä»»åŠ¡"
      width="600px"
    >
      <el-form :model="taskForm" label-width="100px">
        <el-form-item label="ä»»åŠ¡åç§°">
          <el-input v-model="taskForm.name" placeholder="è¯·è¾“å…¥ä»»åŠ¡åç§°" />
        </el-form-item>

        <el-form-item label="äº§å“URL">
          <el-input
            v-model="taskForm.url"
            placeholder="è¯·è¾“å…¥Apple Storeäº§å“é¡µé¢URL"
            type="textarea"
            :rows="2"
          />
        </el-form-item>

        <el-form-item label="iPhoneå‹å·">
          <el-select
            v-model="taskForm.selectedModel"
            placeholder="é€‰æ‹©iPhoneå‹å·"
            @change="onModelChange"
          >
            <el-option
              v-for="(modelData, modelKey) in iphoneConfigs.models"
              :key="modelKey"
              :label="modelData.name"
              :value="modelKey"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="å°ºå¯¸" v-if="taskForm.selectedModel">
          <el-select
            v-model="taskForm.selectedSize"
            placeholder="é€‰æ‹©å°ºå¯¸"
            @change="onSizeChange"
          >
            <el-option
              v-for="(sizeData, sizeKey) in availableSizes"
              :key="sizeKey"
              :label="sizeData.name"
              :value="sizeKey"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="å­˜å‚¨å®¹é‡" v-if="taskForm.selectedSize">
          <el-select
            v-model="taskForm.selectedStorage"
            placeholder="é€‰æ‹©å­˜å‚¨å®¹é‡"
            @change="onStorageChange"
          >
            <el-option
              v-for="storage in availableStorages"
              :key="storage"
              :label="iphoneConfigs.storage_display_names[storage]"
              :value="storage"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="é¢œè‰²" v-if="taskForm.selectedStorage">
          <el-select
            v-model="taskForm.selectedColor"
            placeholder="é€‰æ‹©é¢œè‰²"
            @change="onColorChange"
          >
            <el-option
              v-for="color in availableColors"
              :key="color"
              :label="iphoneConfigs.color_display_names[color]"
              :value="color"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="äº§å“URL" prop="url">
          <el-input
            v-model="taskForm.url"
            placeholder="ç²˜è´´iPhone URLè‡ªåŠ¨è§£æé…ç½®ï¼Œæˆ–é€šè¿‡ä¸‹æ–¹é€‰æ‹©ç”Ÿæˆ"
            type="textarea"
            :rows="2"
            clearable
            @blur="parseUrlIfNeeded"
          >
            <template #append>
              <el-button @click="parseUrl" type="primary" :loading="parsingUrl">
                è§£æ
              </el-button>
            </template>
          </el-input>
        </el-form-item>

        <!-- ç”Ÿæˆçš„URLæ˜¾ç¤º -->
        <el-form-item label="ç”Ÿæˆçš„URL" v-if="generatedUrl">
          <el-input
            v-model="generatedUrl"
            readonly
            type="textarea"
            :rows="2"
          >
            <template #append>
              <el-button @click="copyUrl" type="primary">å¤åˆ¶</el-button>
            </template>
          </el-input>
        </el-form-item>

        <el-form-item label="Apple ID">
          <el-select v-model="taskForm.selectedAccount" placeholder="é€‰æ‹©Apple IDè´¦å·">
            <el-option
              v-for="account in accounts"
              :key="account.id"
              :label="account.email"
              :value="account.id"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="ç¤¼å“å¡">
          <el-select
            v-model="taskForm.selectedGiftCards"
            placeholder="é€‰æ‹©ç¤¼å“å¡ï¼ˆå¯å¤šé€‰ï¼‰"
            multiple
          >
            <el-option
              v-for="card in giftCards"
              :key="card.id"
              :label="`${card.number} (ä½™é¢: $${card.balance})`"
              :value="card.id"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="ä¼˜å…ˆçº§">
          <el-slider
            v-model="taskForm.priority"
            :min="1"
            :max="5"
            :marks="{ 1: 'ä½', 3: 'ä¸­', 5: 'é«˜' }"
          />
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="showCreateDialog = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="createTask">åˆ›å»ºä»»åŠ¡</el-button>
      </template>
    </el-dialog>

    <!-- æ·»åŠ è´¦å·å¯¹è¯æ¡† -->
    <el-dialog
      v-model="showAddAccountDialog"
      title="æ·»åŠ Apple IDè´¦å·"
      width="500px"
    >
      <el-form :model="accountForm" label-width="100px">
        <el-form-item label="Apple ID">
          <el-input v-model="accountForm.email" placeholder="è¯·è¾“å…¥Apple IDé‚®ç®±" />
        </el-form-item>

        <el-form-item label="å¯†ç ">
          <el-input
            v-model="accountForm.password"
            placeholder="è¯·è¾“å…¥å¯†ç "
            type="password"
            show-password
          />
        </el-form-item>

        <el-form-item label="å¤‡æ³¨">
          <el-input
            v-model="accountForm.note"
            placeholder="å¯é€‰ï¼šæ·»åŠ å¤‡æ³¨ä¿¡æ¯"
            type="textarea"
            :rows="2"
          />
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="showAddAccountDialog = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="addAccount">æ·»åŠ è´¦å·</el-button>
      </template>
    </el-dialog>

    <!-- æ·»åŠ ç¤¼å“å¡å¯¹è¯æ¡† -->
    <el-dialog
      v-model="showAddGiftCardDialog"
      :title="editingGiftCard ? 'ç¼–è¾‘ç¤¼å“å¡' : 'æ·»åŠ ç¤¼å“å¡'"
      width="500px"
    >
      <el-form :model="giftCardForm" label-width="100px">
        <el-form-item label="ç¤¼å“å¡å·">
          <el-input
            v-model="giftCardForm.gift_card_number"
            placeholder="è¯·è¾“å…¥ç¤¼å“å¡å·"
            clearable
          />
        </el-form-item>

        <el-form-item label="çŠ¶æ€">
          <el-select v-model="giftCardForm.status" style="width: 100%">
            <el-option
              v-for="status in giftCardStatuses"
              :key="status"
              :label="status"
              :value="status"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="ä½™é¢">
          <el-input
            v-model="giftCardForm.balance"
            placeholder="å¯é€‰ï¼šè¾“å…¥ä½™é¢é‡‘é¢"
            type="number"
          />
        </el-form-item>

        <el-form-item label="å¤‡æ³¨">
          <el-input
            v-model="giftCardForm.notes"
            placeholder="å¯é€‰ï¼šæ·»åŠ å¤‡æ³¨ä¿¡æ¯"
            type="textarea"
            :rows="2"
          />
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="showAddGiftCardDialog = false; editingGiftCard = null">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="addGiftCard">
          {{ editingGiftCard ? 'æ›´æ–°' : 'æ·»åŠ ' }}
        </el-button>
      </template>
    </el-dialog>

    <!-- ä»»åŠ¡è¯¦æƒ…å¯¹è¯æ¡† -->
    <el-dialog
      v-model="showDetailDialog"
      title="ä»»åŠ¡è¯¦æƒ…"
      width="800px"
    >
      <div v-if="selectedTask">
        <el-descriptions :column="2" border>
          <el-descriptions-item label="ä»»åŠ¡åç§°">
            {{ selectedTask.config?.name || 'N/A' }}
          </el-descriptions-item>
          <el-descriptions-item label="çŠ¶æ€">
            <el-tag :type="getStatusType(selectedTask.status)">
              {{ getStatusText(selectedTask.status) }}
            </el-tag>
          </el-descriptions-item>
          <el-descriptions-item label="Apple ID">
            {{ selectedTask.config?.account_config?.email || 'N/A' }}
          </el-descriptions-item>
          <el-descriptions-item label="è¿›åº¦">
            {{ Math.round(selectedTask.progress || 0) }}%
          </el-descriptions-item>
          <el-descriptions-item label="å½“å‰æ­¥éª¤" v-if="selectedTask.current_step">
            {{ formatStepName(selectedTask.current_step) }}
          </el-descriptions-item>
          <el-descriptions-item label="ä¼˜å…ˆçº§">
            {{ selectedTask.config?.priority || 'N/A' }}
          </el-descriptions-item>
          <el-descriptions-item label="åˆ›å»ºæ—¶é—´" span="2">
            {{ formatTime(selectedTask.created_at) }}
          </el-descriptions-item>
          <el-descriptions-item label="äº§å“é…ç½®" span="2">
            <div v-if="selectedTask.config?.product_config">
              <p><strong>å‹å·:</strong> {{ selectedTask.config.product_config.model_display_name || selectedTask.config.product_config.model }}</p>
              <p><strong>å°ºå¯¸:</strong> {{ selectedTask.config.product_config.size_display_name || selectedTask.config.product_config.size }}</p>
              <p><strong>å­˜å‚¨:</strong> {{ selectedTask.config.product_config.storage_display_name || selectedTask.config.product_config.storage }}</p>
              <p><strong>é¢œè‰²:</strong> {{ selectedTask.config.product_config.finish_display_name || selectedTask.config.product_config.finish }}</p>
            </div>
          </el-descriptions-item>
          <el-descriptions-item label="äº§å“URL" span="2">
            <el-link :href="selectedTask.config?.url" target="_blank" v-if="selectedTask.config?.url">
              {{ selectedTask.config.url }}
            </el-link>
            <span v-else>N/A</span>
          </el-descriptions-item>
          <el-descriptions-item label="ç¤¼å“å¡" span="2" v-if="selectedTask.config?.gift_cards && selectedTask.config.gift_cards.length > 0">
            <div>
              <el-tag
                v-for="card in selectedTask.config.gift_cards"
                :key="card.id"
                style="margin-right: 8px; margin-bottom: 4px;"
              >
                {{ card.number }} (ä½™é¢: ${{ card.balance }})
              </el-tag>
            </div>
          </el-descriptions-item>
        </el-descriptions>

        <!-- ğŸš¨ è´¦å·å®‰å…¨é—®é¢˜ä¿¡æ¯ -->
        <div v-if="selectedTask.security_issue" style="margin-top: 20px;">
          <h4>ğŸš¨ è´¦å·å®‰å…¨é—®é¢˜</h4>
          <el-alert
            :title="selectedTask.security_issue.lock_message ? 'è´¦å·å·²è¢«é”å®š' : 'æ£€æµ‹åˆ°è´¦å·å®‰å…¨é—®é¢˜'"
            type="error"
            :closable="false"
            show-icon
          >
            <template #default>
              <div class="security-issue-details">
                <div v-if="selectedTask.security_issue.lock_message" style="margin-bottom: 15px;">
                  <p><strong>é”å®šåŸå› :</strong></p>
                  <div style="background: #fef0f0; padding: 10px; border-radius: 4px; margin: 5px 0;">
                    <code style="color: #f56c6c;">{{ selectedTask.security_issue.lock_message }}</code>
                  </div>
                </div>
                <p><strong>é—®é¢˜é¡µé¢:</strong> {{ selectedTask.security_issue.page_title }}</p>
                <p><strong>å½“å‰URL:</strong></p>
                <el-link
                  :href="selectedTask.security_issue.current_url"
                  target="_blank"
                  type="primary"
                  style="font-size: 12px; word-break: break-all; margin-left: 10px;"
                >
                  {{ selectedTask.security_issue.current_url }}
                </el-link>
                <p style="margin-top: 10px;"><strong>å‘ç”Ÿæ—¶é—´:</strong> {{ formatTimestamp(selectedTask.security_issue.timestamp) }}</p>
                <p style="margin-top: 10px; color: #f56c6c;">
                  <el-icon><Warning /></el-icon>
                  {{ selectedTask.security_issue.lock_message
                     ? 'è¯¥è´¦å·å·²è¢«é”å®šï¼Œéœ€è¦è§£é”åæ‰èƒ½ç»§ç»­ä½¿ç”¨'
                     : 'è¯¥è´¦å·å¯èƒ½éœ€è¦é¢å¤–éªŒè¯æˆ–å·²è¢«æ ‡è®°ä¸ºå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥è´¦å·çŠ¶æ€' }}
                </p>
              </div>
            </template>
          </el-alert>
        </div>

        <div style="margin-top: 20px;">
          <h4>å®æ—¶è¿è¡Œæ—¥å¿—
            <el-tag v-if="selectedTask.logs" size="small" type="info">
              {{ selectedTask.logs.length }} æ¡
            </el-tag>
          </h4>
          <div class="log-container" ref="logContainer">
            <div
              v-if="selectedTask.logs && selectedTask.logs.length > 0"
              class="log-entries"
            >
              <div
                v-for="(log, index) in selectedTask.logs"
                :key="`${selectedTask.id}-${index}`"
                class="log-entry"
                :class="log.level || 'info'"
              >
                <span class="log-time">{{ formatTime(log.timestamp) }}</span>
                <span class="log-message">{{ log.message }}</span>
              </div>
            </div>
            <div v-else class="no-logs">
              æš‚æ— æ—¥å¿—ä¿¡æ¯
            </div>
          </div>

          <!-- è‡ªåŠ¨æ»šåŠ¨æ§åˆ¶ -->
          <div style="margin-top: 10px; text-align: right;">
            <el-checkbox v-model="autoScrollLogs" size="small">
              è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—
            </el-checkbox>
          </div>
        </div>
      </div>

      <template #footer>
        <el-button @click="showDetailDialog = false">å…³é—­</el-button>
        <el-button
          type="primary"
          @click="startTask(selectedTask.id)"
          v-if="selectedTask && selectedTask.status === 'pending'"
        >
          å¯åŠ¨ä»»åŠ¡
        </el-button>
        <el-button
          type="danger"
          @click="deleteTask(selectedTask.id); showDetailDialog = false"
          v-if="selectedTask"
        >
          åˆ é™¤ä»»åŠ¡
        </el-button>
      </template>
    </el-dialog>

    <!-- ğŸ ç¤¼å“å¡è¾“å…¥å¯¹è¯æ¡† -->
    <el-dialog
      v-model="showGiftCardInputDialog"
      title="è¾“å…¥ç¤¼å“å¡ä¿¡æ¯"
      width="500px"
      :close-on-click-modal="false"
    >
      <div v-if="waitingGiftCardTask">
        <div class="gift-card-form">
          <h4>ä»»åŠ¡ä¿¡æ¯</h4>
          <p><strong>ä»»åŠ¡åç§°ï¼š</strong>{{ waitingGiftCardTask.config?.name }}</p>
          <p><strong>å½“å‰çŠ¶æ€ï¼š</strong>ç­‰å¾…è¾“å…¥ç¤¼å“å¡</p>

          <el-divider></el-divider>

          <h4>ç¤¼å“å¡ä¿¡æ¯</h4>
          <el-form :model="taskGiftCardForm" label-width="120px" ref="giftCardFormRef">
            <el-form-item
              label="ç¤¼å“å¡å·ç "
              required
              :rules="[
                { required: true, message: 'è¯·è¾“å…¥ç¤¼å“å¡å·ç ', trigger: 'blur' },
                { pattern: /^[A-Z0-9]{16}$/, message: 'ç¤¼å“å¡å·ç å¿…é¡»æ˜¯16ä½å­—æ¯æ•°å­—ç»„åˆ', trigger: 'blur' }
              ]"
              prop="code"
            >
              <el-input
                v-model="taskGiftCardForm.code"
                placeholder="è¯·è¾“å…¥16ä½ç¤¼å“å¡å·ç ï¼ˆå¦‚ï¼šX7YVTGTLVR8FJ54Zï¼‰"
                maxlength="16"
                show-word-limit
                @input="formatGiftCardCode"
                style="text-transform: uppercase;"
              />
              <div class="form-help-text">
                <small>æ ¼å¼ï¼š16ä½å­—æ¯æ•°å­—ç»„åˆï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºå¤§å†™</small>
              </div>
            </el-form-item>
            <el-form-item label="å¤‡æ³¨">
              <el-input
                v-model="taskGiftCardForm.note"
                type="textarea"
                placeholder="å¯é€‰å¤‡æ³¨ä¿¡æ¯"
                :rows="2"
                maxlength="100"
                show-word-limit
              />
            </el-form-item>
          </el-form>
        </div>
      </div>

      <template #footer>
        <el-button @click="cancelGiftCardInput">å–æ¶ˆ</el-button>
        <el-button
          type="primary"
          @click="submitGiftCardInput"
          :disabled="!taskGiftCardForm.code"
        >
          æäº¤å¹¶ç»§ç»­ä»»åŠ¡
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, onUnmounted, computed, watch } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  Document,
  Clock,
  Loading,
  Check,
  Close,
  CircleClose,
  User,
  CreditCard,
  Odometer,
  List,
  Search
} from '@element-plus/icons-vue'
import axios from 'axios'
import io from 'socket.io-client'

// å“åº”å¼æ•°æ®
const currentProduct = ref('iphone')
const showCreateDialog = ref(false)
const showDetailDialog = ref(false)
const showAddAccountDialog = ref(false)
const showAddGiftCardDialog = ref(false)
const showGiftCardInputDialog = ref(false)
const waitingGiftCardTask = ref(null)
const taskGiftCardForm = ref({
  code: '',
  note: ''
})
const selectedTask = ref(null)
const autoScrollLogs = ref(true)
const logContainer = ref(null)
const isRefreshing = ref(false)

const isConnected = ref(false)
const hasInitialLoad = ref(false) // æ ‡è®°æ˜¯å¦å·²ç»åˆå§‹åŠ è½½è¿‡

// ğŸš€ é˜²æŠ–ç›¸å…³
let updateTasksDebounceTimer = null
const DEBOUNCE_DELAY = 100 // 100msé˜²æŠ–å»¶è¿Ÿ

// ğŸš€ å®æ—¶ç›‘æ§ç›¸å…³
const lastUpdateTime = ref(Date.now())
const isRealTimeActive = ref(false)
let heartbeatTimer = null
let smartPollingTimer = null
let fullPollingTimer = null
const HEARTBEAT_INTERVAL = 30000 // 30ç§’å¿ƒè·³
const SMART_POLLING_INTERVAL = 2000 // ğŸš€ 2ç§’æ™ºèƒ½è½®è¯¢
const FULL_POLLING_INTERVAL = 30000 // ğŸš€ 30ç§’å…¨é‡è½®è¯¢
const socket = ref(null)
const tasks = ref([])
const accounts = ref([])
const giftCards = ref([])
const giftCardStatuses = ref(['æœ‰é¢åº¦', '0ä½™é¢', 'éæœ¬å›½å¡', 'è¢«å……å€¼'])
const giftCardStatusFilter = ref('')
const editingGiftCard = ref(null)
const systemStatus = ref({
  total_tasks: 0,
  active_tasks: 0,
  max_concurrent: 3
})

// ğŸš€ é¡µç­¾ç›¸å…³
const activeTab = ref('create') // iPhoneé¡µé¢å†…çš„é¡µç­¾
const searchQuery = ref('')
const statusFilter = ref('all')

// ğŸš€ åˆ†é¡µç›¸å…³
const currentPage = ref(1)
const pageSize = ref(20)
const loading = ref(false)

// ğŸš€ ä»»åŠ¡ç»Ÿè®¡
const taskStats = ref({
  total: 0,
  pending: 0,
  running: 0,
  completed: 0,
  failed: 0,
  cancelled: 0
})

// ä»»åŠ¡è¡¨å•æ•°æ®
const taskForm = reactive({
  name: '',
  url: '',
  selectedAccount: null,
  selectedGiftCards: [],
  selectedModel: '',
  selectedSize: '',
  selectedStorage: '',
  selectedColor: '',
  priority: 2,
  product: 'iphone'
})

// è´¦å·è¡¨å•æ•°æ®
const accountForm = reactive({
  email: '',
  password: '',
  note: ''
})

// ç¤¼å“å¡è¡¨å•æ•°æ®
const giftCardForm = reactive({
  gift_card_number: '',
  status: 'æœ‰é¢åº¦',
  balance: '',
  notes: ''
})

// è®¡ç®—å±æ€§
const pendingTasks = computed(() => {
  if (!Array.isArray(tasks.value)) return []
  return tasks.value.filter(t => t.status === 'pending')
})
const runningTasks = computed(() => {
  if (!Array.isArray(tasks.value)) return []
  return tasks.value.filter(t => t.status === 'running')
})
const hasExecutableTasks = computed(() => pendingTasks.value.length > 0)

// ğŸš€ ä»»åŠ¡ç­›é€‰å’Œåˆ†é¡µè®¡ç®—å±æ€§
const filteredTasks = computed(() => {
  if (!Array.isArray(tasks.value)) return []

  let filtered = [...tasks.value]

  // æŒ‰çŠ¶æ€ç­›é€‰
  if (statusFilter.value && statusFilter.value !== 'all') {
    filtered = filtered.filter(task => task.status === statusFilter.value)
  }

  // æŒ‰æœç´¢å…³é”®è¯ç­›é€‰
  if (searchQuery.value) {
    const query = searchQuery.value.toLowerCase()
    filtered = filtered.filter(task =>
      (task.config?.name || '').toLowerCase().includes(query) ||
      (task.config?.account_config?.email || '').toLowerCase().includes(query) ||
      task.id.toLowerCase().includes(query)
    )
  }

  // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
  filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))

  return filtered
})

const paginatedTasks = computed(() => {
  const start = (currentPage.value - 1) * pageSize.value
  const end = start + pageSize.value
  return filteredTasks.value.slice(start, end)
})

// ğŸš€ ä»»åŠ¡ç»Ÿè®¡è®¡ç®—å±æ€§
const taskStatsComputed = computed(() => {
  if (!Array.isArray(tasks.value)) {
    return { total: 0, pending: 0, running: 0, completed: 0, failed: 0, cancelled: 0 }
  }

  const stats = { total: 0, pending: 0, running: 0, completed: 0, failed: 0, cancelled: 0 }

  tasks.value.forEach(task => {
    stats.total++
    if (task.status in stats) {
      stats[task.status]++
    }
  })

  return stats
})

// iPhoneé…ç½®ç›¸å…³è®¡ç®—å±æ€§
const availableSizes = computed(() => {
  if (!taskForm.selectedModel || !iphoneConfigs.models[taskForm.selectedModel]) {
    return {}
  }
  return iphoneConfigs.models[taskForm.selectedModel].sizes || {}
})

const availableStorages = computed(() => {
  if (!taskForm.selectedModel || !taskForm.selectedSize) {
    return []
  }
  const sizeData = iphoneConfigs.models[taskForm.selectedModel]?.sizes[taskForm.selectedSize]
  return sizeData?.storages || []
})

const availableColors = computed(() => {
  if (!taskForm.selectedModel || !taskForm.selectedSize) {
    return []
  }
  const sizeData = iphoneConfigs.models[taskForm.selectedModel]?.sizes[taskForm.selectedSize]
  return sizeData?.colors || []
})

// iPhone é…ç½®é€‰é¡¹ - ä»åç«¯åŠ¨æ€åŠ è½½
const iphoneConfigs = reactive({
  models: {},
  color_display_names: {},
  storage_display_names: {}
})

// ç”Ÿæˆçš„URLå’ŒéªŒè¯çŠ¶æ€
const generatedUrl = ref('')
const parsingUrl = ref(false)
const isValidUrl = ref(true)

// åˆå§‹åŒ– WebSocket è¿æ¥
const initWebSocket = () => {
  console.log('ğŸ”Œ å°è¯•åˆå§‹åŒ–WebSocketè¿æ¥')

  try {
    socket.value = io('http://localhost:5001', {
      timeout: 5000,
      autoConnect: true
    })

    socket.value.on('connect', () => {
      isConnected.value = true
      console.log('âœ… WebSocketå·²è¿æ¥')
      ElMessage.success('WebSocketè¿æ¥æˆåŠŸ')

      // ğŸš€ é‡è¿åç«‹å³è¯·æ±‚å½“å‰çŠ¶æ€
      console.log('ğŸ”„ WebSocketé‡è¿ï¼Œè¯·æ±‚æœ€æ–°çŠ¶æ€...')

      // ğŸš€ æ¯æ¬¡è¿æ¥éƒ½åˆ·æ–°æ•°æ®ï¼Œç¡®ä¿åŒæ­¥
      console.log('ğŸ“‹ WebSocketè¿æ¥ï¼Œåˆ·æ–°æ‰€æœ‰æ•°æ®...')
      refreshTasks()
      refreshAccounts()
      refreshGiftCards()
      hasInitialLoad.value = true

      // ğŸ æ£€æŸ¥æ˜¯å¦æœ‰ç­‰å¾…ç¤¼å“å¡è¾“å…¥çš„ä»»åŠ¡
      setTimeout(() => {
        checkForWaitingGiftCardTasks()
      }, 1000) // ç­‰å¾…ä»»åŠ¡æ•°æ®åŠ è½½å®Œæˆ

      // ğŸš€ å¯åŠ¨æ™ºèƒ½è½®è¯¢ä½œä¸ºWebSocketçš„è¡¥å……
      console.log('ğŸ”„ å¯åŠ¨æ™ºèƒ½è½®è¯¢ç›‘æ§')
      startSmartPolling()
    })

    socket.value.on('disconnect', () => {
      isConnected.value = false
      console.log('âŒ WebSocketè¿æ¥æ–­å¼€')
      ElMessage.warning('WebSocketè¿æ¥æ–­å¼€')

      // WebSocketæ–­å¼€æ—¶ï¼Œæ™ºèƒ½è½®è¯¢ç»§ç»­å·¥ä½œä½œä¸ºå¤‡ç”¨
      console.log('ğŸ”„ WebSocketæ–­å¼€ï¼Œæ™ºèƒ½è½®è¯¢ç»§ç»­ç›‘æ§')
    })

    socket.value.on('connect_error', (error) => {
      isConnected.value = false
      console.log('âŒ WebSocketè¿æ¥å¤±è´¥:', error.message)
      ElMessage.error('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼')
    })

    // ä»»åŠ¡åˆ›å»ºæˆåŠŸäº‹ä»¶
    socket.value.on('task_created', (task) => {
      console.log('âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸ:', task)
      console.log('ğŸ“‹ ä»»åŠ¡æ•°æ®ç»“æ„:', JSON.stringify(task, null, 2))

      // å¦‚æœåç«¯è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œå°è¯•ä¿®å¤
      if (!task.config && (task.name || task.account_config || task.product_config)) {
        console.log('ğŸ”§ ä¿®å¤ä»»åŠ¡æ•°æ®ç»“æ„')
        task = {
          id: task.id,
          status: task.status || 'pending',
          progress: task.progress || 0,
          created_at: task.created_at || new Date().toISOString(),
          config: {
            name: task.name,
            url: task.url,
            account_config: task.account_config,
            product_config: task.product_config,
            gift_cards: task.gift_cards || [],
            enabled: task.enabled,
            priority: task.priority,
            use_proxy: task.use_proxy
          }
        }
        console.log('ğŸ”§ ä¿®å¤åçš„ä»»åŠ¡æ•°æ®:', task)
      }

      // ğŸš€ ä½¿ç”¨å±€éƒ¨æ›´æ–°æ·»åŠ ä»»åŠ¡ï¼Œé¿å…æ•´é¡µé‡æ¸²æŸ“
      const existingIndex = tasks.value.findIndex(t => t.id === task.id)
      if (existingIndex === -1) {
        // ç›´æ¥æ·»åŠ åˆ°ç°æœ‰åˆ—è¡¨ï¼ŒVueä¼šè‡ªåŠ¨å¤„ç†å“åº”å¼æ›´æ–°
        tasks.value.push(task)
        console.log('ğŸ“‹ æ–°ä»»åŠ¡å·²å±€éƒ¨æ·»åŠ :', task.config?.name)
        ElMessage.success(`ä»»åŠ¡åˆ›å»ºæˆåŠŸ: ${task.config?.name}`)
      } else {
        // æ›´æ–°ç°æœ‰ä»»åŠ¡ï¼Œä¿æŒå¼•ç”¨ç¨³å®š
        Object.assign(tasks.value[existingIndex], task)
        console.log('ğŸ”„ ä»»åŠ¡å·²å±€éƒ¨æ›´æ–°:', task.id)
      }
    })

    // ä»»åŠ¡åˆ›å»ºé”™è¯¯äº‹ä»¶
    socket.value.on('task_create_error', (data) => {
      console.error('âŒ ä»»åŠ¡åˆ›å»ºå¤±è´¥:', data)
      ElMessage.error(`ä»»åŠ¡åˆ›å»ºå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`)
    })

    // ğŸš€ ä»»åŠ¡åˆ é™¤æˆåŠŸäº‹ä»¶ - å±€éƒ¨ç§»é™¤
    socket.value.on('task_delete_success', (data) => {
      console.log('âœ… æ”¶åˆ° task_delete_success äº‹ä»¶:', data)
      handleTaskDeletion(data.task_id, 'ä»»åŠ¡åˆ é™¤æˆåŠŸ')
    })

    socket.value.on('task_deleted', (data) => {
      console.log('âœ… æ”¶åˆ° task_deleted äº‹ä»¶:', data)
      handleTaskDeletion(data.task_id)
    })

    // ä»»åŠ¡åˆ é™¤é”™è¯¯äº‹ä»¶
    socket.value.on('task_delete_error', (data) => {
      console.error('âŒ ä»»åŠ¡åˆ é™¤å¤±è´¥:', data)
      ElMessage.error(`ä»»åŠ¡åˆ é™¤å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`)
    })

    socket.value.on('task_update', (data) => {
      console.log('ğŸ“ æ”¶åˆ°ä»»åŠ¡æ›´æ–°:', data)
      // ğŸš€ ä¿®å¤ï¼šåç«¯å‘é€çš„æ˜¯å®Œæ•´ä»»åŠ¡å¯¹è±¡ï¼Œä¸æ˜¯{task_id, updates}æ ¼å¼
      if (data && data.id) {
        handleTaskUpdate(data)
      } else {
        console.warn('âš ï¸ æ”¶åˆ°æ— æ•ˆçš„ä»»åŠ¡æ›´æ–°æ•°æ®:', data)
      }
    })

    socket.value.on('system_status', (data) => {
      systemStatus.value = data
    })

    // é€šç”¨é”™è¯¯äº‹ä»¶
    socket.value.on('error', (data) => {
      console.error('âŒ WebSocketé”™è¯¯:', data)
      ElMessage.error(data.message || 'å‘ç”ŸæœªçŸ¥é”™è¯¯')
    })

    // ==================== ğŸš€ SOTAå®æ—¶åŒæ­¥äº‹ä»¶ ====================

    // ä»»åŠ¡çŠ¶æ€æ›´æ–°äº‹ä»¶ï¼ˆä¼˜åŒ–é¢‘ç‡ï¼‰
    socket.value.on('task_status_update', (data) => {
      console.log('ğŸ”„ æ”¶åˆ°ä»»åŠ¡çŠ¶æ€æ›´æ–°:', data)
      handleTaskStatusUpdate(data)
    })

    // æ­¥éª¤æ›´æ–°äº‹ä»¶ï¼ˆä¼˜åŒ–é¢‘ç‡ï¼‰
    socket.value.on('step_update', (data) => {
      console.log('ğŸ”„ æ”¶åˆ°æ­¥éª¤æ›´æ–°:', data)
      console.log('ğŸ”„ æ­¥éª¤æ›´æ–°è¯¦æƒ…:', JSON.stringify(data, null, 2))
      handleStepUpdate(data)
    })

    // ç¤¼å“å¡è¾“å…¥è¯·æ±‚äº‹ä»¶
    socket.value.on('gift_card_input_required', (data) => {
      console.log('ğŸ æ”¶åˆ°ç¤¼å“å¡è¾“å…¥è¯·æ±‚:', data)
      handleGiftCardInputRequired(data)
    })

    // ä»»åŠ¡æ—¥å¿—äº‹ä»¶
    socket.value.on('task_log', (data) => {
      console.log('ğŸ“ æ”¶åˆ°ä»»åŠ¡æ—¥å¿—:', data)
      handleTaskLog(data)
    })

    // ğŸš€ å…³é”®ï¼šä»»åŠ¡å¯åŠ¨æˆåŠŸäº‹ä»¶ - ç«‹å³å“åº”
    socket.value.on('task_start_success', (data) => {
      console.log('ğŸš€ ä»»åŠ¡å¯åŠ¨æˆåŠŸ:', data)
      ElMessage.success(`ä»»åŠ¡ ${data.task_id} å¯åŠ¨æˆåŠŸ`)

      // ç«‹å³æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºè¿è¡Œä¸­
      const taskIndex = tasks.value.findIndex(t => t.id === data.task_id)
      if (taskIndex >= 0) {
        tasks.value[taskIndex].status = 'running'
        tasks.value[taskIndex].progress = 0
        tasks.value[taskIndex].started_at = new Date().toISOString()
        console.log('ğŸ”„ ä»»åŠ¡çŠ¶æ€å·²ç«‹å³æ›´æ–°ä¸ºè¿è¡Œä¸­')

        // æ›´æ–°å½“å‰æŸ¥çœ‹çš„ä»»åŠ¡è¯¦æƒ…
        if (selectedTask.value && selectedTask.value.id === data.task_id) {
          selectedTask.value = { ...tasks.value[taskIndex] }
        }
      }
    })

    socket.value.on('task_start_error', (data) => {
      console.error('âŒ ä»»åŠ¡å¯åŠ¨å¤±è´¥:', data)
      ElMessage.error(`ä»»åŠ¡å¯åŠ¨å¤±è´¥: ${data.message}`)
    })

    socket.value.on('task_cancel_success', (data) => {
      console.log('â¸ï¸ ä»»åŠ¡å–æ¶ˆæˆåŠŸ:', data)
      ElMessage.warning(`ä»»åŠ¡ ${data.task_id} å·²å–æ¶ˆ`)

      // ç«‹å³æ›´æ–°ä»»åŠ¡çŠ¶æ€
      const taskIndex = tasks.value.findIndex(t => t.id === data.task_id)
      if (taskIndex >= 0) {
        tasks.value[taskIndex].status = 'cancelled'

        // æ›´æ–°å½“å‰æŸ¥çœ‹çš„ä»»åŠ¡è¯¦æƒ…
        if (selectedTask.value && selectedTask.value.id === data.task_id) {
          selectedTask.value = { ...tasks.value[taskIndex] }
        }
      }
    })

    socket.value.on('task_cancel_error', (data) => {
      console.error('âŒ ä»»åŠ¡å–æ¶ˆå¤±è´¥:', data)
      ElMessage.error(`ä»»åŠ¡å–æ¶ˆå¤±è´¥: ${data.message}`)
    })

    // ğŸš¨ è´¦å·å®‰å…¨é—®é¢˜äº‹ä»¶
    socket.value.on('account_security_issue', (data) => {
      console.error('ğŸš¨ æ”¶åˆ°è´¦å·å®‰å…¨é—®é¢˜äº‹ä»¶:', data)
      handleAccountSecurityIssue(data)
    })

    // ç§»é™¤é«˜é¢‘ç‡è½®è¯¢ï¼Œæ”¹ä¸ºäº‹ä»¶é©±åŠ¨çš„åŒæ­¥
    console.log('âœ… WebSocketäº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®å®Œæˆ')
  } catch (error) {
    console.error('âŒ WebSocketåˆå§‹åŒ–å¤±è´¥:', error)
    isConnected.value = false
    ElMessage.warning('WebSocketåˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼')
  }
}

// æ›´æ–°ä»»åŠ¡
const updateTask = (taskId, updates) => {
  if (!Array.isArray(tasks.value)) {
    console.error('âŒ æ— æ³•æ›´æ–°ä»»åŠ¡ï¼Œtasks.value ä¸æ˜¯æ•°ç»„')
    return
  }
  const taskIndex = tasks.value.findIndex(t => t.id === taskId)
  if (taskIndex >= 0) {
    tasks.value[taskIndex] = { ...tasks.value[taskIndex], ...updates }

    // å¦‚æœæ˜¯å½“å‰æŸ¥çœ‹çš„ä»»åŠ¡ï¼Œä¹Ÿæ›´æ–°è¯¦æƒ…
    if (selectedTask.value && selectedTask.value.id === taskId) {
      selectedTask.value = { ...tasks.value[taskIndex] }
    }
  }
}

// ğŸš€ å¸¦é˜²æŠ–çš„ä»»åŠ¡æ›´æ–°å¤„ç† - é¿å…é¢‘ç¹æ›´æ–°å¯¼è‡´é¡µé¢é‡æ¸²æŸ“
const handleTaskUpdate = (taskData) => {
  try {
    if (!taskData || !taskData.id) {
      console.warn('âš ï¸ æ— æ•ˆçš„ä»»åŠ¡æ•°æ®')
      return
    }

    // ğŸš€ ä½¿ç”¨é˜²æŠ–æœºåˆ¶ï¼Œé¿å…çŸ­æ—¶é—´å†…çš„é¢‘ç¹æ›´æ–°
    if (updateTasksDebounceTimer) {
      clearTimeout(updateTasksDebounceTimer)
    }

    updateTasksDebounceTimer = setTimeout(() => {
      _performTaskUpdate(taskData)
    }, DEBOUNCE_DELAY)
  } catch (error) {
    console.error('å¤„ç†ä»»åŠ¡æ›´æ–°å¤±è´¥:', error)
  }
}

// å®é™…æ‰§è¡Œä»»åŠ¡æ›´æ–°çš„å‡½æ•°
const _performTaskUpdate = (taskData) => {
  try {

    const taskIndex = tasks.value.findIndex(t => t.id === taskData.id)
    if (taskIndex >= 0) {
      // å±€éƒ¨æ›´æ–°ï¼šåªæ›´æ–°å˜åŒ–çš„å±æ€§
      const existingTask = tasks.value[taskIndex]
      const hasChanges =
        existingTask.status !== taskData.status ||
        existingTask.progress !== taskData.progress ||
        existingTask.current_step !== taskData.current_step ||
        (taskData.logs && taskData.logs.length !== (existingTask.logs?.length || 0))

      if (hasChanges) {
        // ä½¿ç”¨Object.assignä¿æŒå“åº”å¼
        Object.assign(existingTask, taskData)
        existingTask.last_updated = new Date().toISOString()

        // å¦‚æœæ˜¯å½“å‰æŸ¥çœ‹çš„ä»»åŠ¡ï¼Œä¹Ÿæ›´æ–°è¯¦æƒ…
        if (selectedTask.value && selectedTask.value.id === taskData.id) {
          selectedTask.value = { ...existingTask }
        }

        console.log('ğŸ”„ ä»»åŠ¡å·²æ›´æ–°:', taskData.id, taskData.status)
      }
    } else {
      // æ–°ä»»åŠ¡ï¼Œæ·»åŠ åˆ°åˆ—è¡¨
      tasks.value.push(taskData)
      console.log('ğŸ“‹ æ–°ä»»åŠ¡å·²æ·»åŠ :', taskData.id)
    }
  } catch (error) {
    console.error('å¤„ç†ä»»åŠ¡æ›´æ–°å¤±è´¥:', error)
  }
}

// ğŸš€ ç»Ÿä¸€çš„ä»»åŠ¡åˆ é™¤å¤„ç† - é¿å…é‡å¤åˆ é™¤
const handleTaskDeletion = (taskId, successMessage = null) => {
  try {
    const index = tasks.value.findIndex(t => t.id === taskId)
    if (index >= 0) {
      const taskName = tasks.value[index].config?.name || taskId
      tasks.value.splice(index, 1)
      console.log('ğŸ“‹ ä»»åŠ¡å·²å±€éƒ¨ç§»é™¤:', taskId, taskName)

      // å¦‚æœå½“å‰æŸ¥çœ‹çš„æ˜¯è¢«åˆ é™¤çš„ä»»åŠ¡ï¼Œå…³é—­è¯¦æƒ…å¯¹è¯æ¡†
      if (selectedTask.value && selectedTask.value.id === taskId) {
        selectedTask.value = null
        showDetailDialog.value = false
      }

      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼ˆé¿å…é‡å¤æ˜¾ç¤ºï¼‰
      if (successMessage) {
        ElMessage.success(successMessage)
      }
    } else {
      console.log('âš ï¸ è¦åˆ é™¤çš„ä»»åŠ¡ä¸å­˜åœ¨:', taskId)
    }
  } catch (error) {
    console.error('å¤„ç†ä»»åŠ¡åˆ é™¤å¤±è´¥:', error)
  }
}

// åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
const refreshTasks = async () => {
  try {
    const response = await axios.get('http://localhost:5001/api/tasks')
    console.log('ğŸ“¥ æ”¶åˆ°ä»»åŠ¡æ•°æ®:', response.data)

    // å¤„ç†ä¸åŒçš„å“åº”æ ¼å¼
    let taskData = response.data

    // å¦‚æœå“åº”åŒ…å« tasks å­—æ®µï¼Œä½¿ç”¨è¯¥å­—æ®µ
    if (response.data && response.data.tasks) {
      taskData = response.data.tasks
    }

    // ç¡®ä¿æ•°æ®æ˜¯æ•°ç»„
    if (Array.isArray(taskData)) {
      // ä¿®å¤ä»»åŠ¡æ•°æ®ç»“æ„
      const fixedTasks = taskData.map(task => {
        // å¦‚æœä»»åŠ¡æ²¡æœ‰configç»“æ„ï¼Œå°è¯•ä¿®å¤
        if (!task.config && (task.name || task.account_config || task.product_config)) {
          console.log('ğŸ”§ ä¿®å¤APIä»»åŠ¡æ•°æ®ç»“æ„:', task.id)
          return {
            id: task.id,
            status: task.status || 'pending',
            progress: task.progress || 0,
            created_at: task.created_at || new Date().toISOString(),
            config: {
              name: task.name,
              url: task.url,
              account_config: task.account_config,
              product_config: task.product_config,
              gift_cards: task.gift_cards || [],
              enabled: task.enabled,
              priority: task.priority,
              use_proxy: task.use_proxy
            }
          }
        }
        return task
      })

      // ğŸš€ å±€éƒ¨æ›´æ–°ï¼šåªæ›´æ–°å˜åŒ–çš„ä»»åŠ¡ï¼Œé¿å…æ•´é¡µé‡æ¸²æŸ“
      updateTasksLocally(fixedTasks)

      console.log('âœ… ä»»åŠ¡åˆ—è¡¨å·²å±€éƒ¨æ›´æ–°:', tasks.value.length, 'ä¸ªä»»åŠ¡')

      // è¯¦ç»†æ˜¾ç¤ºæ¯ä¸ªä»»åŠ¡çš„ä¿¡æ¯
      tasks.value.forEach((task, index) => {
        console.log(`ğŸ“‹ ä»»åŠ¡ ${index + 1}:`, {
          id: task.id,
          name: task.config?.name,
          product: task.product,
          url: task.config?.url,
          status: task.status
        })
      })
    } else {
      console.warn('âš ï¸ APIè¿”å›çš„æ•°æ®æ ¼å¼:', typeof taskData, taskData)
      // å¦‚æœä¸æ˜¯æ•°ç»„ï¼Œå°è¯•è½¬æ¢æˆ–ä½¿ç”¨ç©ºæ•°ç»„
      tasks.value = []
      ElMessage.warning('ä»»åŠ¡æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œå·²é‡ç½®ä¸ºç©º')
    }
  } catch (error) {
    console.error('âŒ åˆ·æ–°ä»»åŠ¡å¤±è´¥:', error)
    // ç¡®ä¿ tasks.value å§‹ç»ˆæ˜¯æ•°ç»„
    if (!Array.isArray(tasks.value)) {
      tasks.value = []
    }
    if (error.code === 'ECONNREFUSED' || error.code === 'ERR_NETWORK') {
      console.log('ğŸ”„ åç«¯æœåŠ¡ä¸å¯ç”¨ï¼Œä¿æŒå½“å‰æ•°æ®')
    } else {
      ElMessage.error('åˆ·æ–°ä»»åŠ¡å¤±è´¥: ' + (error.response?.data?.message || error.message))
    }
  }
}

// ğŸš€ å±€éƒ¨æ›´æ–°ä»»åŠ¡åˆ—è¡¨ - åªæ›´æ–°å˜åŒ–çš„ä»»åŠ¡ï¼Œä¿æŒé¡µé¢ç¨³å®š
const updateTasksLocally = (newTasks) => {
  try {
    // å¦‚æœå½“å‰åˆ—è¡¨ä¸ºç©ºï¼Œç›´æ¥è®¾ç½®
    if (tasks.value.length === 0) {
      tasks.value = newTasks
      console.log('ğŸ“‹ åˆå§‹åŒ–ä»»åŠ¡åˆ—è¡¨:', newTasks.length, 'ä¸ªä»»åŠ¡')
      return
    }

    // åˆ›å»ºä»»åŠ¡IDæ˜ å°„ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾
    const currentTaskMap = new Map()
    tasks.value.forEach(task => {
      currentTaskMap.set(task.id, task)
    })

    const newTaskMap = new Map()
    newTasks.forEach(task => {
      newTaskMap.set(task.id, task)
    })

    let addedCount = 0
    let updatedCount = 0
    let removedCount = 0

    // 1. æ›´æ–°ç°æœ‰ä»»åŠ¡æˆ–æ·»åŠ æ–°ä»»åŠ¡
    newTasks.forEach(newTask => {
      const existingTaskIndex = tasks.value.findIndex(t => t.id === newTask.id)

      if (existingTaskIndex >= 0) {
        // ä»»åŠ¡å·²å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        const existingTask = tasks.value[existingTaskIndex]
        if (JSON.stringify(existingTask) !== JSON.stringify(newTask)) {
          // åªæ›´æ–°å˜åŒ–çš„å±æ€§ï¼Œä¿æŒVueå“åº”å¼
          Object.assign(existingTask, newTask)
          updatedCount++
          console.log('ğŸ”„ æ›´æ–°ä»»åŠ¡:', newTask.id, newTask.config?.name)
        }
      } else {
        // æ–°ä»»åŠ¡ï¼Œæ·»åŠ åˆ°åˆ—è¡¨
        tasks.value.push(newTask)
        addedCount++
        console.log('â• æ·»åŠ æ–°ä»»åŠ¡:', newTask.id, newTask.config?.name)
      }
    })

    // 2. ç§»é™¤ä¸å­˜åœ¨çš„ä»»åŠ¡
    for (let i = tasks.value.length - 1; i >= 0; i--) {
      const task = tasks.value[i]
      if (!newTaskMap.has(task.id)) {
        tasks.value.splice(i, 1)
        removedCount++
        console.log('â– ç§»é™¤ä»»åŠ¡:', task.id, task.config?.name)
      }
    }

    // 3. æ›´æ–°å½“å‰æŸ¥çœ‹çš„ä»»åŠ¡è¯¦æƒ…
    if (selectedTask.value && newTaskMap.has(selectedTask.value.id)) {
      selectedTask.value = { ...newTaskMap.get(selectedTask.value.id) }
    }

    console.log(`âœ… å±€éƒ¨æ›´æ–°å®Œæˆ: +${addedCount} ~${updatedCount} -${removedCount}`)
  } catch (error) {
    console.error('âŒ å±€éƒ¨æ›´æ–°å¤±è´¥:', error)
    // é™çº§åˆ°ç›´æ¥æ›¿æ¢
    tasks.value = newTasks
  }
}

// ğŸš€ å±€éƒ¨åˆ·æ–°è´¦å·åˆ—è¡¨
const refreshAccounts = async () => {
  try {
    console.log('ğŸ“¡ æ­£åœ¨è·å–è´¦å·åˆ—è¡¨...')
    const response = await axios.get('http://localhost:5001/api/accounts')
    updateAccountsLocally(response.data)
    console.log('âœ… è´¦å·åˆ—è¡¨å·²å±€éƒ¨æ›´æ–°:', accounts.value.length, 'ä¸ªè´¦å·')
  } catch (error) {
    console.error('âŒ è·å–è´¦å·å¤±è´¥:', error)
    if (error.code === 'ECONNREFUSED' || error.code === 'ERR_NETWORK') {
      console.log('ğŸ”„ åç«¯æœåŠ¡ä¸å¯ç”¨ï¼Œä¿æŒå½“å‰è´¦å·åˆ—è¡¨')
      if (accounts.value.length === 0) {
        ElMessage.warning('åç«¯æœåŠ¡ä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½è´¦å·åˆ—è¡¨')
      }
    } else {
      ElMessage.error('è·å–è´¦å·å¤±è´¥: ' + (error.response?.data?.message || error.message))
    }
  }
}

// ğŸš€ å±€éƒ¨æ›´æ–°è´¦å·åˆ—è¡¨
const updateAccountsLocally = (newAccounts) => {
  try {
    if (!Array.isArray(newAccounts)) {
      console.warn('âš ï¸ è´¦å·æ•°æ®ä¸æ˜¯æ•°ç»„æ ¼å¼')
      return
    }

    // å¦‚æœå½“å‰åˆ—è¡¨ä¸ºç©ºï¼Œç›´æ¥è®¾ç½®
    if (accounts.value.length === 0) {
      accounts.value = newAccounts
      console.log('ğŸ“‹ åˆå§‹åŒ–è´¦å·åˆ—è¡¨:', newAccounts.length, 'ä¸ªè´¦å·')
      return
    }

    let addedCount = 0
    let updatedCount = 0
    let removedCount = 0

    // åˆ›å»ºæ–°è´¦å·æ˜ å°„
    const newAccountMap = new Map()
    newAccounts.forEach(account => {
      newAccountMap.set(account.id, account)
    })

    // 1. æ›´æ–°ç°æœ‰è´¦å·æˆ–æ·»åŠ æ–°è´¦å·
    newAccounts.forEach(newAccount => {
      const existingIndex = accounts.value.findIndex(a => a.id === newAccount.id)

      if (existingIndex >= 0) {
        // è´¦å·å·²å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        const existing = accounts.value[existingIndex]
        if (JSON.stringify(existing) !== JSON.stringify(newAccount)) {
          Object.assign(existing, newAccount)
          updatedCount++
        }
      } else {
        // æ–°è´¦å·
        accounts.value.push(newAccount)
        addedCount++
      }
    })

    // 2. ç§»é™¤ä¸å­˜åœ¨çš„è´¦å·
    for (let i = accounts.value.length - 1; i >= 0; i--) {
      const account = accounts.value[i]
      if (!newAccountMap.has(account.id)) {
        accounts.value.splice(i, 1)
        removedCount++
      }
    }

    if (addedCount > 0 || updatedCount > 0 || removedCount > 0) {
      console.log(`âœ… è´¦å·å±€éƒ¨æ›´æ–°: +${addedCount} ~${updatedCount} -${removedCount}`)
    }
  } catch (error) {
    console.error('âŒ è´¦å·å±€éƒ¨æ›´æ–°å¤±è´¥:', error)
    accounts.value = newAccounts
  }
}

// ğŸš€ å±€éƒ¨åˆ·æ–°ç¤¼å“å¡åˆ—è¡¨
const refreshGiftCards = async () => {
  try {
    console.log('ğŸ“¡ æ­£åœ¨è·å–ç¤¼å“å¡åˆ—è¡¨...')
    const response = await axios.get('http://localhost:5001/api/gift-cards')
    updateGiftCardsLocally(response.data)
    console.log('âœ… ç¤¼å“å¡åˆ—è¡¨å·²å±€éƒ¨æ›´æ–°:', giftCards.value.length, 'å¼ ç¤¼å“å¡')
  } catch (error) {
    console.error('âŒ è·å–ç¤¼å“å¡å¤±è´¥:', error)
    if (error.code === 'ECONNREFUSED' || error.code === 'ERR_NETWORK') {
      console.log('ğŸ”„ åç«¯æœåŠ¡ä¸å¯ç”¨ï¼Œä¿æŒå½“å‰ç¤¼å“å¡åˆ—è¡¨')
      if (giftCards.value.length === 0) {
        ElMessage.warning('åç«¯æœåŠ¡ä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½ç¤¼å“å¡åˆ—è¡¨')
      }
    } else {
      ElMessage.error('è·å–ç¤¼å“å¡å¤±è´¥: ' + (error.response?.data?.message || error.message))
    }
  }
}

// ğŸš€ å±€éƒ¨æ›´æ–°ç¤¼å“å¡åˆ—è¡¨
const updateGiftCardsLocally = (newGiftCards) => {
  try {
    if (!Array.isArray(newGiftCards)) {
      console.warn('âš ï¸ ç¤¼å“å¡æ•°æ®ä¸æ˜¯æ•°ç»„æ ¼å¼')
      return
    }

    // å¦‚æœå½“å‰åˆ—è¡¨ä¸ºç©ºï¼Œç›´æ¥è®¾ç½®
    if (giftCards.value.length === 0) {
      giftCards.value = newGiftCards
      console.log('ğŸ“‹ åˆå§‹åŒ–ç¤¼å“å¡åˆ—è¡¨:', newGiftCards.length, 'å¼ ç¤¼å“å¡')
      return
    }

    let addedCount = 0
    let updatedCount = 0
    let removedCount = 0

    // åˆ›å»ºæ–°ç¤¼å“å¡æ˜ å°„
    const newCardMap = new Map()
    newGiftCards.forEach(card => {
      newCardMap.set(card.id, card)
    })

    // 1. æ›´æ–°ç°æœ‰ç¤¼å“å¡æˆ–æ·»åŠ æ–°ç¤¼å“å¡
    newGiftCards.forEach(newCard => {
      const existingIndex = giftCards.value.findIndex(c => c.id === newCard.id)

      if (existingIndex >= 0) {
        // ç¤¼å“å¡å·²å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        const existing = giftCards.value[existingIndex]
        if (JSON.stringify(existing) !== JSON.stringify(newCard)) {
          Object.assign(existing, newCard)
          updatedCount++
        }
      } else {
        // æ–°ç¤¼å“å¡
        giftCards.value.push(newCard)
        addedCount++
      }
    })

    // 2. ç§»é™¤ä¸å­˜åœ¨çš„ç¤¼å“å¡
    for (let i = giftCards.value.length - 1; i >= 0; i--) {
      const card = giftCards.value[i]
      if (!newCardMap.has(card.id)) {
        giftCards.value.splice(i, 1)
        removedCount++
      }
    }

    if (addedCount > 0 || updatedCount > 0 || removedCount > 0) {
      console.log(`âœ… ç¤¼å“å¡å±€éƒ¨æ›´æ–°: +${addedCount} ~${updatedCount} -${removedCount}`)
    }
  } catch (error) {
    console.error('âŒ ç¤¼å“å¡å±€éƒ¨æ›´æ–°å¤±è´¥:', error)
    giftCards.value = newGiftCards
  }
}

// åŠ è½½iPhoneé…ç½®
const loadIphoneConfigs = async () => {
  try {
    console.log('ï¿½ æ­£åœ¨åŠ è½½iPhoneé…ç½®...')
    const response = await axios.get('http://localhost:5001/api/config/iphone-configs')
    console.log('âœ… iPhoneé…ç½®åŠ è½½æˆåŠŸ:', response.data)
    console.log('ğŸ“Š æ¨¡å‹æ•°é‡:', Object.keys(response.data.models || {}).length)

    // æ›´æ–°é…ç½®æ•°æ®
    Object.assign(iphoneConfigs, response.data)
    console.log('ğŸ“± Vueæ•°æ®å·²æ›´æ–°ï¼Œå¯ç”¨æ¨¡å‹:', Object.keys(iphoneConfigs.models))
    ElMessage.success('iPhoneé…ç½®åŠ è½½æˆåŠŸ')
  } catch (error) {
    console.error('âŒ åŠ è½½iPhoneé…ç½®å¤±è´¥:', error)
    console.error('é”™è¯¯è¯¦æƒ…:', error.response?.data || error.message)

    // å¦‚æœåç«¯ä¸å¯ç”¨ï¼Œä½¿ç”¨åŸºç¡€çš„æ¨¡æ‹Ÿé…ç½®
    if (error.code === 'ECONNREFUSED' || error.code === 'ERR_NETWORK') {
      console.log('ğŸ”„ åç«¯æœåŠ¡ä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ‹ŸiPhoneé…ç½®')
      const mockConfig = {
        models: {
          'iphone-15-pro': {
            name: 'iPhone 15 Pro',
            sizes: {
              '6.1': {
                name: '6.1è‹±å¯¸',
                storages: ['128gb', '256gb', '512gb', '1tb'],
                colors: ['natural-titanium', 'blue-titanium', 'white-titanium', 'black-titanium']
              }
            }
          },
          'iphone-15': {
            name: 'iPhone 15',
            sizes: {
              '6.1': {
                name: '6.1è‹±å¯¸',
                storages: ['128gb', '256gb', '512gb'],
                colors: ['pink', 'yellow', 'green', 'blue', 'black']
              }
            }
          }
        },
        color_display_names: {
          'natural-titanium': 'åŸè‰²é’›é‡‘å±',
          'blue-titanium': 'è“è‰²é’›é‡‘å±',
          'white-titanium': 'ç™½è‰²é’›é‡‘å±',
          'black-titanium': 'é»‘è‰²é’›é‡‘å±',
          'pink': 'ç²‰è‰²',
          'yellow': 'é»„è‰²',
          'green': 'ç»¿è‰²',
          'blue': 'è“è‰²',
          'black': 'é»‘è‰²'
        },
        storage_display_names: {
          '128gb': '128GB',
          '256gb': '256GB',
          '512gb': '512GB',
          '1tb': '1TB'
        }
      }

      Object.assign(iphoneConfigs, mockConfig)
      console.log('âœ… æ¨¡æ‹ŸiPhoneé…ç½®å·²åŠ è½½:', mockConfig)
      ElMessage.warning('åç«¯æœåŠ¡ä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ‹ŸiPhoneé…ç½®')
    } else {
      ElMessage.error('åŠ è½½iPhoneé…ç½®å¤±è´¥: ' + (error.response?.data?.error || error.message))
    }
  }
}

// å·¥å…·æ–¹æ³•
const getTasksByProduct = (productType) => {
  // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ tasks.value æ˜¯æ•°ç»„
  if (!Array.isArray(tasks.value)) {
    console.error('âŒ tasks.value ä¸æ˜¯æ•°ç»„:', tasks.value)
    tasks.value = [] // é‡ç½®ä¸ºç©ºæ•°ç»„
    return []
  }

  console.log(`ğŸ” ç­›é€‰ ${productType} ä»»åŠ¡ï¼Œæ€»ä»»åŠ¡æ•°:`, tasks.value.length)

  // ğŸš€ åªæ˜¾ç¤ºå¾…è¿è¡Œå’Œæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
  const activeStatuses = ['pending', 'running', 'stage_1_product_config', 'stage_2_account_login', 'stage_3_address_phone', 'stage_4_gift_card', 'waiting_gift_card_input']

  const filteredTasks = tasks.value.filter(task => {
    console.log('ğŸ” æ£€æŸ¥ä»»åŠ¡å®Œæ•´æ•°æ®:', task)
    console.log('ğŸ” æ£€æŸ¥ä»»åŠ¡å…³é”®å­—æ®µ:', {
      id: task.id,
      product: task.product,
      url: task.config?.url,
      name: task.config?.name,
      status: task.status,
      config: task.config
    })

    // ğŸš€ é¦–å…ˆæ£€æŸ¥ä»»åŠ¡çŠ¶æ€æ˜¯å¦ä¸ºæ´»è·ƒçŠ¶æ€
    if (!activeStatuses.includes(task.status)) {
      console.log(`ğŸ” ä»»åŠ¡ ${task.id} çŠ¶æ€ ${task.status} ä¸åœ¨æ´»è·ƒçŠ¶æ€åˆ—è¡¨ä¸­ï¼Œè·³è¿‡`)
      return false
    }

    // å¤šç§åŒ¹é…æ–¹å¼ï¼Œå…¼å®¹ä¸åŒçš„æ•°æ®æ ¼å¼

    // æ–¹å¼1: é€šè¿‡ product å­—æ®µåŒ¹é…
    if (task.product === productType) {
      console.log('âœ… é€šè¿‡ product å­—æ®µåŒ¹é…:', task.id)
      return true
    }

    // æ–¹å¼2: é€šè¿‡ config.url æˆ– url åˆ¤æ–­äº§å“ç±»å‹
    const url = task.config?.url || task.url || ''
    if (url) {
      let matched = false
      switch(productType) {
        case 'iphone':
          matched = url.includes('iphone')
          break
        case 'mac':
          matched = url.includes('mac')
          break
        case 'ipad':
          matched = url.includes('ipad')
          break
        case 'watch':
          matched = url.includes('watch')
          break
        default:
          matched = false
      }

      if (matched) {
        console.log('âœ… é€šè¿‡ URL åŒ¹é…:', task.id, url)
        return true
      }
    }

    // æ–¹å¼3: é€šè¿‡ config.product_config.model åˆ¤æ–­ï¼ˆiPhoneç‰¹æ®Šå¤„ç†ï¼‰
    if (productType === 'iphone' && task.config?.product_config?.model) {
      const model = task.config.product_config.model.toLowerCase()
      if (model.includes('iphone')) {
        console.log('âœ… é€šè¿‡ model åŒ¹é…:', task.id, model)
        return true
      }
    }

    // æ–¹å¼4: å¦‚æœæ˜¯æˆ‘ä»¬åˆšåˆ›å»ºçš„ä»»åŠ¡ï¼Œå¯èƒ½è¿˜æ²¡æœ‰å®Œæ•´çš„URLï¼Œä½†æœ‰é…ç½®ä¿¡æ¯
    if (productType === 'iphone' && task.config?.product_config &&
        (task.config.product_config.model || task.config.product_config.storage || task.config.product_config.finish)) {
      console.log('âœ… é€šè¿‡äº§å“é…ç½®åŒ¹é… (iPhone):', task.id)
      return true
    }

    // æ–¹å¼5: ä¸´æ—¶è§£å†³æ–¹æ¡ˆ - å¦‚æœä»»åŠ¡æœ‰product_configä½†å­—æ®µä¸ºç©ºï¼Œæš‚æ—¶è®¤ä¸ºæ˜¯iPhoneä»»åŠ¡
    // è¿™æ˜¯å› ä¸ºå½“å‰åç«¯è¿”å›çš„æ•°æ®å­—æ®µéƒ½æ˜¯ç©ºçš„
    if (productType === 'iphone' && task.config?.product_config) {
      console.log('âœ… é€šè¿‡å­˜åœ¨product_configåŒ¹é… (ä¸´æ—¶æ–¹æ¡ˆ):', task.id)
      return true
    }

    console.log('âŒ æœªåŒ¹é…:', task.id, {
      product: task.product,
      url: url,
      model: task.config?.product_config?.model,
      hasProductConfig: !!task.config?.product_config,
      configKeys: task.config ? Object.keys(task.config) : []
    })

    return false
  })

  console.log(`ğŸ“± ${productType} æ´»è·ƒä»»åŠ¡ç­›é€‰ç»“æœ:`, filteredTasks.length, 'ä¸ªä»»åŠ¡')
  return filteredTasks
}

const getStatusType = (status) => {
  const statusMap = {
    'pending': 'info',
    'running': 'warning',
    'stage_1_product_config': 'warning',
    'stage_2_account_login': 'warning',
    'stage_3_address_phone': 'warning',
    'stage_4_gift_card': 'warning',
    'waiting_gift_card_input': 'danger',
    'completed': 'success',
    'failed': 'danger',
    'cancelled': 'info'
  }
  return statusMap[status] || 'info'
}

const getStatusText = (status) => {
  const statusMap = {
    'pending': 'ç­‰å¾…ä¸­',
    'running': 'è¿è¡Œä¸­',
    'stage_1_product_config': 'äº§å“é…ç½®',
    'stage_2_account_login': 'è´¦å·ç™»å½•',
    'stage_3_address_phone': 'åœ°å€ç”µè¯',
    'stage_4_gift_card': 'ç¤¼å“å¡é…ç½®',
    'waiting_gift_card_input': 'ç­‰å¾…è¾“å…¥',
    'completed': 'å·²å®Œæˆ',
    'failed': 'å¤±è´¥',
    'cancelled': 'å·²å–æ¶ˆ'
  }
  return statusMap[status] || status
}

// ä»»åŠ¡æ“ä½œæ–¹æ³•
const startTask = (taskId) => {
  console.log('ğŸš€ å¯åŠ¨ä»»åŠ¡:', taskId)

  // ä½¿ç”¨WebSocketå‘é€å¯åŠ¨è¯·æ±‚ï¼ˆæŒ‰åŸç³»ç»Ÿé€»è¾‘ï¼‰
  if (socket.value && isConnected.value) {
    socket.value.emit('start_task', { task_id: taskId })
    ElMessage.success('ä»»åŠ¡å¯åŠ¨è¯·æ±‚å·²å‘é€')
    console.log('âœ… å¯åŠ¨è¯·æ±‚å·²é€šè¿‡WebSocketå‘é€')
  } else {
    // å¦‚æœWebSocketæœªè¿æ¥ï¼Œå°è¯•HTTP APIä½œä¸ºé™çº§
    console.log('ğŸ”„ WebSocketæœªè¿æ¥ï¼Œå°è¯•HTTP APIå¯åŠ¨')
    startTaskViaHttp(taskId)
  }
}

// HTTP APIå¯åŠ¨ä»»åŠ¡ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
const startTaskViaHttp = async (taskId) => {
  try {
    await axios.post(`http://localhost:5001/api/tasks/${taskId}/start`)
    ElMessage.success('ä»»åŠ¡å¯åŠ¨æˆåŠŸ')

    // æ›´æ–°æœ¬åœ°ä»»åŠ¡çŠ¶æ€
    const taskIndex = tasks.value.findIndex(t => t.id === taskId)
    if (taskIndex >= 0) {
      tasks.value[taskIndex].status = 'running'
      console.log('âœ… ä»»åŠ¡çŠ¶æ€å·²æ›´æ–°ä¸ºè¿è¡Œä¸­:', taskId)
    }
  } catch (error) {
    console.error('âŒ HTTPå¯åŠ¨ä»»åŠ¡å¤±è´¥:', error)
    ElMessage.error('å¯åŠ¨ä»»åŠ¡å¤±è´¥: ' + (error.response?.data?.message || error.message))
  }
}

const startAllTasks = async () => {
  try {
    await axios.post('http://localhost:5001/api/tasks/start-all')
    ElMessage.success('æ‰€æœ‰ä»»åŠ¡å¯åŠ¨æˆåŠŸ')

    // WebSocketä¼šè‡ªåŠ¨æ›´æ–°çŠ¶æ€ï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°
    console.log('âœ… æ‰€æœ‰ä»»åŠ¡å¯åŠ¨è¯·æ±‚å·²å‘é€ï¼Œç­‰å¾…WebSocketæ›´æ–°çŠ¶æ€')
  } catch (error) {
    console.error('å¯åŠ¨æ‰€æœ‰ä»»åŠ¡å¤±è´¥:', error)
    ElMessage.error('å¯åŠ¨æ‰€æœ‰ä»»åŠ¡å¤±è´¥')
  }
}

const deleteTask = (taskId) => {
  ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚', 'ç¡®è®¤åˆ é™¤', {
    confirmButtonText: 'åˆ é™¤',
    cancelButtonText: 'å–æ¶ˆ',
    type: 'error'
  }).then(() => {
    console.log('ğŸ—‘ï¸ å‘é€åˆ é™¤ä»»åŠ¡è¯·æ±‚:', taskId)

    // ä½¿ç”¨WebSocketå‘é€åˆ é™¤è¯·æ±‚ï¼ˆæŒ‰åŸç³»ç»Ÿé€»è¾‘ï¼‰
    if (socket.value && isConnected.value) {
      socket.value.emit('delete_task', { task_id: taskId })
      ElMessage.warning('ä»»åŠ¡åˆ é™¤è¯·æ±‚å·²å‘é€')
      console.log('âœ… åˆ é™¤è¯·æ±‚å·²é€šè¿‡WebSocketå‘é€')
    } else {
      // å¦‚æœWebSocketæœªè¿æ¥ï¼Œå°è¯•HTTP APIä½œä¸ºé™çº§
      console.log('ğŸ”„ WebSocketæœªè¿æ¥ï¼Œå°è¯•HTTP APIåˆ é™¤')
      deleteTaskViaHttp(taskId)
    }
  }).catch(() => {
    // ç”¨æˆ·å–æ¶ˆåˆ é™¤
    console.log('âŒ ç”¨æˆ·å–æ¶ˆåˆ é™¤ä»»åŠ¡')
  })
}

// HTTP APIåˆ é™¤ä»»åŠ¡ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
const deleteTaskViaHttp = async (taskId) => {
  try {
    await axios.delete(`http://localhost:5001/api/tasks/${taskId}`)
    ElMessage.success('ä»»åŠ¡åˆ é™¤æˆåŠŸ')

    // ä»æœ¬åœ°åˆ—è¡¨ä¸­ç§»é™¤ä»»åŠ¡
    const taskIndex = tasks.value.findIndex(t => t.id === taskId)
    if (taskIndex >= 0) {
      tasks.value.splice(taskIndex, 1)
      console.log('âœ… ä»»åŠ¡å·²ä»æœ¬åœ°åˆ—è¡¨ç§»é™¤:', taskId)
    }
  } catch (error) {
    console.error('âŒ HTTPåˆ é™¤ä»»åŠ¡å¤±è´¥:', error)
    ElMessage.error('åˆ é™¤ä»»åŠ¡å¤±è´¥: ' + (error.response?.data?.message || error.message))
  }
}

const viewTaskDetail = (task) => {
  console.log('æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…:', task)
  selectedTask.value = task
  showDetailDialog.value = true
}

const openCreateDialog = () => {
  taskForm.product = currentProduct.value
  showCreateDialog.value = true
}

// iPhoneé…ç½®é€‰æ‹©å˜åŒ–å¤„ç†
const onModelChange = () => {
  // é‡ç½®åç»­é€‰æ‹©
  taskForm.selectedSize = ''
  taskForm.selectedStorage = ''
  taskForm.selectedColor = ''
  generatedUrl.value = ''
  console.log('ğŸ“± å‹å·å·²é€‰æ‹©:', taskForm.selectedModel)
}

const onSizeChange = () => {
  // é‡ç½®åç»­é€‰æ‹©
  taskForm.selectedStorage = ''
  taskForm.selectedColor = ''
  generatedUrl.value = ''
  console.log('ğŸ“ å°ºå¯¸å·²é€‰æ‹©:', taskForm.selectedSize)
}

const onStorageChange = () => {
  // é‡ç½®é¢œè‰²é€‰æ‹©
  taskForm.selectedColor = ''
  generatedUrl.value = ''
  console.log('ğŸ’¾ å­˜å‚¨å·²é€‰æ‹©:', taskForm.selectedStorage)
}

const onColorChange = async () => {
  console.log('ğŸ¨ é¢œè‰²å·²é€‰æ‹©:', taskForm.selectedColor)
  if (taskForm.selectedModel && taskForm.selectedSize &&
      taskForm.selectedStorage && taskForm.selectedColor) {
    await generateProductUrl()
  }
}

// ç”Ÿæˆäº§å“URL - è°ƒç”¨åç«¯API
const generateProductUrl = async () => {
  if (!taskForm.selectedModel || !taskForm.selectedSize || !taskForm.selectedStorage || !taskForm.selectedColor) {
    generatedUrl.value = ''
    return
  }

  try {
    console.log('ğŸ”— è°ƒç”¨åç«¯ç”ŸæˆURL...')
    const response = await axios.post('http://localhost:5001/api/config/generate-url', {
      model: taskForm.selectedModel,
      size: taskForm.selectedSize,
      storage: taskForm.selectedStorage,
      color: taskForm.selectedColor
    })

    if (response.data.success) {
      generatedUrl.value = response.data.url
      taskForm.url = response.data.url
      isValidUrl.value = true
      console.log('âœ… URLç”ŸæˆæˆåŠŸ:', generatedUrl.value)
    } else {
      console.error('âŒ URLç”Ÿæˆå¤±è´¥:', response.data.error)
      ElMessage.error('URLç”Ÿæˆå¤±è´¥: ' + (response.data.error || 'æœªçŸ¥é”™è¯¯'))
    }
  } catch (error) {
    console.error('âŒ è°ƒç”¨URLç”ŸæˆAPIå¤±è´¥:', error)

    // å¦‚æœåç«¯ä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿé€»è¾‘ï¼ˆæ”¯æŒapple.ukï¼‰
    console.log('ğŸ”„ åç«¯ä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ‹ŸURLç”Ÿæˆ')
    const baseUrl = 'https://www.apple.com/uk/shop/buy-iphone'  // ä½¿ç”¨UKåŸŸå
    const modelPath = taskForm.selectedModel.replace('iphone-', 'iphone-')
    generatedUrl.value = `${baseUrl}/${modelPath}?model=${taskForm.selectedModel}&size=${taskForm.selectedSize}&storage=${taskForm.selectedStorage}&color=${taskForm.selectedColor}`
    taskForm.url = generatedUrl.value

    console.log('ğŸ”— æ¨¡æ‹Ÿç”Ÿæˆçš„URL:', generatedUrl.value)
    ElMessage.warning('ä½¿ç”¨æ¨¡æ‹ŸURLç”Ÿæˆï¼ˆåç«¯æœåŠ¡ä¸å¯ç”¨ï¼‰')
  }
}

// URLè§£æåŠŸèƒ½
const parseUrlIfNeeded = () => {
  if (taskForm.url && taskForm.url.includes('apple.com')) {
    parseUrl()
  }
}

const parseUrl = async () => {
  if (!taskForm.url) {
    ElMessage.warning('è¯·å…ˆè¾“å…¥URL')
    return
  }

  parsingUrl.value = true
  try {
    console.log('ğŸ” è§£æURL:', taskForm.url)
    const response = await axios.post('http://localhost:5001/api/config/parse-url', {
      url: taskForm.url
    })

    if (response.data.success) {
      const config = response.data.config
      taskForm.selectedModel = config.model
      taskForm.selectedSize = config.size
      taskForm.selectedStorage = config.storage
      taskForm.selectedColor = config.color
      generatedUrl.value = taskForm.url
      isValidUrl.value = true
      console.log('âœ… URLè§£ææˆåŠŸ:', config)
      ElMessage.success('URLè§£ææˆåŠŸ')
    } else {
      isValidUrl.value = false
      console.error('âŒ URLè§£æå¤±è´¥:', response.data.error)
      ElMessage.error(response.data.error || 'URLè§£æå¤±è´¥')
    }
  } catch (error) {
    console.error('âŒ URLè§£æAPIè°ƒç”¨å¤±è´¥:', error)
    isValidUrl.value = false
    ElMessage.error('URLè§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæ ¼å¼æˆ–åç«¯æœåŠ¡')
  } finally {
    parsingUrl.value = false
  }
}

// å¤åˆ¶URLåŠŸèƒ½
const copyUrl = async () => {
  if (!generatedUrl.value) {
    ElMessage.warning('æ²¡æœ‰å¯å¤åˆ¶çš„URL')
    return
  }

  try {
    await navigator.clipboard.writeText(generatedUrl.value)
    ElMessage.success('URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
  } catch (error) {
    console.error('å¤åˆ¶å¤±è´¥:', error)
    // é™çº§æ–¹æ¡ˆ
    const textArea = document.createElement('textarea')
    textArea.value = generatedUrl.value
    document.body.appendChild(textArea)
    textArea.select()
    try {
      document.execCommand('copy')
      ElMessage.success('URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
    } catch (err) {
      ElMessage.error('å¤åˆ¶å¤±è´¥')
    }
    document.body.removeChild(textArea)
  }
}

// è´¦å·ç®¡ç†æ–¹æ³•
const testAccount = async (accountId) => {
  try {
    await axios.post(`http://localhost:5001/api/accounts/${accountId}/test`)
    ElMessage.success('è´¦å·æµ‹è¯•æˆåŠŸ')
    // è´¦å·æµ‹è¯•ä¸éœ€è¦åˆ·æ–°åˆ—è¡¨ï¼ŒçŠ¶æ€ä¸ä¼šæ”¹å˜
  } catch (error) {
    console.error('æµ‹è¯•è´¦å·å¤±è´¥:', error)
    ElMessage.error('æµ‹è¯•è´¦å·å¤±è´¥')
  }
}

const deleteAccount = async (accountId) => {
  try {
    await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦å·å—ï¼Ÿ', 'ç¡®è®¤åˆ é™¤', {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    })

    await axios.delete(`http://localhost:5001/api/accounts/${accountId}`)
    ElMessage.success('è´¦å·åˆ é™¤æˆåŠŸ')

    // ğŸš€ ä¹è§‚æ›´æ–°ï¼šç›´æ¥ä»æœ¬åœ°åˆ—è¡¨ç§»é™¤ï¼Œé¿å…åˆ·æ–°
    const index = accounts.value.findIndex(acc => acc.id === accountId)
    if (index >= 0) {
      accounts.value.splice(index, 1)
      console.log('âœ… è´¦å·å·²ä»æœ¬åœ°åˆ—è¡¨ç§»é™¤')
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error('åˆ é™¤è´¦å·å¤±è´¥:', error)
      ElMessage.error('åˆ é™¤è´¦å·å¤±è´¥')
    }
  }
}

const addAccount = async () => {
  try {
    // éªŒè¯è¡¨å•
    if (!accountForm.email || !accountForm.password) {
      ElMessage.error('è¯·å¡«å†™Apple IDå’Œå¯†ç ')
      return
    }

    const accountData = {
      email: accountForm.email,
      password: accountForm.password,
      note: accountForm.note
    }

    const response = await axios.post('http://localhost:5001/api/accounts', accountData)
    ElMessage.success('è´¦å·æ·»åŠ æˆåŠŸ')
    showAddAccountDialog.value = false

    // ğŸš€ ä¹è§‚æ›´æ–°ï¼šç›´æ¥æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨ï¼Œé¿å…åˆ·æ–°
    if (response.data && response.data.account) {
      accounts.value.push(response.data.account)
      console.log('âœ… æ–°è´¦å·å·²æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨')
    } else {
      // å¦‚æœåç«¯æ²¡æœ‰è¿”å›è´¦å·æ•°æ®ï¼Œåˆ™åˆ·æ–°åˆ—è¡¨
      refreshAccounts()
    }

    // é‡ç½®è¡¨å•
    Object.assign(accountForm, {
      email: '',
      password: '',
      note: ''
    })
  } catch (error) {
    console.error('æ·»åŠ è´¦å·å¤±è´¥:', error)
    ElMessage.error('æ·»åŠ è´¦å·å¤±è´¥')
  }
}

// ç¤¼å“å¡ç®¡ç†æ–¹æ³•
const getGiftCardStatusType = (status) => {
  const statusMap = {
    'æœ‰é¢åº¦': 'success',
    '0ä½™é¢': 'warning',
    'éæœ¬å›½å¡': 'danger',
    'è¢«å……å€¼': 'info'
  }
  return statusMap[status] || ''
}

const editGiftCard = (giftCard) => {
  editingGiftCard.value = giftCard
  Object.assign(giftCardForm, {
    gift_card_number: giftCard.gift_card_number,
    status: giftCard.status,
    balance: giftCard.balance || '',
    notes: giftCard.notes || ''
  })
  showAddGiftCardDialog.value = true
}

const addGiftCard = async () => {
  try {
    // éªŒè¯è¡¨å•
    if (!giftCardForm.gift_card_number || !giftCardForm.status) {
      ElMessage.error('è¯·å¡«å†™ç¤¼å“å¡å·å’ŒçŠ¶æ€')
      return
    }

    const giftCardData = {
      gift_card_number: giftCardForm.gift_card_number,
      status: giftCardForm.status,
      balance: giftCardForm.balance || 0,
      notes: giftCardForm.notes
    }

    if (editingGiftCard.value) {
      // æ›´æ–°ç¤¼å“å¡
      const response = await axios.put(`http://localhost:5001/api/gift-cards/${editingGiftCard.value.id}`, giftCardData)
      ElMessage.success('ç¤¼å“å¡æ›´æ–°æˆåŠŸ')

      // ğŸš€ ä¹è§‚æ›´æ–°ï¼šç›´æ¥æ›´æ–°æœ¬åœ°åˆ—è¡¨ä¸­çš„ç¤¼å“å¡
      const index = giftCards.value.findIndex(card => card.id === editingGiftCard.value.id)
      if (index >= 0 && response.data && response.data.gift_card) {
        giftCards.value[index] = response.data.gift_card
        console.log('âœ… ç¤¼å“å¡å·²åœ¨æœ¬åœ°åˆ—è¡¨ä¸­æ›´æ–°')
      }
    } else {
      // åˆ›å»ºç¤¼å“å¡
      const response = await axios.post('http://localhost:5001/api/gift-cards', giftCardData)
      ElMessage.success('ç¤¼å“å¡æ·»åŠ æˆåŠŸ')

      // ğŸš€ ä¹è§‚æ›´æ–°ï¼šç›´æ¥æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨
      if (response.data && response.data.gift_card) {
        giftCards.value.push(response.data.gift_card)
        console.log('âœ… æ–°ç¤¼å“å¡å·²æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨')
      }
    }

    showAddGiftCardDialog.value = false
    editingGiftCard.value = null

    // é‡ç½®è¡¨å•
    Object.assign(giftCardForm, {
      gift_card_number: '',
      status: 'æœ‰é¢åº¦',
      balance: '',
      notes: ''
    })

    // åªåœ¨ä¹è§‚æ›´æ–°å¤±è´¥æ—¶æ‰åˆ·æ–°
    // refreshGiftCards() - å·²ç§»é™¤ï¼Œä½¿ç”¨ä¹è§‚æ›´æ–°
  } catch (error) {
    console.error('ä¿å­˜ç¤¼å“å¡å¤±è´¥:', error)
    ElMessage.error('ä¿å­˜ç¤¼å“å¡å¤±è´¥')
  }
}

const deleteGiftCard = async (cardId) => {
  try {
    await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ ç¤¼å“å¡å—ï¼Ÿ', 'ç¡®è®¤åˆ é™¤', {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    })

    await axios.delete(`http://localhost:5001/api/gift-cards/${cardId}`)
    ElMessage.success('ç¤¼å“å¡åˆ é™¤æˆåŠŸ')

    // ğŸš€ ä¹è§‚æ›´æ–°ï¼šç›´æ¥ä»æœ¬åœ°åˆ—è¡¨ç§»é™¤ï¼Œé¿å…åˆ·æ–°
    const index = giftCards.value.findIndex(card => card.id === cardId)
    if (index >= 0) {
      giftCards.value.splice(index, 1)
      console.log('âœ… ç¤¼å“å¡å·²ä»æœ¬åœ°åˆ—è¡¨ç§»é™¤')
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error('åˆ é™¤ç¤¼å“å¡å¤±è´¥:', error)
      ElMessage.error('åˆ é™¤ç¤¼å“å¡å¤±è´¥')
    }
  }
}

const formatTime = (timestamp) => {
  if (!timestamp) return 'N/A'
  return new Date(timestamp).toLocaleString('zh-CN')
}

const formatTimestamp = (timestamp) => {
  if (!timestamp) return 'N/A'
  return new Date(timestamp).toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  })
}

const formatStepName = (step) => {
  const stepMap = {
    'initializing': 'ğŸš€ åˆå§‹åŒ–æµè§ˆå™¨',
    'navigating': 'ğŸ§­ å¯¼èˆªåˆ°é¡µé¢',
    'configuring_product': 'âš™ï¸ é…ç½®äº§å“',
    'adding_to_bag': 'ğŸ›ï¸ æ·»åŠ åˆ°è´­ç‰©è¢‹',
    'checkout': 'ğŸ’³ è¿›å…¥ç»“è´¦',
    'applying_gift_card': 'ğŸ åº”ç”¨ç¤¼å“å¡',
    'finalizing': 'âœ… å®Œæˆè´­ä¹°',
    'started': 'â–¶ï¸ å¼€å§‹',
    'progress': 'â³ è¿›è¡Œä¸­',
    'completed': 'âœ… å®Œæˆ',
    'failed': 'âŒ å¤±è´¥'
  }
  return stepMap[step] || step
}

const getLatestLog = (task) => {
  if (!task.logs || task.logs.length === 0) {
    return 'æš‚æ— æ—¥å¿—'
  }
  const latestLog = task.logs[task.logs.length - 1]
  return latestLog.message || 'æš‚æ— æ¶ˆæ¯'
}

const getLatestLogLevel = (task) => {
  if (!task.logs || task.logs.length === 0) {
    return 'info'
  }
  const latestLog = task.logs[task.logs.length - 1]
  return latestLog.level || 'info'
}

const getLatestLogTime = (task) => {
  if (!task.logs || task.logs.length === 0) {
    return null
  }
  const latestLog = task.logs[task.logs.length - 1]
  return latestLog.timestamp
}

const isTaskActive = (task) => {
  const activeStatuses = ['running', 'stage_1_product_config', 'stage_2_account_login', 'stage_3_address_phone', 'stage_4_gift_card', 'waiting_gift_card_input']
  return activeStatuses.includes(task.status)
}

const getStepTagType = (step) => {
  const stepTypes = {
    'initializing': 'info',
    'navigating': 'primary',
    'configuring_product': 'warning',
    'adding_to_bag': 'success',
    'checkout': 'primary',
    'applying_gift_card': 'warning',
    'finalizing': 'success',
    'waiting_gift_card_input': 'danger'
  }
  return stepTypes[step] || 'primary'
}

const getProgressText = (task, percentage) => {
  if (task.status === 'running') {
    return `${percentage}% æ‰§è¡Œä¸­...`
  } else if (task.status === 'waiting_gift_card_input') {
    return `${percentage}% ç­‰å¾…è¾“å…¥`
  } else if (task.status === 'completed') {
    return `${percentage}% å·²å®Œæˆ`
  } else if (task.status === 'failed') {
    return `${percentage}% å¤±è´¥`
  }
  return `${percentage}%`
}

const getLogLevelClass = (level) => {
  const levelClasses = {
    'error': 'log-error',
    'warning': 'log-warning',
    'success': 'log-success',
    'info': 'log-info'
  }
  return levelClasses[level] || 'log-info'
}

const getLogIcon = (level) => {
  const levelIcons = {
    'error': 'âŒ',
    'warning': 'âš ï¸',
    'success': 'âœ…',
    'info': 'â„¹ï¸'
  }
  return levelIcons[level] || 'â„¹ï¸'
}

const getActiveTasks = () => {
  const activeStatuses = ['running', 'stage_1_product_config', 'stage_2_account_login', 'stage_3_address_phone', 'stage_4_gift_card', 'waiting_gift_card_input']
  return tasks.value.filter(task => activeStatuses.includes(task.status))
}

// ğŸš€ çŠ¶æ€æ˜¾ç¤ºç›¸å…³å‡½æ•°
const getStatusTagType = (status) => {
  const statusTypes = {
    'pending': 'info',
    'running': 'primary',
    'stage_1_product_config': 'warning',
    'stage_2_account_login': 'warning',
    'stage_3_address_phone': 'warning',
    'stage_4_gift_card': 'warning',
    'waiting_gift_card_input': 'danger',
    'completed': 'success',
    'failed': 'danger',
    'cancelled': 'info'
  }
  return statusTypes[status] || 'info'
}

const getStatusDisplayName = (status) => {
  const statusNames = {
    'pending': 'ç­‰å¾…ä¸­',
    'running': 'è¿è¡Œä¸­',
    'stage_1_product_config': 'äº§å“é…ç½®',
    'stage_2_account_login': 'è´¦å·ç™»å½•',
    'stage_3_address_phone': 'åœ°å€ç”µè¯',
    'stage_4_gift_card': 'ç¤¼å“å¡é…ç½®',
    'waiting_gift_card_input': 'ç­‰å¾…è¾“å…¥',
    'completed': 'å·²å®Œæˆ',
    'failed': 'å¤±è´¥',
    'cancelled': 'å·²å–æ¶ˆ'
  }
  return statusNames[status] || status
}

// formatTimeå‡½æ•°å·²åœ¨ä¸Šé¢å£°æ˜

// ğŸš¨ è´¦å·å®‰å…¨é—®é¢˜å¤„ç†å‡½æ•°
const handleAccountSecurityIssue = (data) => {
  console.error('ğŸš¨ å¤„ç†è´¦å·å®‰å…¨é—®é¢˜:', data)

  // æ ¹æ®æ˜¯å¦æœ‰é”å®šæ¶ˆæ¯æ˜¾ç¤ºä¸åŒçš„é€šçŸ¥
  const notificationMessage = data.lock_message
    ? `è´¦å· ${data.account_email} å·²è¢«é”å®š: ${data.lock_message}`
    : `è´¦å· ${data.account_email} é‡åˆ°å®‰å…¨éªŒè¯é—®é¢˜ï¼Œè¯·æ£€æŸ¥è´¦å·çŠ¶æ€`

  // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥
  ElNotification({
    title: 'è´¦å·å®‰å…¨é—®é¢˜',
    message: notificationMessage,
    type: 'error',
    duration: 15000,
    position: 'top-right'
  })

  // æ›´æ–°ä»»åŠ¡çŠ¶æ€æ˜¾ç¤ºå½“å‰URL
  const taskIndex = tasks.value.findIndex(t => t.id === data.task_id)
  if (taskIndex !== -1) {
    const task = tasks.value[taskIndex]

    // æ·»åŠ å®‰å…¨é—®é¢˜ä¿¡æ¯åˆ°ä»»åŠ¡
    task.security_issue = {
      current_url: data.current_url,
      page_title: data.page_title,
      lock_message: data.lock_message,
      timestamp: data.timestamp
    }

    // æ›´æ–°ä»»åŠ¡çŠ¶æ€
    task.status = 'failed'
    task.error_message = data.lock_message
      ? `è´¦å·å·²è¢«é”å®š: ${data.lock_message}`
      : `è´¦å·å®‰å…¨é—®é¢˜: ${data.page_title}`

    // æ·»åŠ æ—¥å¿—
    if (!task.logs) task.logs = []
    task.logs.push({
      timestamp: new Date().toISOString(),
      level: 'error',
      message: data.lock_message
        ? `ğŸš¨ è´¦å·å·²è¢«é”å®š: ${data.lock_message}`
        : `ğŸš¨ è´¦å·å®‰å…¨é—®é¢˜: ${data.page_title}`
    })
    task.logs.push({
      timestamp: new Date().toISOString(),
      level: 'error',
      message: `ğŸ”— é—®é¢˜é¡µé¢: ${data.current_url}`
    })

    console.log('âœ… ä»»åŠ¡å®‰å…¨é—®é¢˜ä¿¡æ¯å·²æ›´æ–°:', task)
  }

  // åˆ·æ–°è´¦å·åˆ—è¡¨ï¼ˆå¦‚æœè´¦å·çŠ¶æ€å·²æ›´æ–°ï¼‰
  setTimeout(() => {
    fetchAccounts()
  }, 1000)
}

// ğŸš€ ç¤¼å“å¡è¾“å…¥ç›¸å…³å‡½æ•°
const openGiftCardInput = (task) => {
  console.log('ğŸ æ‰“å¼€ç¤¼å“å¡è¾“å…¥å¯¹è¯æ¡†:', task.id)
  // è®¾ç½®å½“å‰ç­‰å¾…è¾“å…¥çš„ä»»åŠ¡
  waitingGiftCardTask.value = task
  // é‡ç½®è¡¨å•
  taskGiftCardForm.value = {
    code: '',
    note: ''
  }
  showGiftCardInputDialog.value = true
}

// æ ¼å¼åŒ–ç¤¼å“å¡å·ç 
const formatGiftCardCode = () => {
  // è½¬æ¢ä¸ºå¤§å†™å¹¶ç§»é™¤éå­—æ¯æ•°å­—å­—ç¬¦
  taskGiftCardForm.value.code = taskGiftCardForm.value.code
    .toUpperCase()
    .replace(/[^A-Z0-9]/g, '')
    .substring(0, 16) // é™åˆ¶æœ€å¤§é•¿åº¦ä¸º16
}

const cancelGiftCardInput = () => {
  showGiftCardInputDialog.value = false
  waitingGiftCardTask.value = null
  taskGiftCardForm.value = {
    code: '',
    note: ''
  }
}

const submitGiftCardInput = async () => {
  if (!waitingGiftCardTask.value || !taskGiftCardForm.value.code) {
    ElMessage.error('è¯·è¾“å…¥ç¤¼å“å¡å·ç ')
    return
  }

  try {
    console.log('ğŸ æäº¤ç¤¼å“å¡ä¿¡æ¯:', {
      taskId: waitingGiftCardTask.value.id,
      giftCard: taskGiftCardForm.value
    })

    // å‘é€ç¤¼å“å¡ä¿¡æ¯åˆ°åç«¯
    const response = await axios.post(`http://localhost:5001/api/tasks/${waitingGiftCardTask.value.id}/gift-card`, {
      code: taskGiftCardForm.value.code.toUpperCase(),
      note: taskGiftCardForm.value.note
    })

    if (response.data.success) {
      ElMessage.success('ç¤¼å“å¡ä¿¡æ¯å·²æäº¤ï¼Œä»»åŠ¡ç»§ç»­æ‰§è¡Œ')

      // æ›´æ–°ä»»åŠ¡çŠ¶æ€
      const task = tasks.value.find(t => t.id === waitingGiftCardTask.value.id)
      if (task) {
        task.status = 'running'
        task.current_step = 'stage_4_gift_card'
      }

      // å…³é—­å¯¹è¯æ¡†
      cancelGiftCardInput()
    } else {
      ElMessage.error(response.data.message || 'æäº¤å¤±è´¥')
    }
  } catch (error) {
    console.error('âŒ æäº¤ç¤¼å“å¡ä¿¡æ¯å¤±è´¥:', error)
    ElMessage.error('æäº¤å¤±è´¥: ' + (error.response?.data?.message || error.message))
  }
}

// ğŸš€ æ™ºèƒ½è½®è¯¢ - é«˜é¢‘è½®è¯¢æ´»è·ƒä»»åŠ¡
const startSmartPolling = () => {
  if (smartPollingTimer) {
    clearInterval(smartPollingTimer)
  }

  if (fullPollingTimer) {
    clearInterval(fullPollingTimer)
  }

  // ğŸš€ é«˜é¢‘è½®è¯¢æ´»è·ƒä»»åŠ¡
  smartPollingTimer = setInterval(async () => {
    try {
      const response = await axios.get('http://localhost:5001/api/tasks/active')
      const activeTasks = response.data || []

      console.log(`ğŸ”„ æ™ºèƒ½è½®è¯¢: æ£€æŸ¥ ${activeTasks.length} ä¸ªæ´»è·ƒä»»åŠ¡`)

      if (activeTasks.length > 0) {
        updateActiveTasksLocally(activeTasks)
        lastUpdateTime.value = Date.now()
        isRealTimeActive.value = true
      } else {
        console.log('ğŸ“‹ æ— æ´»è·ƒä»»åŠ¡ï¼Œç»§ç»­ç›‘æ§')
        isRealTimeActive.value = false
      }
    } catch (error) {
      console.warn('âŒ æ™ºèƒ½è½®è¯¢å¤±è´¥:', error.message)
      isRealTimeActive.value = false
    }
  }, SMART_POLLING_INTERVAL)

  // ğŸš€ ä½é¢‘å…¨é‡è½®è¯¢ - ç¡®ä¿ä»»åŠ¡ä¸ä¸¢å¤±
  fullPollingTimer = setInterval(async () => {
    try {
      console.log('ğŸ”„ å…¨é‡è½®è¯¢: æ£€æŸ¥æ‰€æœ‰ä»»åŠ¡çŠ¶æ€')
      const response = await axios.get('http://localhost:5001/api/tasks')
      if (response.data && response.data.tasks) {
        updateTasksSelectively(response.data.tasks)
      }
    } catch (error) {
      console.error('âŒ å…¨é‡è½®è¯¢å¤±è´¥:', error)
    }
  }, FULL_POLLING_INTERVAL)
}

const stopSmartPolling = () => {
  if (smartPollingTimer) {
    clearInterval(smartPollingTimer)
    smartPollingTimer = null
  }
  if (fullPollingTimer) {
    clearInterval(fullPollingTimer)
    fullPollingTimer = null
  }
  isRealTimeActive.value = false
}

// ğŸš€ é€‰æ‹©æ€§æ›´æ–°ä»»åŠ¡ - åªæ›´æ–°å˜åŒ–çš„ä»»åŠ¡ï¼Œä¸æ›¿æ¢æ•´ä¸ªåˆ—è¡¨
const updateTasksSelectively = (newTasks) => {
  try {
    let updatedCount = 0
    let addedCount = 0

    // æ›´æ–°ç°æœ‰ä»»åŠ¡æˆ–æ·»åŠ æ–°ä»»åŠ¡
    newTasks.forEach(newTask => {
      const existingIndex = tasks.value.findIndex(t => t.id === newTask.id)

      if (existingIndex >= 0) {
        // æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        const existing = tasks.value[existingIndex]
        const hasChanges =
          existing.status !== newTask.status ||
          existing.progress !== newTask.progress ||
          existing.current_step !== newTask.current_step ||
          (newTask.logs && newTask.logs.length !== (existing.logs?.length || 0))

        if (hasChanges) {
          // ä¿æŒå“åº”å¼æ›´æ–°
          Object.assign(existing, newTask)
          existing.last_updated = new Date().toISOString()
          updatedCount++

          // æ›´æ–°å½“å‰æŸ¥çœ‹çš„ä»»åŠ¡è¯¦æƒ…
          if (selectedTask.value && selectedTask.value.id === newTask.id) {
            selectedTask.value = { ...existing }
          }
        }
      } else {
        // æ–°ä»»åŠ¡ï¼Œæ·»åŠ åˆ°åˆ—è¡¨
        tasks.value.push(newTask)
        addedCount++
      }
    })

    if (updatedCount > 0 || addedCount > 0) {
      console.log(`âœ… é€‰æ‹©æ€§æ›´æ–°å®Œæˆ: æ›´æ–°${updatedCount}ä¸ªï¼Œæ–°å¢${addedCount}ä¸ªä»»åŠ¡`)
    }
  } catch (error) {
    console.error('âŒ é€‰æ‹©æ€§æ›´æ–°ä»»åŠ¡å¤±è´¥:', error)
  }
}

// ğŸš€ ä»APIè·å–å¹¶æ›´æ–°æ´»è·ƒä»»åŠ¡çŠ¶æ€
const updateActiveTasksFromAPI = async () => {
  try {
    console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°æ´»è·ƒä»»åŠ¡çŠ¶æ€...')
    const response = await axios.get('http://localhost:5001/api/tasks/active')
    if (response.data && Array.isArray(response.data)) {
      updateActiveTasksLocally(response.data)
      console.log(`âœ… å·²åˆ·æ–° ${response.data.length} ä¸ªæ´»è·ƒä»»åŠ¡çŠ¶æ€`)
    }
  } catch (error) {
    console.error('âŒ åˆ·æ–°æ´»è·ƒä»»åŠ¡çŠ¶æ€å¤±è´¥:', error)
  }
}

// ğŸš€ åªæ›´æ–°æ´»è·ƒä»»åŠ¡çš„çŠ¶æ€
const updateActiveTasksLocally = (activeTasks) => {
  try {
    activeTasks.forEach(activeTask => {
      const localTask = tasks.value.find(t => t.id === activeTask.id)
      if (localTask) {
        // æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        const hasChanges =
          localTask.status !== activeTask.status ||
          localTask.progress !== activeTask.progress ||
          localTask.current_step !== activeTask.current_step ||
          (activeTask.logs && activeTask.logs.length !== (localTask.logs?.length || 0))

        if (hasChanges) {
          // æ›´æ–°çŠ¶æ€
          if (activeTask.status) localTask.status = activeTask.status
          if (activeTask.progress !== undefined) localTask.progress = activeTask.progress
          if (activeTask.current_step) localTask.current_step = activeTask.current_step

          // æ›´æ–°æ—¥å¿—ï¼ˆåªè¿½åŠ æ–°æ—¥å¿—ï¼‰
          if (activeTask.logs && Array.isArray(activeTask.logs)) {
            const currentLogCount = localTask.logs?.length || 0
            if (activeTask.logs.length > currentLogCount) {
              const newLogs = activeTask.logs.slice(currentLogCount)
              if (!localTask.logs) localTask.logs = []
              localTask.logs.push(...newLogs)
              console.log(`ğŸ“ è¿½åŠ  ${newLogs.length} æ¡æ–°æ—¥å¿—åˆ°ä»»åŠ¡ ${localTask.id}`)
            }
          }

          localTask.last_updated = new Date().toISOString()

          // æ›´æ–°å½“å‰æŸ¥çœ‹çš„ä»»åŠ¡è¯¦æƒ…
          if (selectedTask.value && selectedTask.value.id === activeTask.id) {
            selectedTask.value = { ...localTask }
          }

          console.log(`ğŸ”„ æ´»è·ƒä»»åŠ¡å·²æ›´æ–°: ${activeTask.id} -> ${activeTask.status}`)
        }
      }
    })
  } catch (error) {
    console.error('æ›´æ–°æ´»è·ƒä»»åŠ¡å¤±è´¥:', error)
  }
}

// ğŸš€ å¯åŠ¨å®æ—¶ç›‘æ§ç³»ç»Ÿ
const startRealTimeMonitoring = () => {
  console.log('ğŸš€ å®æ—¶ç›‘æ§ç³»ç»Ÿå¯åŠ¨')

  // æ£€æŸ¥å®æ—¶ç›‘æ§çŠ¶æ€
  setInterval(() => {
    const now = Date.now()
    const timeSinceLastUpdate = now - lastUpdateTime.value

    // å¦‚æœè¶…è¿‡30ç§’æ²¡æœ‰æ›´æ–°ï¼Œæ˜¾ç¤ºè­¦å‘Š
    if (timeSinceLastUpdate > 30000 && getActiveTasks().length > 0) {
      console.warn('âš ï¸ å®æ—¶ç›‘æ§å¯èƒ½å¼‚å¸¸ï¼Œè¶…è¿‡30ç§’æ— æ›´æ–°')
      isRealTimeActive.value = false
    } else if (timeSinceLastUpdate < 10000) {
      isRealTimeActive.value = true
    }
  }, 5000)

  console.log('âœ… å®æ—¶ç›‘æ§æ£€æŸ¥å™¨å·²å¯åŠ¨')
}

// ğŸš€ ä¼˜åŒ–çš„æ‰‹åŠ¨åˆ·æ–°æ–¹æ³• - åªåœ¨å¿…è¦æ—¶åˆ·æ–°
const manualRefresh = async () => {
  if (isRefreshing.value) return

  isRefreshing.value = true
  try {
    console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°æ•°æ®...')

    // æ™ºèƒ½åˆ·æ–°ï¼šåªåˆ·æ–°å½“å‰é¡µé¢ç›¸å…³çš„æ•°æ®
    const refreshPromises = []

    if (currentProduct.value === 'accounts' || currentProduct.value === 'iphone') {
      refreshPromises.push(refreshTasks())
    }

    if (currentProduct.value === 'accounts') {
      refreshPromises.push(refreshAccounts())
    }

    if (currentProduct.value === 'gift-cards') {
      refreshPromises.push(refreshGiftCards())
    }

    // å¦‚æœæ²¡æœ‰ç‰¹å®šé¡µé¢ï¼Œåˆ™åˆ·æ–°ä»»åŠ¡ï¼ˆé»˜è®¤é¡µé¢ï¼‰
    if (refreshPromises.length === 0) {
      refreshPromises.push(refreshTasks())
    }

    await Promise.all(refreshPromises)
    ElMessage.success('æ•°æ®åˆ·æ–°å®Œæˆ')
  } catch (error) {
    console.error('æ‰‹åŠ¨åˆ·æ–°å¤±è´¥:', error)
    ElMessage.error('åˆ·æ–°å¤±è´¥')
  } finally {
    isRefreshing.value = false
  }
}

// ==================== ğŸš€ SOTAå®æ—¶åŒæ­¥äº‹ä»¶å¤„ç†æ–¹æ³• ====================

const handleTaskStatusUpdate = (data) => {
  try {
    if (!data || !data.task_id) return

    const task = tasks.value.find(t => t && t.id === data.task_id)
    if (task) {
      // ç›´æ¥æ›´æ–°ï¼Œä½†åªåœ¨çœŸæ­£æ”¹å˜æ—¶æ›´æ–°
      let hasChanges = false

      if (data.status && task.status !== data.status) {
        task.status = data.status
        hasChanges = true
      }

      if (data.progress !== undefined && task.progress !== data.progress) {
        task.progress = data.progress
        hasChanges = true
      }

      if (data.message && task.current_step !== data.message) {
        task.current_step = data.message
        hasChanges = true
      }

      if (hasChanges) {
        task.last_updated = new Date().toISOString()

        // å¦‚æœæ˜¯å½“å‰æŸ¥çœ‹çš„ä»»åŠ¡ï¼Œä¹Ÿæ›´æ–°è¯¦æƒ…
        if (selectedTask.value && selectedTask.value.id === data.task_id) {
          selectedTask.value = { ...task }
        }

        console.log(`ğŸ”„ ä»»åŠ¡çŠ¶æ€å·²æ›´æ–°: ${data.task_id} -> ${data.status || task.status}`)
      }
    }
  } catch (error) {
    console.error('å¤„ç†ä»»åŠ¡çŠ¶æ€æ›´æ–°é”™è¯¯:', error)
  }
}



const handleStepUpdate = (data) => {
  try {
    console.log('ğŸ” handleStepUpdate å¼€å§‹å¤„ç†:', data)

    if (!data || !data.task_id) {
      console.warn('âš ï¸ æ­¥éª¤æ›´æ–°æ•°æ®æ— æ•ˆ:', data)
      return
    }

    const task = tasks.value.find(t => t && t.id === data.task_id)
    console.log('ğŸ” æ‰¾åˆ°ä»»åŠ¡:', task ? `${task.id.substring(0, 8)} (${task.status})` : 'æœªæ‰¾åˆ°')

    if (task) {
      let hasChanges = false
      console.log('ğŸ” å½“å‰ä»»åŠ¡çŠ¶æ€:', {
        current_step: task.current_step,
        progress: task.progress,
        status: task.status
      })
      console.log('ğŸ” æ–°çš„æ›´æ–°æ•°æ®:', {
        step: data.step,
        progress: data.progress,
        status: data.status
      })

      if (data.step && task.current_step !== data.step) {
        console.log(`ğŸ”„ æ›´æ–°æ­¥éª¤: ${task.current_step} -> ${data.step}`)
        task.current_step = data.step
        hasChanges = true
      }

      if (data.progress !== undefined && task.progress !== data.progress) {
        console.log(`ğŸ”„ æ›´æ–°è¿›åº¦: ${task.progress} -> ${data.progress}`)
        task.progress = data.progress
        hasChanges = true
      }

      if (data.status && task.status !== data.status) {
        console.log(`ğŸ”„ æ›´æ–°çŠ¶æ€: ${task.status} -> ${data.status}`)
        task.status = data.status
        hasChanges = true
      }

      if (hasChanges) {
        task.last_updated = new Date().toISOString()

        // å¦‚æœæ˜¯å½“å‰æŸ¥çœ‹çš„ä»»åŠ¡ï¼Œä¹Ÿæ›´æ–°è¯¦æƒ…
        if (selectedTask.value && selectedTask.value.id === data.task_id) {
          selectedTask.value = { ...task }
          console.log('ğŸ”„ å·²æ›´æ–°é€‰ä¸­ä»»åŠ¡è¯¦æƒ…')
        }

        console.log(`âœ… æ­¥éª¤å·²æ›´æ–°: ${data.task_id.substring(0, 8)} -> ${data.step || task.current_step} (è¿›åº¦: ${task.progress}%)`)
      } else {
        console.log('â„¹ï¸ æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°')
      }
    } else {
      console.warn('âš ï¸ æœªæ‰¾åˆ°å¯¹åº”ä»»åŠ¡:', data.task_id)
    }
  } catch (error) {
    console.error('âŒ å¤„ç†æ­¥éª¤æ›´æ–°é”™è¯¯:', error)
  }
}

const handleTaskLog = (data) => {
  try {
    if (!data || !data.task_id || !data.message) return

    const task = tasks.value.find(t => t && t.id === data.task_id)
    if (task) {
      // ç¡®ä¿æ—¥å¿—æ•°ç»„å­˜åœ¨
      if (!task.logs) {
        task.logs = []
      }

      // æ·»åŠ æ–°æ—¥å¿—
      const logEntry = {
        level: data.level || 'info',
        message: data.message,
        timestamp: data.timestamp || new Date().toISOString()
      }
      task.logs.push(logEntry)

      // é™åˆ¶æ—¥å¿—æ•°é‡ï¼Œé¿å…å†…å­˜æº¢å‡º
      if (task.logs.length > 1000) {
        task.logs = task.logs.slice(-500)
      }

      // æ›´æ–°æ—¶é—´æˆ³
      task.last_updated = new Date().toISOString()
      lastUpdateTime.value = Date.now() // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´

      // å¦‚æœæ˜¯å½“å‰æŸ¥çœ‹çš„ä»»åŠ¡ï¼Œä¹Ÿæ›´æ–°è¯¦æƒ…
      if (selectedTask.value && selectedTask.value.id === data.task_id) {
        selectedTask.value = { ...task }

        // ğŸš€ å®æ—¶æ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—
        if (autoScrollLogs.value && logContainer.value) {
          // ä½¿ç”¨nextTickç¡®ä¿DOMå·²æ›´æ–°
          nextTick(() => {
            const container = logContainer.value?.querySelector('.log-entries')
            if (container) {
              container.scrollTop = container.scrollHeight
            }
          })
        }
      }

      console.log(`ğŸ“ å®æ—¶æ—¥å¿—å·²è¿½åŠ : ${data.task_id} -> [${data.level}] ${data.message}`)
    }
  } catch (error) {
    console.error('å¤„ç†ä»»åŠ¡æ—¥å¿—é”™è¯¯:', error)
  }
}

const handleGiftCardInputRequired = (data) => {
  try {
    console.log('ğŸ å¤„ç†ç¤¼å“å¡è¾“å…¥è¯·æ±‚:', data)
    if (!data || !data.task_id) {
      console.warn('âš ï¸ æ— æ•ˆçš„ç¤¼å“å¡è¾“å…¥è¯·æ±‚æ•°æ®')
      return
    }

    const task = tasks.value.find(t => t && t.id === data.task_id)
    if (task) {
      // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºç­‰å¾…ç¤¼å“å¡è¾“å…¥
      task.status = 'waiting_gift_card_input'
      task.current_step = 'waiting_gift_card_input'

      // æ˜¾ç¤ºç¤¼å“å¡è¾“å…¥æç¤ºï¼ˆä¸è‡ªåŠ¨æ‰“å¼€å¯¹è¯æ¡†ï¼‰
      ElMessage({
        type: 'info',
        message: `ä»»åŠ¡ "${task.config?.name}" å·²åˆ°è¾¾ç¤¼å“å¡è¾“å…¥é˜¶æ®µï¼Œè¯·åœ¨æ“ä½œæ ç‚¹å‡»"å¡«å†™å¡å·"æŒ‰é’®`,
        duration: 3000,
        showClose: true
      })

      console.log(`âœ… ç¤¼å“å¡è¾“å…¥è¯·æ±‚å·²å¤„ç†: ${data.task_id}`)
    } else {
      console.warn(`âš ï¸ æœªæ‰¾åˆ°ä»»åŠ¡: ${data.task_id}`)
    }
  } catch (error) {
    console.error('å¤„ç†ç¤¼å“å¡è¾“å…¥è¯·æ±‚é”™è¯¯:', error)
  }
}

// ğŸ æ£€æŸ¥æ˜¯å¦æœ‰ç­‰å¾…ç¤¼å“å¡è¾“å…¥çš„ä»»åŠ¡
const checkForWaitingGiftCardTasks = () => {
  try {
    console.log('ğŸ æ£€æŸ¥ç­‰å¾…ç¤¼å“å¡è¾“å…¥çš„ä»»åŠ¡...')
    const waitingTasks = tasks.value.filter(task =>
      task && task.status === 'waiting_gift_card_input'
    )

    if (waitingTasks.length > 0) {
      console.log(`ğŸ å‘ç° ${waitingTasks.length} ä¸ªç­‰å¾…ç¤¼å“å¡è¾“å…¥çš„ä»»åŠ¡`)

      // åªæ˜¾ç¤ºæç¤ºæ¶ˆæ¯ï¼Œä¸è‡ªåŠ¨æ‰“å¼€å¯¹è¯æ¡†
      ElMessage({
        type: 'info',
        message: `å‘ç° ${waitingTasks.length} ä¸ªä»»åŠ¡ç­‰å¾…è¾“å…¥ç¤¼å“å¡ï¼Œè¯·åœ¨"æ‰€æœ‰ä»»åŠ¡"é¡µç­¾çš„æ“ä½œæ ç‚¹å‡»"å¡«å†™å¡å·"æŒ‰é’®`,
        duration: 5000,
        showClose: true
      })
    } else {
      console.log('ğŸ æ²¡æœ‰ç­‰å¾…ç¤¼å“å¡è¾“å…¥çš„ä»»åŠ¡')
    }
  } catch (error) {
    console.error('æ£€æŸ¥ç­‰å¾…ç¤¼å“å¡è¾“å…¥ä»»åŠ¡é”™è¯¯:', error)
  }
}

const createTask = async () => {
  try {
    console.log('ğŸš€ å¼€å§‹åˆ›å»ºä»»åŠ¡...')
    console.log('ğŸ“ å½“å‰è¡¨å•çŠ¶æ€:', {
      name: taskForm.name,
      selectedAccount: taskForm.selectedAccount,
      selectedModel: taskForm.selectedModel,
      selectedSize: taskForm.selectedSize,
      selectedStorage: taskForm.selectedStorage,
      selectedColor: taskForm.selectedColor,
      url: taskForm.url,
      generatedUrl: generatedUrl.value
    })

    console.log('ğŸ“± iPhoneé…ç½®çŠ¶æ€:', {
      modelsCount: Object.keys(iphoneConfigs.models).length,
      storageNamesCount: Object.keys(iphoneConfigs.storage_display_names).length,
      colorNamesCount: Object.keys(iphoneConfigs.color_display_names).length,
      models: iphoneConfigs.models,
      storageNames: iphoneConfigs.storage_display_names,
      colorNames: iphoneConfigs.color_display_names
    })

    // éªŒè¯è¡¨å•
    if (!taskForm.name || !taskForm.selectedAccount || !taskForm.selectedModel || !taskForm.selectedSize || !taskForm.selectedStorage || !taskForm.selectedColor) {
      ElMessage.error('è¯·å¡«å†™æ‰€æœ‰å¿…è¦ä¿¡æ¯ï¼ˆå‹å·ã€å°ºå¯¸ã€å­˜å‚¨ã€é¢œè‰²ï¼‰')
      console.error('âŒ è¡¨å•éªŒè¯å¤±è´¥ï¼Œç¼ºå°‘å¿…è¦å­—æ®µ')
      return
    }

    // è·å–æ˜¾ç¤ºåç§°
    const modelDisplayName = iphoneConfigs.models[taskForm.selectedModel]?.name || taskForm.selectedModel
    const sizeDisplayName = iphoneConfigs.models[taskForm.selectedModel]?.sizes[taskForm.selectedSize]?.name || taskForm.selectedSize
    const storageDisplayName = iphoneConfigs.storage_display_names[taskForm.selectedStorage] || taskForm.selectedStorage
    const colorDisplayName = iphoneConfigs.color_display_names[taskForm.selectedColor] || taskForm.selectedColor

    // è·å–é€‰ä¸­çš„è´¦å·ä¿¡æ¯
    const selectedAccount = accounts.value.find(acc => acc.id === taskForm.selectedAccount)
    if (!selectedAccount) {
      ElMessage.error('è¯·é€‰æ‹©Apple IDè´¦å·')
      return
    }

    // è°ƒè¯•ï¼šæ£€æŸ¥æ‰€æœ‰å­—æ®µå€¼
    console.log('ğŸ” è¡¨å•æ•°æ®æ£€æŸ¥:', {
      name: taskForm.name,
      url: generatedUrl.value || taskForm.url,
      selectedAccount: selectedAccount,
      selectedModel: taskForm.selectedModel,
      selectedSize: taskForm.selectedSize,
      selectedStorage: taskForm.selectedStorage,
      selectedColor: taskForm.selectedColor,
      modelDisplayName: modelDisplayName,
      sizeDisplayName: sizeDisplayName,
      storageDisplayName: storageDisplayName,
      colorDisplayName: colorDisplayName
    })

    // æŒ‰ç…§åŸç³»ç»Ÿæ ¼å¼æ„å»ºä»»åŠ¡æ•°æ®
    const taskData = {
      name: taskForm.name,
      url: generatedUrl.value || taskForm.url,
      account_config: {
        email: selectedAccount.email,
        password: selectedAccount.password,
        phone_number: selectedAccount.phone_number || '07700900000'
      },
      // ç¤¼å“å¡æ•°ç»„ä¸ºç©º - ç³»ç»Ÿå°†åœ¨è¿è¡Œæ—¶å¼¹å‡ºè¾“å…¥ç•Œé¢
      gift_cards: [],
      product_config: {
        model: sizeDisplayName, // ä½¿ç”¨å®Œæ•´çš„å°ºå¯¸åç§°ï¼ˆæŒ‰åŸç³»ç»Ÿé€»è¾‘ï¼‰
        storage: storageDisplayName,
        finish: colorDisplayName,
        trade_in: 'No trade-in',
        payment: 'Buy',
        apple_care: 'No AppleCare+ Coverage'
      },
      enabled: true,
      priority: taskForm.priority,
      use_proxy: false
    }

    console.log('ğŸ“¤ å‘é€ä»»åŠ¡æ•°æ® (WebSocket):', taskData)

    // ä½¿ç”¨WebSocketå‘é€ï¼Œè€Œä¸æ˜¯HTTP API
    if (socket.value && isConnected.value) {
      socket.value.emit('create_task', taskData)
      console.log('âœ… ä»»åŠ¡åˆ›å»ºè¯·æ±‚å·²é€šè¿‡WebSocketå‘é€')

      // è®¾ç½®è¶…æ—¶å¤„ç†
      setTimeout(() => {
        console.log('â° æ£€æŸ¥ä»»åŠ¡åˆ›å»ºæ˜¯å¦å®Œæˆ')
      }, 5000)
    } else {
      // å¦‚æœWebSocketæœªè¿æ¥ï¼Œå°è¯•HTTP APIä½œä¸ºé™çº§
      console.log('ï¿½ WebSocketæœªè¿æ¥ï¼Œå°è¯•HTTP API')
      const response = await axios.post('http://localhost:5001/api/tasks', taskData)
      console.log('âœ… ä»»åŠ¡åˆ›å»ºå“åº” (HTTP):', response.data)
    }

    // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼Œå› ä¸ºWebSocketäº‹ä»¶ä¼šå¤„ç†
    // ElMessage.success('ä»»åŠ¡åˆ›å»ºæˆåŠŸ')
    showCreateDialog.value = false

    // é‡ç½®è¡¨å•
    Object.assign(taskForm, {
      name: '',
      url: '',
      selectedAccount: null,
      selectedGiftCards: [],
      selectedModel: '',
      selectedSize: '',
      selectedStorage: '',
      selectedColor: '',
      priority: 2,
      product: 'iphone'
    })
    generatedUrl.value = ''

    console.log('â³ ç­‰å¾…WebSocketäº‹ä»¶æ·»åŠ ä»»åŠ¡åˆ°åˆ—è¡¨...')

    // å¦‚æœWebSocketæ²¡æœ‰è¿æ¥ï¼Œåˆ™æ‰‹åŠ¨æ·»åŠ ä»»åŠ¡
    if (!isConnected.value) {
      console.log('ï¿½ WebSocketæœªè¿æ¥ï¼Œæ‰‹åŠ¨æ·»åŠ ä»»åŠ¡åˆ°åˆ—è¡¨')
      const newTask = response.data
      if (newTask && newTask.id) {
        const existingIndex = tasks.value.findIndex(t => t.id === newTask.id)
        if (existingIndex === -1) {
          tasks.value.push(newTask)
          ElMessage.success(`ä»»åŠ¡åˆ›å»ºæˆåŠŸ: ${newTask.config?.name}`)
        }
      }
    }
  } catch (error) {
    console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', error)
    ElMessage.error('åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + (error.response?.data?.message || error.message))
  }
}

// ğŸš€ é¡µç­¾å’Œåˆ†é¡µç›¸å…³æ–¹æ³•
const handleTabClick = (tab) => {
  console.log('ğŸ”„ åˆ‡æ¢é¡µç­¾:', tab.name)
  // WebSocketå®æ—¶åŒæ­¥ï¼Œæ— éœ€åˆ‡æ¢é¡µç­¾æ—¶åˆ·æ–°
}

const handleSizeChange = (size) => {
  pageSize.value = size
  currentPage.value = 1
}

const handleCurrentChange = (page) => {
  currentPage.value = page
}

const getProgressStatus = (status) => {
  switch (status) {
    case 'completed':
      return 'success'
    case 'failed':
      return 'exception'
    case 'running':
      return undefined // é»˜è®¤è“è‰²
    default:
      return undefined
  }
}

// ğŸš€ æ›´æ–°ä»»åŠ¡ç»Ÿè®¡
const updateTaskStats = () => {
  const stats = taskStatsComputed.value
  Object.assign(taskStats.value, stats)
}

// ğŸš€ ç›‘å¬ä»»åŠ¡å˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°ç»Ÿè®¡
watch(tasks, () => {
  updateTaskStats()
}, { deep: true })

// ğŸš€ é¡µç­¾åˆ‡æ¢æ–¹æ³•
const switchTab = (tabKey) => {
  console.log('ğŸ”„ åˆ‡æ¢é¡µç­¾:', tabKey)
  // è¿™é‡Œå¯ä»¥æ·»åŠ é¡µç­¾åˆ‡æ¢çš„é€»è¾‘
}

// æ–¹æ³•
const switchProduct = (productKey) => {
  console.log('ğŸ”„ åˆ‡æ¢äº§å“é¡µé¢:', productKey)
  console.log('ğŸ”„ å½“å‰äº§å“ (åˆ‡æ¢å‰):', currentProduct.value)

  // å¼ºåˆ¶æ›´æ–° currentProduct
  currentProduct.value = productKey

  console.log('ğŸ”„ å½“å‰äº§å“ (åˆ‡æ¢å):', currentProduct.value)

  // æ ¹æ®é¡µé¢ç±»å‹æ˜¾ç¤ºä¸åŒæ¶ˆæ¯
  const productMap = {
    'iphone': 'iPhone',
    'mac': 'Mac',
    'ipad': 'iPad',
    'watch': 'Apple Watch',
    'all-tasks': 'æ‰€æœ‰ä»»åŠ¡',
    'accounts': 'è´¦å·ç®¡ç†',
    'gift-cards': 'ç¤¼å“å¡ç®¡ç†',
    'ip-pool': 'IPæ± ç®¡ç†'
  }

  // ğŸš€ ä¼˜åŒ–ï¼šåªåœ¨çœŸæ­£éœ€è¦æ—¶æ‰åŠ è½½æ•°æ®ï¼Œé¿å…é¢‘ç¹åˆ·æ–°
  if (productKey === 'accounts' && accounts.value.length === 0) {
    console.log('ğŸ“¡ è´¦å·é¡µé¢æ•°æ®ä¸ºç©ºï¼ŒåŠ è½½æ•°æ®...')
    refreshAccounts()
  } else if (productKey === 'gift-cards' && giftCards.value.length === 0) {
    console.log('ğŸ“¡ ç¤¼å“å¡é¡µé¢æ•°æ®ä¸ºç©ºï¼ŒåŠ è½½æ•°æ®...')
    refreshGiftCards()
  } else {
    console.log('ğŸ“‹ æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡åŠ è½½')
  }

  ElMessage.success(`å·²åˆ‡æ¢åˆ° ${productMap[productKey]} é¡µé¢`)

  // å¼ºåˆ¶é‡æ–°æ¸²æŸ“ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
  console.log('âœ… é¡µé¢åˆ‡æ¢å®Œæˆï¼Œå½“å‰é¡µé¢:', productKey)
}

// ç”Ÿå‘½å‘¨æœŸé’©å­
onMounted(() => {
  console.log('ğŸš€ åº”ç”¨å¯åŠ¨ä¸­...')

  // åˆå§‹åŒ–ç©ºçš„æ•°æ®åˆ—è¡¨
  tasks.value = []
  accounts.value = []
  giftCards.value = []

  initWebSocket()

  // åŠ è½½çœŸå®æ•°æ®
  console.log('ğŸ“¡ å¼€å§‹åŠ è½½åç«¯æ•°æ®...')
  refreshAccounts()
  refreshGiftCards()

  // åŠ è½½iPhoneé…ç½®
  console.log('ğŸ“± åŠ è½½iPhoneé…ç½®...')
  loadIphoneConfigs()

  // ä»»åŠ¡åˆ—è¡¨å°†åœ¨WebSocketè¿æ¥æˆåŠŸæ—¶åŠ è½½

  // ğŸš€ å¯åŠ¨å®æ—¶ç›‘æ§æ£€æŸ¥
  console.log('ğŸ”„ å¯åŠ¨å®æ—¶ç›‘æ§ç³»ç»Ÿ')
  startRealTimeMonitoring()
})

onUnmounted(() => {
  if (socket.value) {
    socket.value.disconnect()
  }

  // ğŸš€ æ¸…ç†æ™ºèƒ½è½®è¯¢
  stopSmartPolling()

  if (heartbeatTimer) {
    clearInterval(heartbeatTimer)
  }
})
</script>

<style scoped>
.header {
  background: #fff;
  border-bottom: 1px solid #e4e7ed;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 20px;
}

.header-left h2 {
  margin: 0;
  color: #2c3e50;
  font-weight: 600;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 15px;
}

.sidebar {
  background: #fff;
  border-right: 1px solid #e4e7ed;
}

.menu {
  border: none;
  height: 100%;
}

.main-content {
  background: #f5f7fa;
  padding: 20px;
}

.product-section {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e4e7ed;
}

.section-header h2 {
  margin: 0;
  color: #2c3e50;
  font-weight: 600;
  font-size: 24px;
}

.header-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.status-indicators {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-right: 15px;
}

.stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  text-align: center;
}

.stat-content {
  padding: 10px;
}

.stat-number {
  font-size: 32px;
  font-weight: bold;
  color: #409eff;
  margin-bottom: 5px;
}

.stat-label {
  color: #666;
  font-size: 14px;
}

.tasks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.task-card {
  border-radius: 8px;
  transition: transform 0.2s;
}

.task-card:hover {
  transform: translateY(-2px);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.task-name {
  font-weight: 600;
  color: #2c3e50;
}

.task-details p {
  margin: 8px 0;
  color: #666;
  font-size: 14px;
}

.task-actions {
  display: flex;
  gap: 8px;
  margin-top: 15px;
  flex-wrap: wrap;
}

.current-step {
  margin: 10px 0;
  padding: 8px;
  background: #f0f9ff;
  border-radius: 4px;
  border-left: 3px solid #409eff;
}

.latest-log {
  margin: 10px 0;
  padding: 8px;
  background: #f9f9f9;
  border-radius: 4px;
  border-left: 3px solid #909399;
}

.log-text {
  margin: 0;
  font-size: 12px;
  color: #666;
  line-height: 1.4;
}

/* ä»»åŠ¡è¯¦æƒ…å¯¹è¯æ¡†æ ·å¼ */
.log-container {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #e4e7ed;
  border-radius: 4px;
  background: #fafafa;
}

.log-entries {
  padding: 10px;
}

.log-entry {
  display: flex;
  margin-bottom: 8px;
  padding: 6px 8px;
  border-radius: 4px;
  font-size: 12px;
  line-height: 1.4;
}

.log-entry.info {
  background: #f0f9ff;
  border-left: 3px solid #409eff;
}

.log-entry.success {
  background: #f0f9f0;
  border-left: 3px solid #67c23a;
}

.log-entry.warning {
  background: #fdf6ec;
  border-left: 3px solid #e6a23c;
}

.log-entry.error {
  background: #fef0f0;
  border-left: 3px solid #f56c6c;
}

.log-time {
  color: #909399;
  margin-right: 10px;
  white-space: nowrap;
  min-width: 120px;
}

.log-message {
  color: #303133;
  flex: 1;
  word-break: break-word;
}

.no-logs {
  padding: 20px;
  text-align: center;
  color: #909399;
  font-style: italic;
}

/* ğŸš€ SOTAå®æ—¶åŒæ­¥æ ·å¼ */
.gift-card-waiting {
  margin: 10px 0;
}

.log-time {
  margin: 0;
  font-size: 10px;
  color: #909399;
  text-align: right;
}

.log-error {
  color: #f56c6c;
}

.log-warning {
  color: #e6a23c;
}

.log-success {
  color: #67c23a;
}

.log-info {
  color: #409eff;
}

/* å®æ—¶æ›´æ–°åŠ¨ç”» */
.task-card {
  transition: all 0.3s ease;
}

.task-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* ç§»é™¤è¿‡åº¦çš„åŠ¨ç”»æ•ˆæœï¼Œä¿æŒç•Œé¢ç¨³å®š */
.current-step {
  background-color: #f0f9ff;
  transition: background-color 0.3s ease;
}

/* ğŸš€ SOTAå®æ—¶åŒæ­¥çŠ¶æ€æ ·å¼ */
.sync-status {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  background: linear-gradient(45deg, #67c23a, #85ce61);
  border-radius: 12px;
  color: white;
  font-size: 12px;
  font-weight: 500;
}

.sync-indicator {
  animation: spin 3s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.sync-text {
  white-space: nowrap;
}

.polling-status {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  background: linear-gradient(45deg, #409eff, #66b1ff);
  border-radius: 12px;
  color: white;
  font-size: 12px;
  font-weight: 500;
}

.polling-indicator {
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

.polling-text {
  white-space: nowrap;
}

.active-tasks {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  background: linear-gradient(45deg, #e6a23c, #f7ba2a);
  border-radius: 12px;
  color: white;
  font-size: 12px;
  font-weight: 500;
}

.active-indicator {
  animation: flash 1s ease-in-out infinite alternate;
}

@keyframes flash {
  from { opacity: 1; }
  to { opacity: 0.5; }
}

.active-text {
  white-space: nowrap;
}

/* ğŸš€ ä»»åŠ¡åˆ—è¡¨é¡µç­¾æ ·å¼ */
.task-tabs {
  margin-top: 20px;
}

.task-list-content {
  padding: 20px 0;
}

.search-filter-bar {
  margin-bottom: 20px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 8px;
}

.filter-info {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.task-name-cell {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.task-name {
  font-weight: 500;
  color: #303133;
}

.task-id {
  font-family: monospace;
  font-size: 11px;
  background: #f0f0f0;
  color: #666;
}

.text-muted {
  color: #909399;
}

.task-row {
  cursor: pointer;
}

.task-row:hover {
  background-color: #f5f7fa;
}

.pagination-wrapper {
  margin-top: 20px;
  display: flex;
  justify-content: center;
}

/* çŠ¶æ€æ ‡ç­¾é¢œè‰² */
.el-tag.el-tag--pending {
  background-color: #f4f4f5;
  color: #909399;
  border-color: #e4e7ed;
}

.el-tag.el-tag--running {
  background-color: #ecf5ff;
  color: #409eff;
  border-color: #b3d8ff;
}

.el-tag.el-tag--completed {
  background-color: #f0f9ff;
  color: #67c23a;
  border-color: #c2e7b0;
}

.el-tag.el-tag--failed {
  background-color: #fef0f0;
  color: #f56c6c;
  border-color: #fbc4c4;
}

.el-tag.el-tag--cancelled {
  background-color: #fdf6ec;
  color: #e6a23c;
  border-color: #f5dab1;
}

/* è¿›åº¦æ¡æ ·å¼ */
.el-progress--line {
  margin-bottom: 0;
}

.el-progress-bar__outer {
  border-radius: 4px;
}

.el-progress-bar__inner {
  border-radius: 4px;
}

/* ğŸš€ æ‰€æœ‰ä»»åŠ¡é¡µç­¾æ ·å¼ */
.tasks-table {
  margin-top: 20px;
}

.progress-text {
  font-size: 12px;
  margin-left: 8px;
  color: #666;
}

.task-count {
  font-size: 12px;
  opacity: 0.8;
  margin-left: 4px;
}

/* ğŸ ç¤¼å“å¡è¾“å…¥è¡¨å•æ ·å¼ */
.gift-card-form {
  padding: 10px 0;
}

.form-help-text {
  margin-top: 4px;
}

.form-help-text small {
  color: #909399;
  font-size: 12px;
}
</style>
